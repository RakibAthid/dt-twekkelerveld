<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Twekkelerveld Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* --- GLOBAL THEME --- */
    :root {
      --bg-core: #020617;
      --bg-card: #0f172a;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --border: rgba(148, 163, 184, 0.2);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 60%);
      color: var(--text-main);
      overflow: hidden; 
    }

    body { display: flex; flex-direction: column; }

    /* --- HEADER --- */
    .app-header {
      flex: 0 0 auto;
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 24px;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }
    .brand h1 { margin: 0; font-size: 18px; font-weight: 600; color: #fff; }
    
    .nav-pills { display: flex; gap: 8px; }
    .nav-btn {
      background: transparent; border: 1px solid transparent; color: var(--text-muted);
      padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
      transition: all 0.2s;
    }
    .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-btn.active { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); color: var(--accent); }

    /* --- BODY LAYOUT --- */
    .app-body { flex: 1; position: relative; overflow: hidden; }
    .view-stack { height: 100%; width: 100%; position: relative; }
    .view-panel { display: none; width: 100%; height: 100%; flex-direction: column; }
    .view-panel.active { display: flex; animation: fadeUp 0.4s ease; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* For Ecology/Energy Iframes */
    .web-frame { flex: 1; border: none; background: #000; }
    .panel-iframe-wrapper { flex: 1; border-radius: 16px; overflow: hidden; background: #000; border: 1px solid rgba(51,65,85,0.8); margin: 10px; }
    .panel-iframe-wrapper iframe { width: 100%; height: 100%; border: none; display: block; }
    .panel-toolbar { display: flex; justify-content: space-between; align-items: center; margin: 10px 14px 4px; font-size: 11px; color: var(--text-muted); }
    .panel-toolbar .dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; margin-right: 6px; display: inline-block; }

    /* =========================================
       OVERVIEW TAB STYLES
       ========================================= */
    #panel-overview {
      overflow-y: auto; 
      padding: 40px;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
      align-items: center;
    }

    .hub-container {
      width: 100%; max-width: 1400px;
      display: flex; flex-direction: column; gap: 40px;
    }

    .hero-text { text-align: center; margin-bottom: 10px; }
    .hero-text h2 { font-size: 36px; font-weight: 700; margin: 0 0 10px 0; color: #fff; }
    .hero-text p { font-size: 16px; color: var(--text-muted); }

    .hero-actions { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .pill-btn {
      background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border);
      padding: 12px 24px; border-radius: 99px; color: #cbd5e1; cursor: pointer;
      font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    }
    .pill-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); transform: translateY(-2px); }

    .showcase-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: stretch;
    }

    .showcase-card {
      background: #0f172a; border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .card-top { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(30, 41, 59, 0.3); }
    .card-top h3 { margin: 0; font-size: 18px; color: #fff; font-weight: 600; }

    .card-media {
      width: 100%; height: 350px; background: #000;
      position: relative; border-bottom: 1px solid var(--border);
    }
    .card-media img {
      width: 100%; height: 100%; object-fit: contain; display: block;
    }

    .card-desc {
      padding: 25px; font-size: 14px; line-height: 1.6; color: #cbd5e1;
      background: rgba(15, 23, 42, 0.6); flex: 1;
    }
    .card-desc strong { color: #fff; display: block; margin-bottom: 8px; font-size: 15px; }

    @media(max-width: 1024px) {
      .showcase-grid { grid-template-columns: 1fr; }
      .card-media { height: 300px; }
    }

    /* === Redesigned Overview Section === */
    .overview-hero {
      position: relative;
      width: 100%;
      min-height: 380px;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
    }
    .overview-hero::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('heatmap.png');
      background-size: cover;
      background-position: center;
      opacity: 0.35;
      filter: brightness(0.8) saturate(1.2);
      animation: heroZoom 20s linear infinite alternate;
    }
    .overview-hero::after {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,0.03) 0,
        rgba(255,255,255,0.03) 2px,
        transparent 2px,
        transparent 4px
      );
      animation: scanLines 8s linear infinite;
    }
    @keyframes heroZoom {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }
    @keyframes scanLines {
      from { background-position: 0 0; }
      to { background-position: 0 40px; }
    }
    .overview-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
    }
    .overview-hero-content h2 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: #f1f5f9;
    }
    .overview-hero-content p {
      margin-top: 8px;
      font-size: 16px;
      color: var(--text-muted);
    }
    .micro-badges {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .micro-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(30, 41, 59, 0.75);
      border: 1px solid rgba(148,163,184,0.3);
      color: #e2e8f0;
    }
    .micro-badge i { font-size: 14px; color: var(--accent); }

    .metrics-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 14px;
      margin-top: 40px;
    }
    .metric-tile {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 14px 12px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 80px;
    }
    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .metric-value {
      font-size: 20px;
      font-weight: 600;
      color: #f8fafc;
    }

    .why-section {
      display: flex;
      flex-wrap: wrap;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px;
      overflow: hidden;
    }
    .why-map {
      flex: 1;
      min-width: 280px;
      position: relative;
    }
    .why-map img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .hotspot {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #fff;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    .hotspot:hover {
      transform: translate(-50%, -50%) scale(1.2);
    }
    .why-info {
      flex: 1;
      min-width: 280px;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .why-info h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .why-info ul {
      padding-left: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--text-muted);
      font-size: 14px;
    }
    .why-info li::marker {
      color: var(--accent);
    }

    .drawer {
      position: fixed;
      top: 0;
      right: -400px;
      width: 360px;
      height: 100%;
      background: rgba(2,6,23,0.98);
      border-left: 1px solid rgba(148,163,184,0.4);
      padding: 24px 20px;
      box-shadow: -10px 0 30px rgba(0,0,0,0.7);
      transition: right 0.35s ease;
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }
    .drawer.open { right: 0; }
    .drawer h4 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .drawer p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .drawer img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .drawer .drawer-close {
      align-self: flex-end;
      cursor: pointer;
      font-size: 20px;
      color: var(--accent);
    }
    .drawer .open-tab-btn {
      margin-top: auto;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .case-studies {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    /* Additional spacing for the simulation case study list */
    .case-studies.simulation-case-studies {
      margin-top: 16px;
    }
    .case-card {
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
    }
    .case-card:hover { transform: translateY(-3px); }
    .case-card h4 {
      margin: 0;
      font-size: 16px;
      color: #fff;
    }
    .case-card .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .case-card .tag {
      font-size: 10px;
      padding: 3px 6px;
      background: rgba(30,41,59,0.7);
      border-radius: 6px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .case-card .outcome-bar {
      margin-top: 6px;
      display: flex;
      gap: 4px;
    }
    .case-card .outcome-segment {
      flex: 1;
      height: 6px;
      border-radius: 3px;
    }
    .outcome-cool { background: #60a5fa; }
    .outcome-energy { background: #38bdf8; }
    .outcome-co2 { background: #4ade80; }
    .outcome-euro { background: #fbbf24; }

    .timeline-section {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .timeline-item {
      flex: 1;
      min-width: 180px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .timeline-item h5 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .timeline-item span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .presets-section {
      margin-top: 30px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .preset-btn {
      flex: 1;
      min-width: 200px;
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      font-weight: 500;
      color: #e2e8f0;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: var(--accent);
      color: #020617;
      transform: translateY(-2px);
    }

    .howto-section {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 14px;
      padding: 20px;
    }
    .howto-step {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .howto-step i {
      font-size: 24px;
      color: var(--accent);
    }
    .howto-step span {
      font-size: 14px;
      color: #e2e8f0;
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 550px;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /*
     * Button and layout styles for the case studies call‑to‑action and modal
     */
    .cases-call {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 20px 0;
    }
    .cases-call .cases-note {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      max-width: 600px;
    }
    .open-cases-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #0f172a;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    .open-cases-btn i {
      font-size: 16px;
    }
    /* Modal layout for case study list */
    .cases-modal {
      max-width: 800px;
    }
    .case-studies-modal {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .modal-content h4 {
      margin: 0;
      font-size: 20px;
      color: #fff;
    }
    .modal-content p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .modal-content .close-btn {
      align-self: flex-end;
      cursor: pointer;
      font-size: 20px;
      color: var(--accent);
    }
    .modal-content .steal-btn {
      margin-top: 10px;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(30,41,59,0.9);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 5000;
      font-size: 14px;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* =========================================
       INTERRELATION PANEL STYLES (ORIGINAL)
       ========================================= */
    #interrelation-panel {
      display: flex; flex-direction: column; height: 100%; padding: 12px 14px; box-sizing: border-box;
      font-family: "Inter", sans-serif; color: #e5e7eb;
    }
    #interrelation-panel * { box-sizing: border-box; }

    #interrelation-panel .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 2px 4px 0; }
    #interrelation-panel .top-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.95; }
    #interrelation-panel .top-title i { color: #22c55e; }
    #interrelation-panel .top-sub { font-size: 11px; color: #9ca3af; opacity: 0.9; }
    #interrelation-panel .top-actions { display: flex; gap: 8px; align-items: center; }

    #interrelation-panel .btn-reset {
      border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.7);
      color: #e5e7eb; font-size: 11px; padding: 5px 12px; border-radius: 999px;
      cursor: pointer; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    #interrelation-panel .btn-reset:hover { background: rgba(31,41,55,0.9); }

    #interrelation-panel .layout { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; min-height: 0; }

    #interrelation-panel .left-panel {
      background: rgba(15, 23, 42, 0.9); border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 14px 14px 10px; display: flex; flex-direction: column; gap: 10px; min-height: 0;
    }
    #interrelation-panel .panel-caption { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #9ca3af; margin-bottom: 2px; }

    #interrelation-panel .slider-row {
      background: rgba(15,23,42,0.95); border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 8px 10px 6px; display: flex; flex-direction: column; gap: 4px;
    }
    #interrelation-panel .slider-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    #interrelation-panel .slider-label { font-size: 12px; display: flex; align-items: center; gap: 6px; color: #e5e7eb; }
    #interrelation-panel .slider-label i { font-size: 13px; color: #a5b4fc; }
    #interrelation-panel .slider-value { font-size: 11px; color: #9ca3af; }

    #interrelation-panel input[type="range"] {
      -webkit-appearance: none; appearance: none; width: 100%; height: 5px; border-radius: 999px;
      background: rgba(75,85,99,0.45); outline: none; margin-top: 2px;
    }
    #interrelation-panel input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 999px;
      background: #ffffff; border: 1px solid #4b5563; cursor: pointer; box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
    }
    #interrelation-panel .slider-hint { font-size: 10px; color: #6b7280; margin-top: 2px; }

    #interrelation-panel .scenario-insights {
      margin-top: 4px; padding: 8px 9px; font-size: 11px; line-height: 1.5; border-radius: 8px;
      background: rgba(15,23,42,0.95); border: 1px dashed rgba(148,163,184,0.5); color: #d1d5db;
    }

    #interrelation-panel .right-panel {
      background: rgba(15, 23, 42, 0.9); border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 12px; display: flex; flex-direction: column; gap: 10px; min-height: 0; overflow-y: auto;
    }

    #interrelation-panel .baseline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 6px; }
    #interrelation-panel .baseline-card {
      background: rgba(15,23,42,0.95); border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 6px 8px; display: flex; flex-direction: column; gap: 2px;
    }
    #interrelation-panel .baseline-card .label { font-size: 9px; color: #9ca3af; line-height: 1.2; white-space: nowrap; }
    #interrelation-panel .baseline-card .value { font-size: 12px; font-weight: 600; color: #e5e7eb; line-height: 1.2; }

    /*
     * Make the interrelation chart grid responsive. The original layout used a fixed
     * 2×2 grid with a maximum height of 450px, which meant that additional charts
     * were pushed out of view when more than four were displayed. By using
     * auto‑fitting columns and letting the rows grow naturally, all charts remain
     * visible without manually scrolling. Overflow handling is provided by the
     * surrounding right panel.
     */
    #interrelation-panel .chart-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      overflow-y: auto;
    }
    #interrelation-panel .chart-card {
      background: rgba(15,23,42,0.95); border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 6px 8px; display: flex; flex-direction: column; min-height: 0;
    }
    #interrelation-panel .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    #interrelation-panel .chart-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.09em; color: #9ca3af; }
    #interrelation-panel .chart-tag { font-size: 10px; color: #6ee7b7; }
    #interrelation-panel .chart-wrap { flex: 1; min-height: 0; position: relative; }
    #interrelation-panel canvas { width: 100% !important; height: 100% !important; }

    /*
     * Additional styling for stakeholder benefit details. This section sits below
     * the stakeholder benefits chart and uses compact typography to convey
     * qualitative advantages for different groups. Strong tags are displayed
     * as headers and list items use small disc bullets.
     */
    .stakeholder-details {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
      line-height: 1.4;
    }
    .stakeholder-details strong {
      display: block;
      margin-top: 4px;
      color: #e5e7eb;
    }
    .stakeholder-details ul {
      padding-left: 16px;
      margin: 4px 0;
    }
    .stakeholder-details li {
      list-style-type: disc;
    }

    #interrelation-panel .summary {
      margin-top: 10px; padding: 8px 10px; background: rgba(15,23,42,0.95); border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35); display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 8px; font-size: 11px;
    }
    #interrelation-panel .summary-item { display: flex; flex-direction: column; gap: 2px; }
    #interrelation-panel .summary-label { color: #9ca3af; text-transform: uppercase; letter-spacing: 0.08em; }
    #interrelation-panel .summary-value { font-size: 13px; font-weight: 600; }
    #interrelation-panel .summary-value.positive { color: #4ade80; }
    #interrelation-panel .summary-value.negative { color: #f97373; }
    #interrelation-panel .summary-value.neutral { color: #e5e7eb; }

    #interrelation-panel.fullscreen { position: fixed; top: 10px; left: 10px; right: 10px; bottom: 10px; z-index: 10000; background: rgba(15,23,42,0.98); border-radius: 20px; border: 1px solid rgba(148, 163, 184, 0.5); box-shadow: 0 20px 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; }

    /* --- Mission control enhancements --- */
    .story-stepper {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .story-stepper .step {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: #e2e8f0;
      transition: background 0.2s, color 0.2s;
    }
    .story-stepper .step:hover, .story-stepper .step.active {
      background: var(--accent);
      color: #0f172a;
    }

    .resume-ribbon {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 8px 14px;
      margin-top: 16px;
      font-size: 13px;
      gap: 8px;
    }
    .resume-ribbon button {
      background: var(--accent);
      border: none;
      color: #0f172a;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .delta-chips {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .delta-chip {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 6px;
      background: rgba(30,41,59,0.7);
      color: #fff;
    }
    .delta-chip.cool { background: #60a5fa; }
    .delta-chip.energy { background: #38bdf8; }
    .delta-chip.co2 { background: #4ade80; }
    .delta-chip.cost { background: #fbbf24; }

    .drawer .impact-preview {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 13px;
      color: #e2e8f0;
      margin-top: 8px;
    }
    .drawer .simulate-btn {
      margin-top: 4px;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    /* Metric tile tooltips */
    .metric-tile {
      position: relative;
    }
    .metric-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30,41,59,0.95);
      color: #e2e8f0;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 20;
    }
    .metric-tile:hover .metric-tooltip {
      opacity: 1;
    }

    /* Hotspot flash animation for story stepper */
    .hotspot.flash {
      animation: hotspot-pulse 1s ease-in-out infinite;
    }
    @keyframes hotspot-pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    /* Highlight case card during story mode */
    .case-card.highlight {
      outline: 2px solid var(--accent);
      transform: scale(1.03);
      transition: transform 0.3s, outline-color 0.3s;
    }

    .detail-overlay {
      position: fixed;
      right: 20px;
      top: 60px;
      max-width: 300px;
      background: rgba(30,41,59,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 8px;
      padding: 10px;
      color: #e2e8f0;
      z-index: 9999;
      font-size: 12px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand">
      <h1>Interactive Digital Twin Hub</h1>
    </div>
    <div class="nav-pills">
      <button class="nav-btn active" onclick="switchTab('panel-overview', this)">Overview</button>
      <button class="nav-btn" onclick="switchTab('panel-ecology', this)">Ecology</button>
      <button class="nav-btn" onclick="switchTab('panel-energy', this)">Energy</button>
      <button class="nav-btn" onclick="switchTab('panel-interrelation', this)">Simulation</button>
    </div>
  </header>

  <main class="app-body">
    <div class="view-stack">

      <section class="view-panel active" id="panel-overview">
        <div class="hub-container">
          <!-- Mission briefing hero -->
          <div class="overview-hero">
            <div class="overview-hero-content">
              <!-- Updated hero copy to emphasise co‑benefits and invite exploration -->
              <h2>Design a Cooler, Greener and Energy Efficient Neighbourhood</h2>
              <p>A neighbourhood-scale digital twin to test interventions before spending millions</p>
              <div class="micro-badges">
                <div class="micro-badge"><i class="fa-solid fa-fire-flame-simple"></i> Heat risk</div>
                <div class="micro-badge"><i class="fa-solid fa-bolt-lightning"></i> Energy poverty</div>
                <div class="micro-badge"><i class="fa-solid fa-screwdriver-wrench"></i> Retrofit complexity</div>
              </div>
            </div>
          </div>
          <!-- Story mode stepper -->
          <div class="story-stepper">
            <div class="step" data-step="1">Find hotspots</div>
            <div class="step" data-step="2">Pick a strategy</div>
            <div class="step" data-step="3">Simulate</div>
          </div>
          <!-- Resume ribbon (hidden until scenario run) -->
          <div id="resume-ribbon" class="resume-ribbon" style="display:none;">
            <span id="resume-text">Last scenario summary</span>
            <button id="resume-btn">Resume scenario</button>
          </div>
          <!-- Baseline metrics strip -->
          <div class="metrics-strip">
            <div class="metric-tile" data-preset="cool" data-tab="panel-interrelation">
              <div class="metric-label">UHI peak (°C)</div>
              <div class="metric-value" data-target="9">0</div>
            </div>
            <div class="metric-tile" data-preset="singapore" data-tab="panel-interrelation">
              <div class="metric-label">NDVI</div>
              <div class="metric-value" data-target="0.22">0</div>
            </div>
            <div class="metric-tile" data-preset="bills" data-tab="panel-interrelation">
              <div class="metric-label">Annual demand (MWh)</div>
              <div class="metric-value" data-target="5000">0</div>
            </div>
            <div class="metric-tile" data-preset="freiburg" data-tab="panel-interrelation">
              <div class="metric-label">PV potential (MWh)</div>
              <div class="metric-value" data-target="650">0</div>
            </div>
            <div class="metric-tile" data-preset="vienna" data-tab="panel-interrelation">
              <div class="metric-label">CO₂ (kt/yr)</div>
              <div class="metric-value" data-target="1.8">0</div>
            </div>
            <div class="metric-tile" data-preset="vienna" data-tab="panel-interrelation">
              <div class="metric-label">Vulnerable HH (%)</div>
              <div class="metric-value" data-target="30">0</div>
            </div>
          </div>
          <!-- Why Twekkelerveld? section -->
          <div class="why-section">
            <div class="why-map">
              <img src="Study Area.png" alt="Twekkelerveld Map">
              <div class="hotspot" style="top: 32%; left: 42%;" data-spot="housing" title="Housing"></div>
              <div class="hotspot" style="top: 60%; left: 25%;" data-spot="industry" title="Industry edge"></div>
              <div class="hotspot" style="top: 45%; left: 75%;" data-spot="green" title="Green corridors"></div>
            </div>
            <div class="why-info">
              <h3>Why Twekkelerveld?</h3>
              <ul>
                <li>Mixed building stock → retrofit tradeoffs are real.</li>
                <li>Heat + energy affordability collide here.</li>
                <li>Perfect scale: neighbourhood interventions actually measurable.</li>
              </ul>
            </div>
          </div>
          <!-- Case studies call-to-action. Clicking the button opens a modal with all global case studies. -->
          <div class="cases-call">
            <button id="open-cases-btn" class="open-cases-btn" onclick="document.getElementById('modal-overlay').classList.add('active')"><i class="fa-solid fa-book-open"></i> Explore global case studies</button>
            <p class="cases-note">Learn from international examples on cooling, energy, retrofits and community solar.</p>
          </div>
          <!-- Timeline -->
          <div class="timeline-section">
            <div class="timeline-item">
              <h5>Now</h5>
              <span>Hotter summers, rising bills.</span>
            </div>
            <div class="timeline-item">
              <h5>2027</h5>
              <span>Grid pressure + retrofit targets.</span>
            </div>
            <div class="timeline-item">
              <h5>2030</h5>
              <span>Policy deadlines (EU targets).</span>
            </div>
            <div class="timeline-item">
              <h5>2050</h5>
              <span>Climate baseline shift.</span>
            </div>
          </div>
          <!-- Presets -->
          <div class="presets-section">
            <div class="preset-btn" data-preset="cool">Cool the streets</div>
            <div class="preset-btn" data-preset="bills">Slash bills fast</div>
            <div class="preset-btn" data-preset="stress">Stress test 2050 heat</div>
          </div>
          <!-- How to use -->
          <div class="howto-section">
            <div class="howto-step">
              <i class="fa-solid fa-tree"></i>
              <span>Explore Ecology map</span>
            </div>
            <div class="howto-step">
              <i class="fa-solid fa-bolt"></i>
              <span>Explore Energy map</span>
            </div>
            <div class="howto-step">
              <i class="fa-solid fa-flask"></i>
              <span>Combine in Simulation and export PDF</span>
            </div>
          </div>
        </div>
        <!-- Side drawer for hotspots -->
        <div id="drawer" class="drawer">
          <div class="drawer-close"><i class="fa-solid fa-xmark"></i></div>
          <h4 id="drawer-title">Location details</h4>
          <img id="drawer-image" src="" alt="">
          <p id="drawer-description"></p>
          <div id="drawer-preview" class="impact-preview"></div>
          <button class="simulate-btn" id="drawer-simulate-btn">Simulate this hotspot</button>
          <button class="open-tab-btn" id="drawer-open-btn">Open tab</button>
        </div>
        <!-- Modal for global case studies. Hidden by default; becomes visible when user clicks the call‑to‑action button. -->
        <div id="modal-overlay" class="modal-overlay">
          <div class="modal-content cases-modal">
            <!-- Close button for the modal -->
            <div class="close-btn" id="cases-close-btn" onclick="document.getElementById('modal-overlay').classList.remove('active')"><i class="fa-solid fa-xmark"></i></div>
            <h4>Global case studies</h4>
            <p>Learn from diverse cities implementing cooling measures, solar power, deep retrofits and community‑driven initiatives. Click any card below to open the full report.</p>
            <div class="case-studies-modal">
              <div class="case-card" data-case="rotterdam">
                <h4>Rotterdam — Adaptation &amp; green roofs</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Nature‑based</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:2"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:1"></div>
                  <div class="outcome-segment outcome-euro" style="flex:1"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
              <div class="case-card" data-case="freiburg">
                <h4>Freiburg — Solar Settlement</h4>
                <div class="tags">
                  <span class="tag">PV</span>
                  <span class="tag">Energy</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:3"></div>
                  <div class="outcome-segment outcome-co2" style="flex:1"></div>
                  <div class="outcome-segment outcome-euro" style="flex:1"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
              <div class="case-card" data-case="vienna">
                <h4>Vienna — Smart City Baumgarten</h4>
                <div class="tags">
                  <span class="tag">Retrofit</span>
                  <span class="tag">Finance</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:2"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:3"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
              <div class="case-card" data-case="singapore">
                <h4>Singapore — vertical greening</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Nature‑based</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:3"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
              <div class="case-card" data-case="barcelona">
                <h4>Barcelona — climate shelter schools</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Retrofit</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:2"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
              <div class="case-card" data-case="paris">
                <h4>Paris — community solar cooperative</h4>
                <div class="tags">
                  <span class="tag">PV</span>
                  <span class="tag">Community</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:3"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="view-panel" id="panel-ecology">
        <div class="panel-toolbar">
          <span><span class="dot"></span>Ecology Digital Twin • Twekkelerveld</span>
          <span>Sources: Landsat 9 · BGT · AHN · KNMI</span>
        </div>
        <div class="panel-iframe-wrapper">
          <iframe src="ecology.html"></iframe>
        </div>
      </section>

      <section class="view-panel" id="panel-energy">
        <div class="panel-toolbar">
          <span><span class="dot"></span>Energy Digital Twin • Twekkelerveld</span>
          <span>Sources: Enexis · Zonnedakje · BAG · CO₂ factors</span>
        </div>
        <div class="panel-iframe-wrapper">
          <iframe src="energy.html"></iframe>
        </div>
      </section>

      <section class="view-panel" id="panel-interrelation">
        <div id="interrelation-panel">
          <div class="top-row">
            <div>
              <div class="top-title">
                <i class="fa-solid fa-diagram-project"></i> Interrelation & Scenario Simulation
              </div>
              <div class="top-sub">
                Simulate trees, PV, retrofits and heatwaves to see impacts on ecology, energy, CO₂ and investments.
              </div>
            </div>
            <div class="top-actions">
              <button class="btn-reset" id="IR_btnReset"><i class="fa-solid fa-rotate-left"></i> Reset</button>
              <button class="btn-reset" id="IR_btnPdf"><i class="fa-solid fa-file-arrow-down"></i> Download scenario PDF</button>
              <button class="btn-reset" id="IR_btnFullscreen"><i class="fa-solid fa-up-right-and-down-left-from-center"></i> Full screen</button>
              <!-- Pin buttons now include a tooltip to clarify purpose -->
              <button class="btn-reset" id="IR_btnPinA" title="Save the current configuration as Scenario A for comparison"><i class="fa-solid fa-thumbtack"></i> Pin A</button>
              <button class="btn-reset" id="IR_btnPinB" title="Save the current configuration as Scenario B for comparison"><i class="fa-solid fa-thumbtack"></i> Pin B</button>
              <button class="btn-reset" id="IR_btnCopy"><i class="fa-solid fa-link"></i> Copy link</button>
              <button class="btn-reset" id="IR_btnSave"><i class="fa-solid fa-download"></i> Save JSON</button>
              <button class="btn-reset" id="IR_btnLoad"><i class="fa-solid fa-upload"></i> Load JSON</button>
              <input type="file" id="IR_fileInput" style="display:none;" accept="application/json" />
            </div>
          </div>

          <div class="layout">
            <div class="left-panel">
              <div class="panel-caption">Scenario settings</div>
              
              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-leaf"></i> <span>Additional trees</span></div>
                  <div class="slider-value"><span id="IR_treesValue">0</span> trees</div>
                </div>
                <input id="IR_sliderTrees" type="range" min="0" max="1500" step="50" value="0">
                <div class="slider-hint">Trees sequester ~20kg CO₂ per year and cost ~€350 each.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-solar-panel"></i> <span>Extra rooftop PV</span></div>
                  <div class="slider-value">+<span id="IR_pvValue">0</span>% PV capacity</div>
                </div>
                <input id="IR_sliderPV" type="range" min="0" max="100" step="5" value="0">
                <div class="slider-hint">Relative to current PV potential. Cost ~€5,400 per +1%.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-house"></i> <span>Insulated buildings</span></div>
                  <div class="slider-value"><span id="IR_retroValue">0</span>% of stock</div>
                </div>
                <input id="IR_sliderRetro" type="range" min="0" max="80" step="5" value="0">
                <div class="slider-hint">Approx. 25–30% energy savings at 80% stock insulated.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-temperature-high"></i> <span>Heatwave severity</span></div>
                  <div class="slider-value">Level <span id="IR_heatValue">0</span></div>
                </div>
                <input id="IR_sliderHeat" type="range" min="0" max="3" step="1" value="0">
                <div class="slider-hint">0 = normal summer, 3 = extreme heatwave.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-seedling"></i> <span>Green roof coverage</span></div>
                  <div class="slider-value"><span id="IR_greenRoofValue">0</span>% of roofs</div>
                </div>
                <input id="IR_sliderGreenRoof" type="range" min="0" max="100" step="10" value="0">
                <div class="slider-hint">Vegetated roofs insulate buildings and provide shade.</div>
              </div>

              <!-- Budget slider and optimizer -->
              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-euro-sign"></i> <span>Budget</span></div>
                  <div class="slider-value">€<span id="IR_budgetValue">0</span></div>
                </div>
                <input id="IR_sliderBudget" type="range" min="0" max="2000000" step="50000" value="0">
                <div class="slider-hint">Maximum investment budget to optimize scenario.</div>
              </div>
              <div class="slider-row" style="text-align:center;">
                <button class="open-tab-btn" id="IR_btnOptimize">Maximize Score</button>
              </div>

              <div class="scenario-insights" id="IR_scenarioInsights">
                Baseline metrics: NDVI ~0.22, UHI ~9°C, energy ~5GWh. Adjust sliders to see impacts.
              </div>
            </div>

            <div class="right-panel">
              <div class="baseline-grid">
                <div class="baseline-card"><div class="label">NDVI (base)</div><div class="value">0.22</div></div>
                <div class="baseline-card"><div class="label">UHI (base)</div><div class="value">9 °C</div></div>
                <div class="baseline-card"><div class="label">Energy</div><div class="value">5,000 MWh</div></div>
                <div class="baseline-card"><div class="label">PV Pot.</div><div class="value">650 MWh</div></div>
                <div class="baseline-card"><div class="label">CO₂</div><div class="value">1.8 kt</div></div>
                <div class="baseline-card"><div class="label">Trees</div><div class="value">2,400</div></div>
              </div>

              <div class="chart-grid">
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Greenness (NDVI)</div><div class="chart-tag" id="IR_ndviTag">Base ~0.22</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartNdvi"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Urban heat (°C)</div><div class="chart-tag" id="IR_uhiTag">Base ~9 °C</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartUhi"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Energy & PV</div><div class="chart-tag" id="IR_energyTag">MWh/yr</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartEnergy"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Overall balance</div><div class="chart-tag">Score</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartRadar"></canvas></div>
                </div>
                <!-- New stakeholder benefits chart shows how citizens and planners each gain from the current scenario.  -->
                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Stakeholder benefits</div>
                    <div class="chart-tag">Score</div>
                  </div>
                  <div class="chart-wrap"><canvas id="IR_chartStakeholders"></canvas></div>
                  <!-- Add explanatory bullet lists to make stakeholder benefits easier to understand -->
                  <div class="stakeholder-details">
                    <strong><i class="fa-solid fa-house-user"></i> Residents</strong>
                    <ul>
                      <li>Cooler summers and improved health through more trees and green roofs</li>
                      <li>Lower utility bills thanks to rooftop solar and deep retrofits</li>
                    </ul>
                    <strong><i class="fa-solid fa-city"></i> City planners</strong>
                    <ul>
                      <li>Progress towards climate targets with lower CO₂ emissions</li>
                      <li>Greater resilience and social equity for the neighbourhood</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="summary">
            <div class="summary-item">
              <div class="summary-label">Greener</div><div class="summary-value positive" id="IR_summaryGreen">+0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Cooler (UHI)</div><div class="summary-value positive" id="IR_summaryCool">-0.0 °C</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Energy demand</div><div class="summary-value positive" id="IR_summaryEnergy">-0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">CO₂ balance</div><div class="summary-value positive" id="IR_summaryCO2">-0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total cost</div><div class="summary-value neutral" id="IR_summaryCost">€0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Protected HH</div><div class="summary-value positive" id="IR_summaryEquity">0%</div>
            </div>
          </div>

        </div>
      </section>

    </div>
  </main>

  <!-- Scenario detail overlays for pinned comparisons -->
  <div id="scenarioAOverlay" class="detail-overlay"></div>
  <div id="scenarioBOverlay" class="detail-overlay"></div>

  <script>
    // --- Tab Switching Logic ---
    window.switchTab = function(targetId, btn) {
      if(btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        document.querySelectorAll('.nav-btn').forEach(b => {
          if(b.onclick.toString().includes(targetId)) {
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
          }
        });
      }

      document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(targetId).classList.add('active');

      // Initialize interrelation on tab switch if not already done
      if (targetId === "panel-interrelation" && window.IR_init && !window.__IR_initialized) {
        window.IR_init();
      }
    };

    /*
      Define a global baseline object and helper functions so that metrics can be computed
      outside of the simulation tab. These functions replicate the core logic from
      IR_computeScenario but operate on arbitrary configuration objects. They are used
      to provide previews on the overview page, compute deltas for case studies,
      store last scenarios, and enable budget optimisations without requiring
      the interrelation panel to be initialised.
    */
    // Global baseline values accessible outside IR_init
    window.IR_BASE_GLOBAL = {
      trees_existing: 2400,
      co2_tree_kg_year: 20,
      ndvi_mean: 0.22,
      uhi_mean: 9.0,
      energy_kwh: 5_000_000,
      pv_kwh: 650_000,
      co2_kg: 1_800_000,
      cost_tree_eur: 350,
      cost_pv_per_pct_eur: 5400,
      dwellings: 2500,
      retrofit_cost_per_dwelling_eur: 12000,
      cost_greenRoof_per_pct_eur: 8000,
      vulnerable_pct: 30
    };

    // Compute a scenario object from a configuration
    window.computeScenario = function(config) {
      const IR = window.IR_BASE_GLOBAL;
      config = config || {};
      const treesAdded = parseInt(config.trees || 0, 10);
      const pvExtraPct = parseInt(config.pv || 0, 10);
      const retroPct = parseInt(config.retro || 0, 10);
      const heatLevel = parseInt(config.heat || 0, 10);
      const greenRoofPct = parseInt(config.green || 0, 10);

      const ndviIncreaseTrees = Math.min(0.06, (treesAdded / 1500) * 0.06);
      const ndviIncreaseGreen = (greenRoofPct / 100) * 0.04;
      const ndviScenario = IR.ndvi_mean + ndviIncreaseTrees + ndviIncreaseGreen;

      const uhiHeatUp = heatLevel * 1.5;
      const uhiTreeCool = (treesAdded / 300) * 0.1;
      const uhiRetroCool = (retroPct / 100) * 0.8;
      const uhiGreenCool = (greenRoofPct / 100) * 1.0;
      const uhiPVcool = (pvExtraPct / 100) * 0.7;
      const treeShadePVLoss = Math.min(0.5, (treesAdded / 1500) * 0.5);

      let uhiScenario = IR.uhi_mean + uhiHeatUp - uhiTreeCool - uhiRetroCool - uhiGreenCool - uhiPVcool;
      if (uhiScenario < 0) uhiScenario = 0;

      const maxSavingsFraction = 0.25;
      const savingsFrac = (retroPct / 80) * maxSavingsFraction;
      let energyScenario_kwh = IR.energy_kwh * (1 - Math.min(savingsFrac, maxSavingsFraction));
      energyScenario_kwh *= (1 + (uhiScenario - IR.uhi_mean) * 0.02);
      energyScenario_kwh *= (1 - (greenRoofPct / 100) * 0.10);
      if (energyScenario_kwh < 0) energyScenario_kwh = 0;

      const pvScenario_kwh = IR.pv_kwh * (1 + pvExtraPct / 100) * (1 - treeShadePVLoss);
      const netGridScenario_kwh = energyScenario_kwh - pvScenario_kwh;

      const co2FromEnergy = IR.co2_kg * (energyScenario_kwh / IR.energy_kwh);
      const co2FromTrees = treesAdded * IR.co2_tree_kg_year;
      let co2Scenario_kg = co2FromEnergy - co2FromTrees;
      if (co2Scenario_kg < 0) co2Scenario_kg = 0;

      const greenScore = Math.min(100, 40 + ((ndviScenario - IR.ndvi_mean) / 0.06) * 40);
      const coolScore = Math.min(100, 40 + (uhiHeatUp > 0 ? 0 : 10) + (uhiTreeCool + uhiRetroCool + uhiGreenCool) * 8);
      const energyScore = Math.min(100, 40 + ((IR.energy_kwh - energyScenario_kwh) / IR.energy_kwh) * 60);
      const co2Score = Math.min(100, 40 + ((IR.co2_kg - co2Scenario_kg) / IR.co2_kg) * 60);

      const treeCost = treesAdded * IR.cost_tree_eur;
      const pvCost = pvExtraPct * IR.cost_pv_per_pct_eur;
      const dwellingsInsulated = IR.dwellings * (retroPct / 100);
      const retrofitCost = dwellingsInsulated * IR.retrofit_cost_per_dwelling_eur;
      const greenRoofCost = greenRoofPct * IR.cost_greenRoof_per_pct_eur;
      const totalCost = treeCost + pvCost + retrofitCost + greenRoofCost;

      const totalVulnerable = IR.dwellings * (IR.vulnerable_pct / 100);
      const protectedHH = totalVulnerable * (retroPct / 100);
      const equityPct = totalVulnerable ? (protectedHH / totalVulnerable) * 100 : 0;

      return {
        treesAdded, pvExtraPct, retroPct, heatLevel, greenRoofPct,
        ndviScenario, uhiScenario, energyScenario_kwh, pvScenario_kwh, netGridScenario_kwh,
        co2Scenario_kg, greenScore, coolScore, energyScore, co2Score,
        treeCost, pvCost, retrofitCost, greenRoofCost, totalCost,
        protectedHH, equityPct, treeShadePVLoss
      };
    };

    // Compute percentage deltas relative to baseline
    window.computeDeltas = function(s) {
      const IR = window.IR_BASE_GLOBAL;
      const greenPct = (s.ndviScenario / IR.ndvi_mean - 1) * 100;
      const energyPct = (1 - s.energyScenario_kwh / IR.energy_kwh) * 100;
      const co2Pct = (1 - s.co2Scenario_kg / IR.co2_kg) * 100;
      const uhiDelta = IR.uhi_mean - s.uhiScenario;
      const equityPct = s.equityPct || 0;
      return { greenPct, energyPct, co2Pct, uhiDelta, equityPct };
    };

    // Helper to get configuration object from preset name
    window.getConfigForPreset = function(name) {
      if (typeof name === 'object' && name !== null) return name;
      let config = {};
      if (name === 'cool') {
        config = { trees: 700, pv: 0, retro: 0, heat: 1, green: 40 };
      } else if (name === 'bills') {
        config = { trees: 0, pv: 20, retro: 50, heat: 0, green: 0 };
      } else if (name === 'stress') {
        config = { trees: 0, pv: 0, retro: 0, heat: 3, green: 0 };
      } else if (window.caseData && window.caseData[name] && window.caseData[name].preset) {
        config = Object.assign({}, window.caseData[name].preset);
      } else {
        config = {};
      }
      return config;
    };

    // ============================================
    // INTERRELATION LOGIC (Original Untouched)
    // ============================================
    window.IR_init = function() {
      if (window.__IR_initialized) return;
      window.__IR_initialized = true;

      // Use baseline values from the global object defined in the mission control enhancements.  
      const IR_BASE = Object.assign({}, window.IR_BASE_GLOBAL);

      // Full screen toggle logic
      (function() {
        var fullBtn = document.getElementById('IR_btnFullscreen');
        if (fullBtn) {
          fullBtn.addEventListener('click', function() {
            var panel = document.getElementById('interrelation-panel');
            if (panel) {
              panel.classList.toggle('fullscreen');
            }
          });
        }
      })();

      const IR_BASE_netGrid_kwh = IR_BASE.energy_kwh - IR_BASE.pv_kwh;
      const elTrees = document.getElementById("IR_sliderTrees");
      const elPV = document.getElementById("IR_sliderPV");
      const elRetro = document.getElementById("IR_sliderRetro");
      const elHeat = document.getElementById("IR_sliderHeat");
      const elGreenRoof = document.getElementById("IR_sliderGreenRoof");
      const elBudget = document.getElementById("IR_sliderBudget");
      const labelBudget = document.getElementById("IR_budgetValue");
      const elReset = document.getElementById("IR_btnReset");
      const elPdf = document.getElementById("IR_btnPdf");
      const btnPinA = document.getElementById("IR_btnPinA");
      const btnPinB = document.getElementById("IR_btnPinB");
      const btnCopy = document.getElementById("IR_btnCopy");
      const btnSave = document.getElementById("IR_btnSave");
      const btnLoad = document.getElementById("IR_btnLoad");
      const fileInput = document.getElementById("IR_fileInput");
      const btnOptimize = document.getElementById("IR_btnOptimize");

      const labelTrees = document.getElementById("IR_treesValue");
      const labelPV = document.getElementById("IR_pvValue");
      const labelRetro = document.getElementById("IR_retroValue");
      const labelHeat = document.getElementById("IR_heatValue");
      const labelGreenRoof = document.getElementById("IR_greenRoofValue");

      const summaryGreen = document.getElementById("IR_summaryGreen");
      const summaryCool = document.getElementById("IR_summaryCool");
      const summaryEnergy = document.getElementById("IR_summaryEnergy");
      const summaryCO2 = document.getElementById("IR_summaryCO2");
      const summaryCost = document.getElementById("IR_summaryCost");
      const summaryEquity = document.getElementById("IR_summaryEquity");
      const insightsBox = document.getElementById("IR_scenarioInsights");

      const ctxNdvi = document.getElementById("IR_chartNdvi").getContext("2d");
      const ctxUhi = document.getElementById("IR_chartUhi").getContext("2d");
      const ctxEnergy = document.getElementById("IR_chartEnergy").getContext("2d");
      const ctxRadar = document.getElementById("IR_chartRadar").getContext("2d");

      Chart.defaults.font.family = "Inter, system-ui, sans-serif";
      Chart.defaults.color = "#9ca3af";

      const IR_chartNdvi = new Chart(ctxNdvi, {
        type: "bar",
        data: {
          labels: ["Baseline", "Scenario"],
          datasets: [
            { label: "Baseline", data: [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean], backgroundColor: "rgba(148,163,184,0.5)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario", data: [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean], backgroundColor: "rgba(52,211,153,0.8)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario A", data: [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean], backgroundColor: "rgba(234,88,12,0.7)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario B", data: [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean], backgroundColor: "rgba(139,92,246,0.7)", borderRadius: 6, maxBarThickness: 30 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { font: { size: 8 } } } }, scales: { y: { suggestedMin: 0, suggestedMax: 0.45, ticks: { stepSize: 0.1 } } } }
      });

      const IR_chartUhi = new Chart(ctxUhi, {
        type: "bar",
        data: {
          labels: ["Baseline", "Scenario"],
          datasets: [
            { label: "Baseline", data: [IR_BASE.uhi_mean, IR_BASE.uhi_mean], backgroundColor: "rgba(148,163,184,0.5)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario", data: [IR_BASE.uhi_mean, IR_BASE.uhi_mean], backgroundColor: "rgba(248,113,113,0.8)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario A", data: [IR_BASE.uhi_mean, IR_BASE.uhi_mean], backgroundColor: "rgba(234,88,12,0.7)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario B", data: [IR_BASE.uhi_mean, IR_BASE.uhi_mean], backgroundColor: "rgba(139,92,246,0.7)", borderRadius: 6, maxBarThickness: 30 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { font: { size: 8 } } } }, scales: { y: { suggestedMin: 0, suggestedMax: 18, ticks: { stepSize: 3 } } } }
      });

      const IR_chartEnergy = new Chart(ctxEnergy, {
        type: "bar",
        data: {
          labels: ["Demand", "PV / Generation", "Net grid"],
          datasets: [
            { label: "Baseline", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(148,163,184,0.5)", borderRadius: 6, maxBarThickness: 26 },
            { label: "Scenario", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(59,130,246,0.8)", borderRadius: 6, maxBarThickness: 26 },
            { label: "Scenario A", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(234,88,12,0.7)", borderRadius: 6, maxBarThickness: 26 },
            { label: "Scenario B", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(139,92,246,0.7)", borderRadius: 6, maxBarThickness: 26 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { boxWidth: 12, boxHeight: 12, font: { size: 8 } } } }, scales: { x: { stacked: false }, y: { stacked: false, ticks: { callback: v => v.toLocaleString() } } } }
      });

      const IR_chartRadar = new Chart(ctxRadar, {
        type: "radar",
        data: {
          labels: ["Greenness", "Cooling", "Energy", "CO₂"],
          datasets: [
            { label: "Baseline", data: [40, 40, 40, 40], borderColor: "rgba(148,163,184,1)", backgroundColor: "rgba(148,163,184,0.1)", borderWidth: 1, pointRadius: 2 },
            { label: "Scenario", data: [40, 40, 40, 40], borderColor: "rgba(52,211,153,1)", backgroundColor: "rgba(52,211,153,0.3)", borderWidth: 1, pointRadius: 2 },
            { label: "Scenario A", data: [40, 40, 40, 40], borderColor: "rgba(234,88,12,1)", backgroundColor: "rgba(234,88,12,0.3)", borderWidth: 1, pointRadius: 2 },
            { label: "Scenario B", data: [40, 40, 40, 40], borderColor: "rgba(139,92,246,1)", backgroundColor: "rgba(139,92,246,0.3)", borderWidth: 1, pointRadius: 2 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { size: 8 } } } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, grid: { color: "rgba(148,163,184,0.3)" }, angleLines: { color: "rgba(148,163,184,0.3)" } } } }
      });

      // -------------------------------------------
      // Stakeholder benefits chart initialisation
      // This horizontal bar chart illustrates how citizens and planners derive benefits
      // from the current scenario. Scores are computed dynamically in IR_updateUI.
      const ctxStakeholders = document.getElementById("IR_chartStakeholders").getContext("2d");
      const IR_chartStakeholders = new Chart(ctxStakeholders, {
        type: "bar",
        data: {
          labels: ["Citizens", "Planners"],
          datasets: [
            {
              label: "Benefit Score",
              data: [40, 40],
              backgroundColor: ["rgba(253,186,116,0.8)", "rgba(167,139,250,0.8)"],
              borderRadius: 6,
              maxBarThickness: 30
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { suggestedMin: 0, suggestedMax: 100 } }
        }
      });

      // Scenario detail overlays for pinned scenarios
      const overlayA = document.getElementById('scenarioAOverlay');
      const overlayB = document.getElementById('scenarioBOverlay');
      function updateScenarioOverlay(type, s) {
        const overlay = type === 'A' ? overlayA : overlayB;
        if (!overlay) return;
        overlay.style.display = 'block';
        // Position overlays at different vertical offsets for A and B to avoid overlap
        if (type === 'A') {
          overlay.style.top = '60px';
        } else {
          overlay.style.top = '140px';
        }
        overlay.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;"><strong>Scenario ${type}</strong><span class="close-scenario" style="cursor:pointer;font-weight:bold;">×</span></div>` +
          `<div style="margin-top:6px;font-size:11px;line-height:1.4;">` +
          `Trees: ${s.treesAdded.toLocaleString()} · PV: ${s.pvExtraPct}% · Retrofit: ${s.retroPct}% · Green roof: ${s.greenRoofPct}%<br>` +
          `NDVI: ${s.ndviScenario.toFixed(2)}, UHI: ${s.uhiScenario.toFixed(1)}°C<br>` +
          `Energy: ${(s.energyScenario_kwh/1000).toFixed(0)} MWh, PV: ${(s.pvScenario_kwh/1000).toFixed(0)} MWh<br>` +
          `CO₂: ${(s.co2Scenario_kg/1000).toFixed(1)} t, Cost: €${Math.round(s.totalCost).toLocaleString()}` +
          `</div>`;
        const closeEl = overlay.querySelector('.close-scenario');
        if (closeEl) {
          closeEl.addEventListener('click', () => overlay.style.display = 'none');
        }
      }

      // Scenario comparison placeholders and updater
      let scenarioA = null;
      let scenarioB = null;
      function updateComparison() {
        // Update chart datasets for Scenario A
        if (scenarioA) {
          IR_chartNdvi.data.datasets[2].data = [IR_BASE.ndvi_mean, scenarioA.ndviScenario];
          IR_chartUhi.data.datasets[2].data = [IR_BASE.uhi_mean, scenarioA.uhiScenario];
          IR_chartEnergy.data.datasets[2].data = [scenarioA.energyScenario_kwh / 1000, scenarioA.pvScenario_kwh / 1000, scenarioA.netGridScenario_kwh / 1000];
          IR_chartRadar.data.datasets[2].data = [scenarioA.greenScore, scenarioA.coolScore, scenarioA.energyScore, scenarioA.co2Score];
        } else {
          IR_chartNdvi.data.datasets[2].data = [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean];
          IR_chartUhi.data.datasets[2].data = [IR_BASE.uhi_mean, IR_BASE.uhi_mean];
          IR_chartEnergy.data.datasets[2].data = [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000];
          IR_chartRadar.data.datasets[2].data = [40, 40, 40, 40];
        }
        // Update chart datasets for Scenario B
        if (scenarioB) {
          IR_chartNdvi.data.datasets[3].data = [IR_BASE.ndvi_mean, scenarioB.ndviScenario];
          IR_chartUhi.data.datasets[3].data = [IR_BASE.uhi_mean, scenarioB.uhiScenario];
          IR_chartEnergy.data.datasets[3].data = [scenarioB.energyScenario_kwh / 1000, scenarioB.pvScenario_kwh / 1000, scenarioB.netGridScenario_kwh / 1000];
          IR_chartRadar.data.datasets[3].data = [scenarioB.greenScore, scenarioB.coolScore, scenarioB.energyScore, scenarioB.co2Score];
        } else {
          IR_chartNdvi.data.datasets[3].data = [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean];
          IR_chartUhi.data.datasets[3].data = [IR_BASE.uhi_mean, IR_BASE.uhi_mean];
          IR_chartEnergy.data.datasets[3].data = [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000];
          IR_chartRadar.data.datasets[3].data = [40, 40, 40, 40];
        }
        IR_chartNdvi.update("none");
        IR_chartUhi.update("none");
        IR_chartEnergy.update("none");
        IR_chartRadar.update("none");
      }

      function IR_computeScenario() {
        const treesAdded = parseInt(elTrees.value, 10) || 0;
        const pvExtraPct = parseInt(elPV.value, 10) || 0;
        const retroPct = parseInt(elRetro.value, 10) || 0;
        const heatLevel = parseInt(elHeat.value, 10) || 0;
        const greenRoofPct = parseInt(elGreenRoof.value, 10) || 0;

        const ndviIncreaseTrees = Math.min(0.06, (treesAdded / 1500) * 0.06);
        const ndviIncreaseGreen = (greenRoofPct / 100) * 0.04;
        const ndviIncrease = ndviIncreaseTrees + ndviIncreaseGreen;
        const ndviScenario = IR_BASE.ndvi_mean + ndviIncrease;

        const uhiHeatUp = heatLevel * 1.5;
        const uhiTreeCool = (treesAdded / 300) * 0.1;
        const uhiRetroCool = (retroPct / 100) * 0.8;
        const uhiGreenCool = (greenRoofPct / 100) * 1.0;
        const uhiPVcool = (pvExtraPct / 100) * 0.7;
        const treeShadePVLoss = Math.min(0.5, (treesAdded / 1500) * 0.5);

        let uhiScenario = IR_BASE.uhi_mean + uhiHeatUp - uhiTreeCool - uhiRetroCool - uhiPVcool - uhiGreenCool;
        if (uhiScenario < 0) uhiScenario = 0;

        const maxSavingsFraction = 0.25;
        const savingsFrac = (retroPct / 80) * maxSavingsFraction;
        let energyScenario_kwh = IR_BASE.energy_kwh * (1 - Math.min(savingsFrac, maxSavingsFraction));
        energyScenario_kwh *= (1 + (uhiScenario - IR_BASE.uhi_mean) * 0.02);
        energyScenario_kwh *= (1 - (greenRoofPct / 100) * 0.10);
        if (energyScenario_kwh < 0) energyScenario_kwh = 0;

        const pvScenario_kwh = IR_BASE.pv_kwh * (1 + pvExtraPct / 100) * (1 - treeShadePVLoss);
        const netGridScenario_kwh = energyScenario_kwh - pvScenario_kwh;

        const co2FromEnergy = IR_BASE.co2_kg * (energyScenario_kwh / IR_BASE.energy_kwh);
        const co2FromTrees = treesAdded * IR_BASE.co2_tree_kg_year;
        let co2Scenario_kg = co2FromEnergy - co2FromTrees;
        if (co2Scenario_kg < 0) co2Scenario_kg = 0;

        const greenScore = Math.min(100, 40 + (ndviIncrease / 0.06) * 40);
        const coolScore = Math.min(100, 40 + (uhiHeatUp > 0 ? 0 : 10) + (uhiTreeCool + uhiRetroCool + uhiGreenCool) * 8);
        const energyScore = Math.min(100, 40 + ((IR_BASE.energy_kwh - energyScenario_kwh) / IR_BASE.energy_kwh) * 60);
        const co2Score = Math.min(100, 40 + ((IR_BASE.co2_kg - co2Scenario_kg) / IR_BASE.co2_kg) * 60);

        const treeCost = treesAdded * IR_BASE.cost_tree_eur;
        const pvCost = pvExtraPct * IR_BASE.cost_pv_per_pct_eur;
        const dwellingsInsulated = IR_BASE.dwellings * (retroPct / 100);
        const retrofitCost = dwellingsInsulated * IR_BASE.retrofit_cost_per_dwelling_eur;
        const greenRoofCost = greenRoofPct * IR_BASE.cost_greenRoof_per_pct_eur;
        const totalCost = treeCost + pvCost + retrofitCost + greenRoofCost;

        // compute equity: number of vulnerable households protected via retrofits
        const totalVulnerable = IR_BASE.dwellings * (window.IR_BASE_GLOBAL ? window.IR_BASE_GLOBAL.vulnerable_pct / 100 : 0);
        const protectedHH = totalVulnerable * (retroPct / 100);
        const equityPct = totalVulnerable ? (protectedHH / totalVulnerable) * 100 : 0;

        return { treesAdded, pvExtraPct, retroPct, heatLevel, greenRoofPct, ndviScenario, uhiScenario, energyScenario_kwh, pvScenario_kwh, netGridScenario_kwh, co2Scenario_kg, greenScore, coolScore, energyScore, co2Score, treeCost, pvCost, retrofitCost, greenRoofCost, totalCost, protectedHH, equityPct, treeShadePVLoss };
      }

      function IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct) {
        const lines = [];
        if (s.treesAdded === 0 && s.pvExtraPct === 0 && s.retroPct === 0 && s.heatLevel === 0) {
          lines.push("Baseline metrics: NDVI ~0.22, UHI ~9 \u00b0C, energy demand ~5,000 MWh/yr, PV potential ~650 MWh/yr, CO₂ emissions ~1.8 kt/yr and ~2,400 existing trees. No additional measures: indicators stay at observed levels and no extra investment is required.");
          return lines;
        }
        if (s.treesAdded > 0) lines.push(`Greening: +${s.treesAdded.toLocaleString()} trees increase effective greenness by ~${Math.round(greenPct)}%. Their canopies provide shade and evapotranspiration that cools streets and lowers energy use for cooling. However, shade on solar panels can substantially cut output — even 10% shading on one module may halve the power of the whole PV string so careful placement is important`);
        if (s.greenRoofPct > 0) lines.push(`Green roofs: Converting ${s.greenRoofPct}% of rooftops to vegetated roofs not only improves greenness but also insulates buildings and shades roof surfaces. Studies report that green roofs can lower roof surface temperatures by up to 13 °C and cut cooling loads by 70%, reducing energy use.`);
        if (s.pvExtraPct > 0) lines.push(`Solar: Rooftop PV capacity rises by ${s.pvExtraPct}%, lowering dependence on grid electricity.`);
        if (s.retroPct > 0) lines.push(`Retrofit: Insulating ${s.retroPct}% of the building stock reduces total energy demand by about ${Math.abs(Math.round(energyPct))}%.`);
        if (s.heatLevel > 0) lines.push(`Heat stress: Heatwave level ${s.heatLevel} pushes UHI up, but measures change net UHI by ${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C.`);
        if (co2Pct > 0) lines.push(`CO₂: Scenario reduces annual operational CO₂ emissions by ~${Math.abs(Math.round(co2Pct))}% relative to the current situation.`);
        if (s.totalCost > 0) {
          const totalCostK = Math.round(s.totalCost).toLocaleString();
          lines.push(`Financial: Approximate total investment of €${totalCostK}.`);
        }
        return lines;
      }

      function IR_updateUI() {
        const s = IR_computeScenario();
        labelTrees.textContent = s.treesAdded.toLocaleString();
        labelPV.textContent = s.pvExtraPct;
        labelRetro.textContent = s.retroPct;
        labelHeat.textContent = s.heatLevel;
        labelGreenRoof.textContent = s.greenRoofPct;
        
        IR_chartNdvi.data.datasets[0].data = [IR_BASE.ndvi_mean, s.ndviScenario]; IR_chartNdvi.update("none");
        IR_chartUhi.data.datasets[0].data = [IR_BASE.uhi_mean, s.uhiScenario]; IR_chartUhi.update("none");
        IR_chartEnergy.data.datasets[0].data = [IR_BASE.energy_kwh/1000, IR_BASE.pv_kwh/1000, IR_BASE_netGrid_kwh/1000];
        IR_chartEnergy.data.datasets[1].data = [s.energyScenario_kwh/1000, s.pvScenario_kwh/1000, s.netGridScenario_kwh/1000];
        IR_chartEnergy.update("none");
        IR_chartRadar.data.datasets[1].data = [s.greenScore, s.coolScore, s.energyScore, s.co2Score]; IR_chartRadar.update("none");

        const greenPct = (s.ndviScenario / IR_BASE.ndvi_mean - 1) * 100;
        const energyPct = (1 - s.energyScenario_kwh / IR_BASE.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / IR_BASE.co2_kg) * 100;
        const uhiDelta = IR_BASE.uhi_mean - s.uhiScenario;
        const clampPct = v => Math.round(v);

        summaryGreen.textContent = `${greenPct >= 0 ? "+" : ""}${clampPct(greenPct)}%`;
        summaryCool.textContent = `${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C`;
        summaryEnergy.textContent = `${energyPct >= 0 ? "-" : "+"}${Math.abs(clampPct(energyPct))}%`;
        summaryCO2.textContent = `${co2Pct >= 0 ? "-" : "+"}${Math.abs(clampPct(co2Pct))}%`;

        summaryGreen.className = "summary-value " + (greenPct >= 0 ? "positive" : "negative");
        summaryCool.className = "summary-value " + (uhiDelta >= 0 ? "positive" : "negative");
        summaryEnergy.className = "summary-value " + (energyPct >= 0 ? "positive" : "negative");
        summaryCO2.className = "summary-value " + (co2Pct >= 0 ? "positive" : "negative");
        summaryCost.textContent = `€${Math.round(s.totalCost).toLocaleString()}`;
        summaryCost.className = "summary-value neutral";

        // Compute stakeholder benefit scores
        // Citizen score emphasises energy and comfort, while planner score focuses on CO₂ and greenness
        const citizenScoreRaw = (s.energyScore * 0.5 + s.coolScore * 0.3 + s.greenScore * 0.1 + s.co2Score * 0.1) - ((s.pvCost + s.retrofitCost) / 20000);
        const plannerScoreRaw = (s.co2Score * 0.4 + s.greenScore * 0.3 + s.coolScore * 0.2 + s.energyScore * 0.1) - ((s.treeCost + s.greenRoofCost) / 20000);
        const clampScore = v => Math.max(0, Math.min(100, v));
        const citizenScore = clampScore(citizenScoreRaw);
        const plannerScore = clampScore(plannerScoreRaw);
        if (IR_chartStakeholders && IR_chartStakeholders.data) {
          IR_chartStakeholders.data.datasets[0].data = [citizenScore, plannerScore];
          IR_chartStakeholders.update("none");
        }

        // Update equity summary
        if (summaryEquity) {
          const eqVal = s.equityPct || 0;
          summaryEquity.textContent = `${Math.round(eqVal)}%`;
          summaryEquity.className = "summary-value " + (eqVal >= 0 ? "positive" : "negative");
        }

        // Build insights and include shading warnings
        const insightLines = IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct);
        // Show conflict warnings if PV shading is significant
        const shadingPct = Math.round((s.treeShadePVLoss || 0) * 100);
        if (shadingPct > 20 && s.pvExtraPct > 20) {
          showToast(`Tree shading reduces PV by ~${shadingPct}%`);
        }
        if (shadingPct > 10 && s.pvExtraPct > 10) {
          insightLines.push(`PV shading warning: Trees reduce PV output by ~${shadingPct}%. Consider adjusting tree placement or PV capacity.`);
        }
        insightsBox.textContent = insightLines.join(" ");

        // Update comparison overlays on charts
        updateComparison();
      }
      // Expose update function globally so other scripts can trigger refresh
      window.IR_updateUI = IR_updateUI;

      ["input", "change"].forEach(evt => {
        elTrees.addEventListener(evt, IR_updateUI);
        elPV.addEventListener(evt, IR_updateUI);
        elRetro.addEventListener(evt, IR_updateUI);
        elHeat.addEventListener(evt, IR_updateUI);
        elGreenRoof.addEventListener(evt, IR_updateUI);
      });
      elReset.addEventListener("click", () => {
        elTrees.value = 0; elPV.value = 0; elRetro.value = 0; elHeat.value = 0; elGreenRoof.value = 0;
        IR_updateUI();
      });

      // Update budget value display
      if (elBudget && labelBudget) {
        const updateBudgetLabel = () => {
          const val = parseInt(elBudget.value || 0, 10);
          labelBudget.textContent = val.toLocaleString();
        };
        elBudget.addEventListener('input', updateBudgetLabel);
        updateBudgetLabel();
      }

      // Optimiser: run a simple grid search to maximise overall score under budget
      if (btnOptimize) {
        btnOptimize.addEventListener('click', () => {
          const budget = parseInt(elBudget.value || 0, 10);
          let bestScore = -1;
          let bestConfig = null;
          const treesOpts = [0, 300, 600, 900, 1200, 1500];
          const pvOpts = [0, 20, 40, 60, 80, 100];
          const retroOpts = [0, 20, 40, 60, 80];
          const heatOpts = [0];
          const greenOpts = [0, 25, 50, 75, 100];
          for (const t of treesOpts) {
            for (const p of pvOpts) {
              for (const r of retroOpts) {
                for (const h of heatOpts) {
                  for (const g of greenOpts) {
                    const config = { trees: t, pv: p, retro: r, heat: h, green: g };
                    const sTmp = computeScenario(config);
                    if (sTmp.totalCost > budget) continue;
                    const overall = (sTmp.greenScore + sTmp.coolScore + sTmp.energyScore + sTmp.co2Score) / 4;
                    if (overall > bestScore) {
                      bestScore = overall;
                      bestConfig = config;
                    }
                  }
                }
              }
            }
          }
          if (bestConfig) {
            // Apply best config to sliders
            elTrees.value = bestConfig.trees;
            elPV.value = bestConfig.pv;
            elRetro.value = bestConfig.retro;
            elHeat.value = bestConfig.heat;
            elGreenRoof.value = bestConfig.green;
            IR_updateUI();
            showToast('Optimised scenario loaded');
          } else {
            showToast('No scenario fits within the selected budget');
          }
        });
      }

      // Scenario comparison pinning
      if (btnPinA) {
        btnPinA.addEventListener('click', () => {
          scenarioA = IR_computeScenario();
          updateComparison();
          // Show details overlay for Scenario A
          updateScenarioOverlay('A', scenarioA);
          showToast('Pinned current as Scenario A');
        });
      }
      if (btnPinB) {
        btnPinB.addEventListener('click', () => {
          scenarioB = IR_computeScenario();
          updateComparison();
          // Show details overlay for Scenario B
          updateScenarioOverlay('B', scenarioB);
          showToast('Pinned current as Scenario B');
        });
      }

      // Copy scenario as link
      if (btnCopy) {
        btnCopy.addEventListener('click', () => {
          const sTmp = IR_computeScenario();
          const params = `trees=${sTmp.treesAdded}&pv=${sTmp.pvExtraPct}&retro=${sTmp.retroPct}&heat=${sTmp.heatLevel}&green=${sTmp.greenRoofPct}`;
          const url = window.location.origin + window.location.pathname + '#' + params;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => showToast('Scenario link copied')).catch(() => showToast('Unable to copy link'));
          } else {
            showToast(url);
          }
        });
      }

      // Save scenario as JSON
      if (btnSave) {
        btnSave.addEventListener('click', () => {
          const sTmp = IR_computeScenario();
          const data = { trees: sTmp.treesAdded, pv: sTmp.pvExtraPct, retro: sTmp.retroPct, heat: sTmp.heatLevel, green: sTmp.greenRoofPct };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'scenario.json';
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
        });
      }

      // Load scenario from JSON
      if (btnLoad) {
        btnLoad.addEventListener('click', () => {
          if (fileInput) fileInput.click();
        });
      }
      if (fileInput) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function() {
            try {
              const json = JSON.parse(reader.result);
              if (typeof json === 'object') {
                if (json.trees !== undefined) elTrees.value = json.trees;
                if (json.pv !== undefined) elPV.value = json.pv;
                if (json.retro !== undefined) elRetro.value = json.retro;
                if (json.heat !== undefined) elHeat.value = json.heat;
                if (json.green !== undefined) elGreenRoof.value = json.green;
                IR_updateUI();
                showToast('Scenario loaded from JSON');
              }
            } catch (err) {
              showToast('Invalid JSON');
            }
          };
          reader.readAsText(file);
        });
      }

      async function IR_downloadPdf() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) { alert("PDF library not loaded."); return; }
        const interPanel = document.querySelector("#panel-interrelation");
        const oldOpacity = interPanel.style.opacity;
        const oldPointer = interPanel.style.pointerEvents;
        interPanel.style.opacity = 1; interPanel.style.pointerEvents = "auto";
        await new Promise(resolve => setTimeout(resolve, 300));
        const pdf = new jsPDF("p", "mm", "a4");
        if (pdf.setCharSpace) pdf.setCharSpace(0);
        const s = IR_computeScenario();
        const greenPct = (s.ndviScenario / IR_BASE.ndvi_mean - 1) * 100;
        const energyPct = (1 - s.energyScenario_kwh / IR_BASE.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / IR_BASE.co2_kg) * 100;
        const uhiDelta = IR_BASE.uhi_mean - s.uhiScenario;
        const insightLines = IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct);
        const marginX = 18;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const contentWidth = pageWidth - marginX * 2;
        pdf.setFont("helvetica", "bold"); pdf.setFontSize(16);
        pdf.text("Twekkelerveld Digital Twin", pageWidth / 2, 20, { align: "center" });
        pdf.setFontSize(12); pdf.text("Scenario Simulation Report", pageWidth / 2, 27, { align: "center" });
        pdf.setFontSize(9); pdf.setFont("helvetica", "normal");
        const nowStr = new Date().toLocaleString();
        pdf.text(`Generated: ${nowStr}`, pageWidth / 2, 33, { align: "center" });
        let y = 40;
        function sectionHeader(label) {
          pdf.setDrawColor(200); pdf.setFillColor(245);
          pdf.roundedRect(marginX, y, contentWidth, 8, 2, 2, "F");
          pdf.setFont("helvetica", "bold"); pdf.setFontSize(10); pdf.setTextColor(60);
          if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(label, marginX + 3, y + 5);
          pdf.setTextColor(0); y += 12;
        }
        sectionHeader("SCENARIO INPUTS");
        pdf.setFont("helvetica", "normal"); pdf.setFontSize(9);
        const inputs = [
          ["Additional trees", `${s.treesAdded.toLocaleString()} (baseline: ${IR_BASE.trees_existing.toLocaleString()} trees)`],
          ["Extra rooftop PV", `${s.pvExtraPct}% (relative to current potential)`],
          ["Insulated buildings", `${s.retroPct}% of stock (${Math.round(IR_BASE.dwellings * (s.retroPct / 100)).toLocaleString()} dwellings)`],
          ["Green roof coverage", `${s.greenRoofPct}% of roofs`],
          ["Heatwave severity", `Level ${s.heatLevel} (0 = normal summer, 3 = extreme)`]
        ];
        inputs.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 48, y);
          y += 5;
        });
        y += 4;
        sectionHeader("INDICATOR CHANGES");
        const deltas = [
          ["Greenness (NDVI)", `${greenPct >= 0 ? "+" : ""}${Math.round(greenPct)}%`],
          ["Urban heat island", `${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C`],
          ["Energy demand", `${energyPct >= 0 ? "-" : "+"}${Math.abs(Math.round(energyPct))}%`],
          ["Operational CO₂", `${co2Pct >= 0 ? "-" : "+"}${Math.abs(Math.round(co2Pct))}%`]
        ];
        deltas.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 48, y);
          y += 5;
        });
        y += 4;
        sectionHeader("FINANCIAL OVERVIEW");
        const costLines = [
          ["Tree planting cost", `€${Math.round(s.treeCost).toLocaleString()}`],
          ["PV investment cost", `€${Math.round(s.pvCost).toLocaleString()}`],
          ["Retrofit cost", `€${Math.round(s.retrofitCost).toLocaleString()}`],
          ["Green roof cost", `€${Math.round(s.greenRoofCost).toLocaleString()}`],
          ["Total scenario cost", `€${Math.round(s.totalCost).toLocaleString()}`]
        ];
        costLines.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 60, y);
          y += 5;
        });
        y += 4;
        sectionHeader("SCENARIO INSIGHTS");
        pdf.setFont("helvetica", "normal");
        const maxWidth = contentWidth - 6;
        insightLines.forEach(line => {
          if (pdf.setCharSpace) pdf.setCharSpace(0);
          const wrapped = pdf.splitTextToSize(line, maxWidth);
          wrapped.forEach((w, i) => {
            const prefix = i === 0 ? "• " : "  ";
            pdf.text(prefix + w, marginX + 2, y);
            y += 5;
            if (y > 270) { pdf.addPage(); y = 20; }
          });
        });
        pdf.addPage();
        pdf.setFont("helvetica", "bold"); pdf.setFontSize(12);
        if (pdf.setCharSpace) pdf.setCharSpace(0);
        pdf.text("Scenario Charts", marginX, 18);
        pdf.setFont("helvetica", "normal"); pdf.setFontSize(9);
        pdf.text("Charts exported from the interactive interrelation dashboard.", marginX, 24);
        const imgWidth = 80; const imgHeight = 55; const gapX = 10; const gapY = 10;
        const x1 = marginX; const x2 = x1 + imgWidth + gapX;
        const yTop = 30; const yBottom = yTop + imgHeight + gapY;
        const addChartImage = (canvasId, x, yPos) => {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          const imgData = canvas.toDataURL("image/png", 1.0);
          pdf.addImage(imgData, "PNG", x, yPos, imgWidth, imgHeight);
        };
        addChartImage("IR_chartNdvi", x1, yTop); addChartImage("IR_chartUhi", x2, yTop);
        addChartImage("IR_chartEnergy", x1, yBottom); addChartImage("IR_chartRadar", x2, yBottom);
        interPanel.style.opacity = oldOpacity; interPanel.style.pointerEvents = oldPointer;
        pdf.save("Twekkelerveld_scenario_simulation.pdf");
      }
      elPdf.addEventListener("click", IR_downloadPdf);
      IR_updateUI();
    };
    // ============================
    // Mission briefing interactions
    // ============================
    document.addEventListener('DOMContentLoaded', function() {
      // Animate baseline metric counters
      function animateCounters() {
        const counters = document.querySelectorAll('.metric-value');
        counters.forEach(el => {
          const target = parseFloat(el.getAttribute('data-target'));
          const decimals = (target % 1 !== 0) ? 2 : 0;
          const startTime = performance.now();
          const duration = 1500;
          function update(now) {
            const progress = Math.min((now - startTime) / duration, 1);
            const value = target * progress;
            el.textContent = decimals === 0 ? Math.round(value).toLocaleString() : value.toFixed(decimals);
            if (progress < 1) requestAnimationFrame(update);
          }
          requestAnimationFrame(update);
        });
      }
      animateCounters();

      // Global data for hotspots and case studies
      window.hotspotData = {
        housing: {
          title: "Housing hotspot",
          img: "Study Area.png",
          desc: "Dense residential blocks where retrofit trade‑offs are tangible. Upgrading insulation here improves comfort but must balance heritage and affordability.",
          tab: "panel-ecology",
          // approximate intervention: add trees and some green roofs around housing blocks
          preset: { trees: 600, pv: 0, retro: 0, heat: 0, green: 20 }
        },
        industry: {
          title: "Industrial edge",
          img: "Study Area.png",
          desc: "Industrial areas on the district edge contribute to heat and offer vast roof surfaces for PV. Understanding their energy profiles is key.",
          tab: "panel-energy",
          // encourage rooftop PV adoption on industrial roofs and modest street trees
          preset: { trees: 200, pv: 20, retro: 0, heat: 0, green: 0 }
        },
        green: {
          title: "Green corridors",
          img: "Study Area.png",
          desc: "Existing green corridors provide cooling but could be better connected. Spot opportunities for tree planting and pocket parks.",
          tab: "panel-ecology",
          // strengthen green corridors with extra trees and maximum green roofs
          preset: { trees: 300, pv: 0, retro: 0, heat: 0, green: 50 }
        }
      };
      window.caseData = {
        rotterdam: {
          title: "Rotterdam — Adaptation & green roofs",
          body: "Rotterdam’s climate change adaptation strategy combines flood defences, blue‑green corridors and over 185,000 m² of green roofs to enhance resilience and biodiversity【143559859189314†L117-L148】.",
          link: "https://www.c40.org/case-studies/c40-good-practice-guides-rotterdam-climate-change-adaptation-strategy/",
          preset: { trees: 600, pv: 0, retro: 0, heat: 0, green: 20 }
        },
        freiburg: {
          title: "Freiburg — Solar Settlement",
          body: "Freiburg’s Solar Settlement features 59 energy‑positive homes with roofs covered in PV modules. The 445 kW system generates about 420,000 kWh per year—nearly triple residents’ consumption【68796956034976†L42-L65】.",
          link: "https://hajster.com/en/case-en/freiburg-an-example-of-sustainable-energy-efficient-urban-development-en",
          preset: { trees: 0, pv: 40, retro: 0, heat: 0, green: 0 }
        },
        vienna: {
          title: "Vienna — Smart City Baumgarten",
          body: "The Smart City Baumgarten project retrofits mixed‑age buildings with 25 geothermal boreholes, PV panels and deep insulation. About 40–50% of costs were subsidised and the project meets Passive House standards【740516144639354†L192-L241】.",
          link: "https://www.alpine-space.eu/project-news/retrofitting-for-the-future-the-smart-city-baumgarten-case-study-in-vienna/",
          preset: { trees: 0, pv: 10, retro: 70, heat: 0, green: 0 }
        },
        singapore: {
          title: "Singapore — Vertical greening",
          body: "Green roofs and vertical gardens in Southeast Asia provide natural insulation, manage rainwater and improve air quality. Projects like Singapore’s Pinnacle@Duxton show lower energy bills and stronger community well‑being【850705513734537†L90-L103】.",
          link: "https://billionbricks.org/blog/green-roofs-and-vertical-gardens-reimagining-urban-housing-in-sea/",
          preset: { trees: 800, pv: 0, retro: 0, heat: 0, green: 50 }
        },
        barcelona: {
          title: "Barcelona — Climate shelter schools",
          body: "Barcelona converted 11 schools into climate shelters with water features, vegetation and insulated roofs. The project reclaimed 1,000 m² of natural land and created 2,213 m² of shaded areas【107164856569819†L63-L107】.",
          link: "https://uia.urban-initiative.eu/en/news/11-schools-barcelona-project-are-now-climate-shelters",
          preset: { trees: 0, pv: 0, retro: 30, heat: 0, green: 30 }
        },
        paris: {
          title: "Paris — Community solar cooperative",
          body: "EnerCit’IF, a Parisian energy cooperative, installed 15 PV power plants totalling 730 kWp. The Emile Anthoine gym alone produces 90,000 kWh annually and supplies nearby homes while engaging citizens in the city’s 2050 energy plan【186441328491013†L109-L121】.",
          link: "https://theurbanactivist.com/climate/citizens-could-seize-the-moment-energy-cooperatives-pluck-in-paris/",
          preset: { trees: 0, pv: 60, retro: 0, heat: 0, green: 0 }
        }
      };

      // Hotspot click behaviour
      const drawer = document.getElementById('drawer');
      const drawerTitle = document.getElementById('drawer-title');
      const drawerImg = document.getElementById('drawer-image');
      const drawerDesc = document.getElementById('drawer-description');
      const drawerOpenBtn = document.getElementById('drawer-open-btn');
      document.querySelectorAll('.hotspot').forEach(h => {
        h.addEventListener('click', function() {
          const key = this.getAttribute('data-spot');
          const data = window.hotspotData[key];
          if (!data) return;
          drawerTitle.textContent = data.title;
          drawerDesc.textContent = data.desc;
          drawerImg.src = data.img;
          drawerOpenBtn.textContent = data.tab === "panel-ecology" ? "Open Ecology tab" : "Open Energy tab";
          drawerOpenBtn.dataset.tab = data.tab;
          drawer.classList.add('open');
        });
      });
      const drawerClose = drawer ? drawer.querySelector('.drawer-close') : null;
      if (drawerClose) {
        drawerClose.addEventListener('click', function() {
          drawer.classList.remove('open');
        });
      }
      if (drawerOpenBtn) {
        drawerOpenBtn.addEventListener('click', function() {
          const t = this.dataset.tab;
          if (t) {
            switchTab(t);
            drawer.classList.remove('open');
          }
        });
      }

      // Case study click behaviour – open external links instead of showing a modal.
      document.querySelectorAll('.case-card').forEach(card => {
        card.addEventListener('click', function(e) {
          const key = this.getAttribute('data-case');
          const data = window.caseData && window.caseData[key];
          if (!data) return;
          // If a link exists, open it in a new tab
          if (data.link) {
            window.open(data.link, '_blank');
            return;
          }
          // Otherwise, fall back to applying the preset directly
          if (data.preset) {
            loadPreset(key);
          }
        });
      });

      // Preset buttons
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const preset = this.getAttribute('data-preset');
          loadPreset(preset);
        });
      });

      /**
       * Mission control enhancements
       * - Compute and display delta chips on case cards
       * - Show metric tile tooltips and enable click-to-load presets
       * - Implement guided story stepper interactions
       * - Display resume ribbon for last scenario
       * - Show impact preview inside hotspot drawer and simulate button
       */
      // Create delta chips for case cards
      document.querySelectorAll('.case-card').forEach(card => {
        const key = card.getAttribute('data-case');
        const data = window.caseData && window.caseData[key];
        const chipsContainer = card.querySelector('.delta-chips');
        if (!chipsContainer || !data || !data.preset) return;
        const s = computeScenario(data.preset);
        // Compute deltas relative to baseline
        const uhiDelta = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
        const energyPct = (1 - s.energyScenario_kwh / window.IR_BASE_GLOBAL.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
        // Cost formatting
        const cost = s.totalCost;
        let costLabel;
        if (cost >= 1_000_000) costLabel = '€' + (cost / 1_000_000).toFixed(1) + 'M';
        else costLabel = '€' + Math.round(cost / 1000).toLocaleString() + 'k';
        // Build chip HTML; sign convention: negative means reduction is good (cooler, less energy, less CO2)
        const chips = [];
        const uhiLabel = `${uhiDelta >= 0 ? '↓' : '↑'}${Math.abs(uhiDelta).toFixed(1)}°C`;
        chips.push(`<span class="delta-chip cool">${uhiLabel}</span>`);
        const energyLabel = `${energyPct >= 0 ? '↓' : '↑'}${Math.abs(Math.round(energyPct))}% MWh`;
        chips.push(`<span class="delta-chip energy">${energyLabel}</span>`);
        const co2Label = `${co2Pct >= 0 ? '↓' : '↑'}${Math.abs(Math.round(co2Pct))}% CO₂`;
        chips.push(`<span class="delta-chip co2">${co2Label}</span>`);
        chips.push(`<span class="delta-chip cost">${costLabel}</span>`);
        chipsContainer.innerHTML = chips.join('');
      });

      // Metric tiles: add tooltips and click behaviour
      document.querySelectorAll('.metric-tile').forEach(tile => {
        const presetName = tile.getAttribute('data-preset');
        const targetTab = tile.getAttribute('data-tab');
        // Create tooltip element
        const tooltip = document.createElement('div');
        tooltip.className = 'metric-tooltip';
        tile.appendChild(tooltip);
        // Compute preview values using preset
        let text = '';
        if (presetName) {
          const cfg = getConfigForPreset(presetName);
          const s = computeScenario(cfg);
          const label = tile.querySelector('.metric-label') ? tile.querySelector('.metric-label').textContent.toLowerCase() : '';
          if (label.includes('uhi')) {
            const diff = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
            text = `${diff >= 0 ? '-' : '+'}${Math.abs(diff).toFixed(1)}°C vs base`;
          } else if (label.includes('ndvi')) {
            const pct = ((s.ndviScenario / window.IR_BASE_GLOBAL.ndvi_mean) - 1) * 100;
            text = `${pct >= 0 ? '+' : ''}${Math.round(pct)}% vs base`;
          } else if (label.includes('demand')) {
            const pct = (1 - s.energyScenario_kwh / window.IR_BASE_GLOBAL.energy_kwh) * 100;
            text = `${pct >= 0 ? '-' : '+'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('pv')) {
            const pct = (s.pvScenario_kwh / window.IR_BASE_GLOBAL.pv_kwh - 1) * 100;
            text = `${pct >= 0 ? '+' : '-'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('co₂') || label.includes('co2')) {
            const pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
            text = `${pct >= 0 ? '-' : '+'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('vulnerable')) {
            const pct = s.equityPct || 0;
            text = `${pct >= 0 ? '+' : ''}${Math.round(pct)}% protected`;
          }
        }
        tooltip.textContent = text;
        // Click opens tab and loads preset
        tile.addEventListener('click', () => {
          if (presetName) loadPreset(presetName);
          if (targetTab) switchTab(targetTab);
        });
      });

      // Story stepper interactions
      const storySteps = document.querySelectorAll('.story-stepper .step');
      if (storySteps) {
        storySteps.forEach(step => {
          step.addEventListener('click', () => {
            storySteps.forEach(s => s.classList.remove('active'));
            step.classList.add('active');
            const stepNum = parseInt(step.getAttribute('data-step'), 10);
            if (stepNum === 1) {
              // highlight hotspots
              const hs = document.querySelectorAll('.hotspot');
              hs.forEach(h => h.classList.add('flash'));
              setTimeout(() => hs.forEach(h => h.classList.remove('flash')), 2500);
              const why = document.querySelector('.why-section');
              if (why && why.scrollIntoView) why.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (stepNum === 2) {
              // highlight a case card
              const card = document.querySelector('.case-card');
              if (card) {
                card.classList.add('highlight');
                if (card.scrollIntoView) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => card.classList.remove('highlight'), 2500);
              }
            } else if (stepNum === 3) {
              // load a default strategy and open simulation
              loadPreset('cool');
            }
          });
        });
      }

      // Resume ribbon: show summary of last scenario
      const resumeRibbon = document.getElementById('resume-ribbon');
      const resumeText = document.getElementById('resume-text');
      const resumeBtn = document.getElementById('resume-btn');
      try {
        const lastStr = localStorage.getItem('lastScenario');
        if (lastStr) {
          const lastObj = JSON.parse(lastStr);
          if (lastObj && lastObj.config) {
            const s = computeScenario(lastObj.config);
            const del = computeDeltas(s);
            const date = new Date(lastObj.timestamp || Date.now());
            const uhi = del.uhiDelta;
            const energy = del.energyPct;
            const co2 = del.co2Pct;
            const parts = [];
            parts.push(`UHI ${uhi >= 0 ? '-' : '+'}${Math.abs(uhi).toFixed(1)}°C`);
            parts.push(`Energy ${energy >= 0 ? '-' : '+'}${Math.abs(Math.round(energy))}%`);
            parts.push(`CO₂ ${co2 >= 0 ? '-' : '+'}${Math.abs(Math.round(co2))}%`);
            resumeText.innerHTML = `Last scenario: ${lastObj.name || 'custom'} (${date.toLocaleDateString()}) &mdash; ${parts.join(', ')}`;
            resumeRibbon.style.display = 'flex';
            if (resumeBtn) {
              resumeBtn.onclick = function() {
                loadPreset(lastObj.config);
              };
            }
          }
        }
      } catch(err) { /* ignore */ }

      // Hotspot preview and simulate button
      const drawerPreview = document.getElementById('drawer-preview');
      const drawerSimBtn = document.getElementById('drawer-simulate-btn');
      document.querySelectorAll('.hotspot').forEach(h => {
        h.addEventListener('click', function() {
          const key = this.getAttribute('data-spot');
          const data = window.hotspotData && window.hotspotData[key];
          if (!data) return;
          if (data.preset) {
            const s = computeScenario(data.preset);
            const uhi = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
            const co2pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
            drawerPreview.innerHTML = `If we add ${data.preset.trees} trees & ${data.preset.green}% green roofs → UHI ${uhi >= 0 ? '–' : '+'}${Math.abs(uhi).toFixed(1)}°C, CO₂ ${co2pct >= 0 ? '–' : '+'}${Math.abs(Math.round(co2pct))}%`;
            drawerSimBtn.dataset.preset = JSON.stringify(data.preset);
          } else {
            drawerPreview.textContent = '';
            drawerSimBtn.dataset.preset = '';
          }
        });
      });
      if (drawerSimBtn) {
        drawerSimBtn.addEventListener('click', function() {
          const presetStr = this.dataset.preset;
          if (presetStr) {
            try {
              const cfg = JSON.parse(presetStr);
              if (cfg) loadPreset(cfg);
            } catch(e) {}
          }
          const dr = document.getElementById('drawer');
          if (dr) dr.classList.remove('open');
        });
      }
      // Global case studies modal open/close
      const casesBtn = document.getElementById('open-cases-btn');
      const modalOverlay = document.getElementById('modal-overlay');
      const casesClose = document.getElementById('cases-close-btn');
      if (casesBtn && modalOverlay) {
        casesBtn.addEventListener('click', function() {
          modalOverlay.classList.add('active');
        });
      }
      if (casesClose && modalOverlay) {
        casesClose.addEventListener('click', function() {
          modalOverlay.classList.remove('active');
        });
      }
    });

    // Toast helper
    function showToast(msg) {
      let toast = document.querySelector('.toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast.__hideTimeout);
      toast.__hideTimeout = setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load preset: sets simulation sliders and navigates to simulation tab
    window.loadPreset = function(nameOrConfig) {
      let config = {};
      let presetName = '';
      // Determine whether argument is a preset name or a config object
      if (typeof nameOrConfig === 'object' && nameOrConfig !== null) {
        config = Object.assign({}, nameOrConfig);
        presetName = 'custom';
      } else {
        presetName = nameOrConfig;
        config = getConfigForPreset(presetName);
      }
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val !== undefined) { el.value = val; }
      };
      if (config.trees !== undefined) setVal('IR_sliderTrees', config.trees);
      if (config.pv !== undefined) setVal('IR_sliderPV', config.pv);
      if (config.retro !== undefined) setVal('IR_sliderRetro', config.retro);
      if (config.heat !== undefined) setVal('IR_sliderHeat', config.heat);
      if (config.green !== undefined) setVal('IR_sliderGreenRoof', config.green);
      // update simulation UI if available
      if (window.IR_updateUI) window.IR_updateUI();
      // persist last scenario in local storage
      try {
        localStorage.setItem('lastScenario', JSON.stringify({ name: presetName, config: config, timestamp: Date.now() }));
      } catch (e) {}
      // Build toast message
      let msg = '';
      if (presetName === 'cool') msg = 'Preset loaded: Cool the streets';
      else if (presetName === 'bills') msg = 'Preset loaded: Slash bills fast';
      else if (presetName === 'stress') msg = 'Preset loaded: Stress test 2050 heat';
      else if (window.caseData && window.caseData[presetName]) msg = `Preset loaded: ${window.caseData[presetName].title}`;
      else if (presetName === 'custom') msg = 'Scenario loaded from config';
      else msg = 'Preset loaded';
      showToast(msg);
      // switch to simulation tab by default
      switchTab('panel-interrelation');
    };

  </script>
</body>
</html>