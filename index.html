<!-- patched file -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Twekkelerveld Digital Twin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Cloudflare/R2 config (optional). Used by embedded Ecology/Energy views. -->
  <script src="config.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* --- GLOBAL THEME --- */
    :root {
      --bg-core: #020617;
      --bg-card: #0f172a;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --border: rgba(148, 163, 184, 0.2);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      font-family: "Inter", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 60%);
      color: var(--text-main);
      overflow: hidden; 
    }

    body { display: flex; flex-direction: column; }

    /* --- HEADER --- */
    .app-header {
      flex: 0 0 auto;
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 24px;
      background: rgba(15, 23, 42, 0.95);
      border-bottom: 1px solid var(--border);
      z-index: 100;
    }
    .brand h1 { margin: 0; font-size: 18px; font-weight: 600; color: #fff; }
    
    .nav-pills { display: flex; gap: 8px; }
    .nav-btn {
      background: transparent; border: 1px solid transparent; color: var(--text-muted);
      padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: 500;
      transition: all 0.2s;
    }
    .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .nav-btn.active { background: rgba(56, 189, 248, 0.15); border-color: var(--accent); color: var(--accent); }

    /* --- BODY LAYOUT --- */
    .app-body { flex: 1; position: relative; overflow: hidden; }
    .view-stack { height: 100%; width: 100%; position: relative; }
    .view-panel { display: none; width: 100%; height: 100%; flex-direction: column; }
    .view-panel.active { display: flex; animation: fadeUp 0.4s ease; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* For Ecology/Energy Iframes */
    .web-frame { flex: 1; border: none; background: #000; }
    .panel-iframe-wrapper { flex: 1; border-radius: 16px; overflow: hidden; background: #000; border: 1px solid rgba(51,65,85,0.8); margin: 10px; }
    .panel-iframe-wrapper iframe { width: 100%; height: 100%; border: none; display: block; }
    .panel-toolbar { display: flex; justify-content: space-between; align-items: center; margin: 10px 14px 4px; font-size: 11px; color: var(--text-muted); }
    .panel-toolbar .dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; margin-right: 6px; display: inline-block; }

    /* =========================================
       OVERVIEW TAB STYLES
       ========================================= */
    #panel-overview {
      overflow-y: auto; 
      padding: 40px;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
      align-items: center;
    }

    .hub-container {
      width: 100%; max-width: 1400px;
      display: flex; flex-direction: column; gap: 40px;
    }

    .hero-text { text-align: center; margin-bottom: 10px; }
    .hero-text h2 { font-size: 36px; font-weight: 700; margin: 0 0 10px 0; color: #fff; }
    .hero-text p { font-size: 16px; color: var(--text-muted); }

    .hero-actions { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
    .pill-btn {
      background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border);
      padding: 12px 24px; border-radius: 99px; color: #cbd5e1; cursor: pointer;
      font-size: 14px; transition: all 0.2s; display: flex; align-items: center; gap: 8px;
    }
    .pill-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); transform: translateY(-2px); }

    .showcase-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: stretch;
    }

    .showcase-card {
      background: #0f172a; border: 1px solid var(--border);
      border-radius: 16px; overflow: hidden; display: flex; flex-direction: column;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .card-top { padding: 20px; border-bottom: 1px solid var(--border); background: rgba(30, 41, 59, 0.3); }
    .card-top h3 { margin: 0; font-size: 18px; color: #fff; font-weight: 600; }

    .card-media {
      width: 100%; height: 350px; background: #000;
      position: relative; border-bottom: 1px solid var(--border);
    }
    .card-media img {
      width: 100%; height: 100%; object-fit: contain; display: block;
    }

    .card-desc {
      padding: 25px; font-size: 14px; line-height: 1.6; color: #cbd5e1;
      background: rgba(15, 23, 42, 0.6); flex: 1;
    }
    .card-desc strong { color: #fff; display: block; margin-bottom: 8px; font-size: 15px; }

    @media(max-width: 1024px) {
      .showcase-grid { grid-template-columns: 1fr; }
      .card-media { height: 300px; }
    }

    /* === Redesigned Overview Section === */
    .overview-hero {
      position: relative;
      width: 100%;
      min-height: 380px;
      border-radius: 16px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
    }
    .overview-hero::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url('heatmap.png');
      background-size: cover;
      background-position: center;
      opacity: 0.35;
      filter: brightness(0.8) saturate(1.2);
      animation: heroZoom 20s linear infinite alternate;
    }
    .overview-hero::after {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(255,255,255,0.03) 0,
        rgba(255,255,255,0.03) 2px,
        transparent 2px,
        transparent 4px
      );
      animation: scanLines 8s linear infinite;
    }
    @keyframes heroZoom {
      0% { transform: scale(1); }
      100% { transform: scale(1.1); }
    }
    @keyframes scanLines {
      from { background-position: 0 0; }
      to { background-position: 0 40px; }
    }
    .overview-hero-content {
      position: relative;
      z-index: 2;
      max-width: 800px;
    }
    .overview-hero-content h2 {
      margin: 0;
      font-size: 32px;
      font-weight: 700;
      color: #f1f5f9;
    }
    .overview-hero-content p {
      margin-top: 8px;
      font-size: 16px;
      color: var(--text-muted);
    }
    .micro-badges {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .micro-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 999px;
      background: rgba(30, 41, 59, 0.75);
      border: 1px solid rgba(148,163,184,0.3);
      color: #e2e8f0;
    }
    .micro-badge i { font-size: 14px; color: var(--accent); }

    .metrics-strip {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 14px;
      margin-top: 40px;
    }
    .metric-tile {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 14px 12px;
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 80px;
    }
    .metric-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    .metric-value {
      font-size: 20px;
      font-weight: 600;
      color: #f8fafc;
    }

    .why-section {
      display: flex;
      flex-wrap: wrap;
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 16px;
      overflow: hidden;
    }
    .why-map {
      flex: 1;
      min-width: 280px;
      position: relative;
    }
    .why-map img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .hotspot {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid #fff;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }
    .hotspot:hover {
      transform: translate(-50%, -50%) scale(1.2);
    }

    /* Additional custom styles added to support new UI elements */
    .badge-info {
      margin-top: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text-muted);
      font-size: 14px;
      max-width: 600px;
      text-align: center;
    }
    .current-conditions {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }
    .current-conditions h3 {
      margin: 0 0 12px 0;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .neighbourhood-hotspots {
      margin-top: 16px;
    }
    .neighbourhood-hotspots h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: #fff;
    }
    .neighbourhood-hotspots ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .neighbourhood-hotspots li button {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      color: #e2e8f0;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      width: 100%;
      transition: all 0.2s;
    }
    .neighbourhood-hotspots li button:hover {
      background: var(--accent);
      color: #0f172a;
    }
    .predefined-scenarios {
      margin-top: 30px;
    }
    .predefined-scenarios h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }
    .why-info {
      flex: 1;
      min-width: 280px;
      padding: 20px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .why-info h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .why-info ul {
      padding-left: 20px;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: var(--text-muted);
      font-size: 14px;
    }
    .why-info li::marker {
      color: var(--accent);
    }

    .drawer {
      /* Hide the original drawer since we use a side panel instead */
      display: none;
      position: fixed;
      top: 0;
      right: -400px;
      width: 360px;
      height: 100%;
      background: rgba(2,6,23,0.98);
      border-left: 1px solid rgba(148,163,184,0.4);
      padding: 24px 20px;
      box-shadow: -10px 0 30px rgba(0,0,0,0.7);
      transition: right 0.35s ease;
      z-index: 3000;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }
    /* Override drawer open state so it never slides in; replaced by hotspot panel */
    .drawer.open { right: -400px; }
    .drawer h4 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .drawer p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .drawer img {
      width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .drawer .drawer-close {
      align-self: flex-end;
      cursor: pointer;
      font-size: 20px;
      color: var(--accent);
    }
    .drawer .open-tab-btn {
      margin-top: auto;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    /* Language selector */
    .lang-select-container {
      margin-left: 12px;
    }
    .lang-select-container select {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    /* Hotspot panel to display location info beside the map */
    .why-section {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
    }
    .hotspot-panel {
      display: none;
      flex-direction: column;
      gap: 10px;
      background: rgba(2,6,23,0.98);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px;
      border-radius: 12px;
      width: 280px;
    }
    .hotspot-panel h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }
    .hotspot-panel p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .hotspot-panel img {
      width: 100%;
      border-radius: 8px;
    }
    .hotspot-panel .panel-close {
      align-self: flex-end;
      cursor: pointer;
      font-size: 18px;
      color: var(--accent);
    }
    .hotspot-panel .simulate-btn,
    .hotspot-panel .open-tab-btn {
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    /* Digital twin replicate card */
    .digital-twin-replicate {
      margin-top: 20px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      color: var(--text-muted);
    }
    .digital-twin-replicate h4 {
      margin: 0 0 8px;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }

    .case-studies {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    /* Additional spacing for the simulation case study list */
    .case-studies.simulation-case-studies {
      margin-top: 16px;
    }
    .case-card {
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
    }
    .case-card:hover { transform: translateY(-3px); }
    .case-card h4 {
      margin: 0;
      font-size: 16px;
      color: #fff;
    }
    .case-card .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .case-card .tag {
      font-size: 10px;
      padding: 3px 6px;
      background: rgba(30,41,59,0.7);
      border-radius: 6px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .case-card .outcome-bar {
      margin-top: 6px;
      display: flex;
      gap: 4px;
    }
    .case-card .outcome-segment {
      flex: 1;
      height: 6px;
      border-radius: 3px;
    }
    .outcome-cool { background: #60a5fa; }
    .outcome-energy { background: #38bdf8; }
    .outcome-co2 { background: #4ade80; }
    .outcome-euro { background: #fbbf24; }

    /* Button to replicate a case study strategy and directly load its preset */
    .case-card .replicate-btn {
      margin-top: 8px;
      display: inline-block;
      background: rgba(30, 41, 59, 0.7);
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .case-card .replicate-btn:hover {
      background: var(--accent);
      color: #000;
    }

    .timeline-section {
      margin-top: 30px;
      display: flex;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .timeline-item {
      flex: 1;
      min-width: 180px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 10px;
      padding: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .timeline-item h5 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .timeline-item span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .presets-section {
      margin-top: 30px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .preset-btn {
      flex: 1;
      min-width: 200px;
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 12px;
      padding: 16px;
      font-size: 14px;
      font-weight: 500;
      color: #e2e8f0;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .preset-btn:hover {
      background: var(--accent);
      color: #020617;
      transform: translateY(-2px);
    }

    .howto-section {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 14px;
      padding: 20px;
    }
    .howto-step {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .howto-step i {
      font-size: 24px;
      color: var(--accent);
    }
    .howto-step span {
      font-size: 14px;
      color: #e2e8f0;
      text-align: center;
    }

    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 4000;
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.35);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 550px;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* Narrower modal for timeline policy popups */
    .modal-content.policy-modal {
      max-width: 500px;
    }

    /*
     * Button and layout styles for the case studies call‑to‑action and modal
     */
    .cases-call {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 20px 0;
    }
    .cases-call .cases-note {
      font-size: 13px;
      color: var(--text-muted);
      text-align: center;
      max-width: 600px;
    }
    .open-cases-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #0f172a;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
    }
    .open-cases-btn i {
      font-size: 16px;
    }
    /* Modal layout for case study list */
    .cases-modal {
      max-width: 800px;
    }
    .case-studies-modal {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }
    .modal-content h4 {
      margin: 0;
      font-size: 20px;
      color: #fff;
    }
    .modal-content p {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    .modal-content .close-btn {
      align-self: flex-end;
      cursor: pointer;
      font-size: 20px;
      color: var(--accent);
    }
    .modal-content .steal-btn {
      margin-top: 10px;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(30,41,59,0.9);
      color: #e2e8f0;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(148,163,184,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 5000;
      font-size: 14px;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* =========================================
       INTERRELATION PANEL STYLES (ORIGINAL)
       ========================================= */
    #interrelation-panel {
      display: flex; flex-direction: column; height: 100%; padding: 12px 14px; box-sizing: border-box;
      font-family: "Inter", sans-serif; color: #e5e7eb;
    }
    #interrelation-panel * { box-sizing: border-box; }

    #interrelation-panel .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 2px 4px 0; }
    #interrelation-panel .top-title { font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; opacity: 0.95; }
    #interrelation-panel .top-title i { color: #22c55e; }
    #interrelation-panel .top-sub { font-size: 11px; color: #9ca3af; opacity: 0.9; }
    #interrelation-panel .top-actions { display: flex; gap: 8px; align-items: center; }

    #interrelation-panel .btn-reset {
      border: 1px solid rgba(148,163,184,0.4); background: rgba(15,23,42,0.7);
      color: #e5e7eb; font-size: 11px; padding: 5px 12px; border-radius: 999px;
      cursor: pointer; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
    }
    #interrelation-panel .btn-reset:hover { background: rgba(31,41,55,0.9); }

    #interrelation-panel .layout { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 14px; min-height: 0; }

    #interrelation-panel .left-panel {
      background: rgba(15, 23, 42, 0.9); border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 14px 14px 10px; display: flex; flex-direction: column; gap: 10px; min-height: 0;
    }
    #interrelation-panel .panel-caption { font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; color: #9ca3af; margin-bottom: 2px; }

    #interrelation-panel .slider-row {
      background: rgba(15,23,42,0.95); border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 8px 10px 6px; display: flex; flex-direction: column; gap: 4px;
    }
    #interrelation-panel .slider-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
    #interrelation-panel .slider-label { font-size: 12px; display: flex; align-items: center; gap: 6px; color: #e5e7eb; }
    #interrelation-panel .slider-label i { font-size: 13px; color: #a5b4fc; }
    #interrelation-panel .slider-value { font-size: 11px; color: #9ca3af; }

    #interrelation-panel input[type="range"] {
      -webkit-appearance: none; appearance: none; width: 100%; height: 5px; border-radius: 999px;
      background: rgba(75,85,99,0.45); outline: none; margin-top: 2px;
    }
    #interrelation-panel input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 14px; height: 14px; border-radius: 999px;
      background: #ffffff; border: 1px solid #4b5563; cursor: pointer; box-shadow: 0 0 0 3px rgba(59,130,246,0.25);
    }
    #interrelation-panel .slider-hint { font-size: 10px; color: #6b7280; margin-top: 2px; }

    #interrelation-panel .scenario-insights {
      margin-top: 4px; padding: 8px 9px; font-size: 11px; line-height: 1.5; border-radius: 8px;
      background: rgba(15,23,42,0.95); border: 1px dashed rgba(148,163,184,0.5); color: #d1d5db;
    }

    #interrelation-panel .right-panel {
      background: rgba(15, 23, 42, 0.9); border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.3);
      padding: 12px; display: flex; flex-direction: column; gap: 10px; min-height: 0; overflow-y: auto;
    }

    #interrelation-panel .baseline-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 8px; margin-bottom: 6px; }
    #interrelation-panel .baseline-card {
      background: rgba(15,23,42,0.95); border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 6px 8px; display: flex; flex-direction: column; gap: 2px;
    }
    #interrelation-panel .baseline-card .label { font-size: 9px; color: #9ca3af; line-height: 1.2; white-space: nowrap; }
    #interrelation-panel .baseline-card .value { font-size: 12px; font-weight: 600; color: #e5e7eb; line-height: 1.2; }

    /*
     * Make the interrelation chart grid responsive. The original layout used a fixed
     * 2×2 grid with a maximum height of 450px, which meant that additional charts
     * were pushed out of view when more than four were displayed. By using
     * auto‑fitting columns and letting the rows grow naturally, all charts remain
     * visible without manually scrolling. Overflow handling is provided by the
     * surrounding right panel.
     */
    #interrelation-panel .chart-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      overflow-y: auto;
    }
    #interrelation-panel .chart-card {
      background: rgba(15,23,42,0.95); border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.25);
      padding: 6px 8px; display: flex; flex-direction: column; min-height: 0;
    }
    #interrelation-panel .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    #interrelation-panel .chart-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.09em; color: #9ca3af; }
    #interrelation-panel .chart-tag { font-size: 10px; color: #6ee7b7; }
    #interrelation-panel .chart-wrap { flex: 1; min-height: 0; position: relative; }
    #interrelation-panel canvas { width: 100% !important; height: 100% !important; }

    /*
     * Additional styling for stakeholder benefit details. This section sits below
     * the stakeholder benefits chart and uses compact typography to convey
     * qualitative advantages for different groups. Strong tags are displayed
     * as headers and list items use small disc bullets.
     */
    .stakeholder-details {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 4px;
      line-height: 1.4;
    }
    .stakeholder-details strong {
      display: block;
      margin-top: 4px;
      color: #e5e7eb;
    }
    .stakeholder-details ul {
      padding-left: 16px;
      margin: 4px 0;
    }
    .stakeholder-details li {
      list-style-type: disc;
    }

    #interrelation-panel .summary {
      margin-top: 10px; padding: 8px 10px; background: rgba(15,23,42,0.95); border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35); display: grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap: 8px; font-size: 11px;
    }
    #interrelation-panel .summary-item { display: flex; flex-direction: column; gap: 2px; }
    #interrelation-panel .summary-label { color: #9ca3af; text-transform: uppercase; letter-spacing: 0.08em; }
    #interrelation-panel .summary-value { font-size: 13px; font-weight: 600; }
    #interrelation-panel .summary-value.positive { color: #4ade80; }
    #interrelation-panel .summary-value.negative { color: #f97373; }
    #interrelation-panel .summary-value.neutral { color: #e5e7eb; }

    #interrelation-panel.fullscreen { position: fixed; top: 10px; left: 10px; right: 10px; bottom: 10px; z-index: 10000; background: rgba(15,23,42,0.98); border-radius: 20px; border: 1px solid rgba(148, 163, 184, 0.5); box-shadow: 0 20px 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; }

    /* --- Mission control enhancements --- */
    .story-stepper {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .story-stepper .step {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      color: #e2e8f0;
      transition: background 0.2s, color 0.2s;
    }
    .story-stepper .step:hover, .story-stepper .step.active {
      background: var(--accent);
      color: #0f172a;
    }

    .resume-ribbon {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 8px 14px;
      margin-top: 16px;
      font-size: 13px;
      gap: 8px;
    }
    .resume-ribbon button {
      background: var(--accent);
      border: none;
      color: #0f172a;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .delta-chips {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .delta-chip {
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 6px;
      background: rgba(30,41,59,0.7);
      color: #fff;
    }
    .delta-chip.cool { background: #60a5fa; }
    .delta-chip.energy { background: #38bdf8; }
    .delta-chip.co2 { background: #4ade80; }
    .delta-chip.cost { background: #fbbf24; }

    .drawer .impact-preview {
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.3);
      border-radius: 8px;
      padding: 10px;
      font-size: 13px;
      color: #e2e8f0;
      margin-top: 8px;
    }
    .drawer .simulate-btn {
      margin-top: 4px;
      background: var(--accent);
      color: #0f172a;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    /* Metric tile tooltips */
    .metric-tile {
      position: relative;
    }
    .metric-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(30,41,59,0.95);
      color: #e2e8f0;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 10px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 20;
    }
    .metric-tile:hover .metric-tooltip {
      opacity: 1;
    }

    /* Hotspot flash animation for story stepper */
    .hotspot.flash {
      animation: hotspot-pulse 1s ease-in-out infinite;
    }
    @keyframes hotspot-pulse {
      0%, 100% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
    }

    /* Highlight case card during story mode */
    .case-card.highlight {
      outline: 2px solid var(--accent);
      transform: scale(1.03);
      transition: transform 0.3s, outline-color 0.3s;
    }

    .detail-overlay {
      position: fixed;
      right: 20px;
      top: 60px;
      max-width: 300px;
      background: rgba(30,41,59,0.9);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 8px;
      padding: 10px;
      color: #e2e8f0;
      z-index: 9999;
      font-size: 12px;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    /* Flashcard styling for timeline policy modal */
    .policy-modal .flashcard {
      display: block;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      color: var(--text-main);
      text-decoration: none;
      transition: background 0.2s, border-color 0.2s;
    }
    .policy-modal .flashcard h3 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
      font-weight: 600;
      color: #fff;
    }
    .policy-modal .flashcard p {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--text-muted);
    }
    .policy-modal .flashcard em {
      font-style: italic;
      color: var(--accent);
    }
    .policy-modal .flashcard:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.15);
    }
  </style>
  <style>
    /* Additional styles for role selector and settings modal */
    .settings-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative; /* allow dropdown positioning */
    }
    .settings-controls select {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
    }
    .settings-controls .settings-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--accent);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    .settings-controls .settings-btn:hover {
      background: rgba(56,189,248,0.15);
      color: var(--accent);
    }
    /* Dropdown menu for consolidated settings */
    .settings-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: none;
      flex-direction: column;
      min-width: 160px;
      z-index: 1000;
    }
    .settings-dropdown .dropdown-item {
      padding: 8px 12px;
      background: transparent;
      border: none;
      color: var(--text-main);
      text-align: left;
      font-size: 13px;
      cursor: pointer;
    }
    .settings-dropdown .dropdown-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    .settings-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2000;
    }
    .settings-modal-overlay.active {
      display: flex;
    }
    .settings-modal {
      background: #0f172a;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 80%;
      overflow-y: auto;
      color: var(--text-main);
    }
    .settings-modal h2 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .settings-modal h3 {
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: 600;
    }
    .settings-modal .field {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }
    .settings-modal label {
      font-size: 12px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    .settings-modal input[type='number'],
    .settings-modal select {
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #1e293b;
      color: var(--text-main);
      font-size: 14px;
    }
    .settings-modal .button-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 20px;
    }
    .settings-modal button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .settings-modal button.save-btn {
      background: var(--accent);
      color: #000;
    }
    .settings-modal button.cancel-btn {
      background: #1e293b;
      color: var(--text-main);
    }
    .settings-modal button.export-btn {
      background: #3b82f6;
      color: #fff;
    }
    .settings-modal .collapsible-header {
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .settings-modal .collapsible-content {
      display: none;
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-muted);
    }
    .settings-modal .collapsible-header.active + .collapsible-content {
      display: block;
    }
  </style>
</head>
<body>

  <header class="app-header">
    <div class="brand">
      <h1>Interactive Digital Twin Hub</h1>
    </div>
    <div class="nav-pills">
      <!-- Navigation buttons with translation keys -->
      <button class="nav-btn active" onclick="switchTab('panel-overview', this)" data-i18n="nav-overview">Overview</button>
      <button class="nav-btn" onclick="switchTab('panel-ecology', this)" data-i18n="nav-ecology">Ecology</button>
      <button class="nav-btn" onclick="switchTab('panel-energy', this)" data-i18n="nav-energy">Energy</button>
      <button class="nav-btn" onclick="switchTab('panel-interrelation', this)" data-i18n="nav-simulation">Combined Scenario Analysis</button>
    </div>
    <!-- Language selector -->
    <div class="lang-select-container">
      <select id="lang-select" aria-label="Select language">
        <option value="en">English</option>
        <option value="nl">Nederlands</option>
        <option value="de">Deutsch</option>
      </select>
    </div>
    <!-- Role selector and settings button -->
    <div class="settings-controls">
      <select id="role-select" aria-label="Select stakeholder role">
        <option value="planner">Municipal planner</option>
        <option value="housing">Housing corporation</option>
        <option value="community">Community group</option>
        <option value="researcher">Researcher</option>
      </select>
      <button id="settings-menu-btn" class="settings-btn"><i class="fa-solid fa-sliders"></i> Settings</button>
      <!-- Dropdown menu with sections for Energy, Ecology and Combined Scenario -->
      <div id="settings-dropdown" class="settings-dropdown">
        <button id="settings-energy" class="dropdown-item">Energy</button>
        <button id="settings-ecology" class="dropdown-item">Ecology</button>
        <button id="settings-combined" class="dropdown-item">Combined Scenario</button>
      </div>
    </div>
  </header>

  <main class="app-body">
    <div class="view-stack">

      <section class="view-panel active" id="panel-overview">
        <div class="hub-container">
          <!-- Mission briefing hero -->
          <div class="overview-hero">
            <div class="overview-hero-content">
              <!-- Updated hero copy to emphasise co‑benefits and invite exploration -->
              <h2 data-i18n="hero-title">Design a Cooler, Greener and Energy Efficient Neighbourhood</h2>
              <p data-i18n="hero-subtitle">A neighbourhood-scale digital twin to test interventions before spending millions</p>
              <div class="micro-badges">
                <div class="micro-badge"><i class="fa-solid fa-fire-flame-simple"></i> <span data-i18n="badge-heat-risk">Heat risk</span></div>
                <div class="micro-badge"><i class="fa-solid fa-bolt-lightning"></i> <span data-i18n="badge-energy-poverty">Energy poverty</span></div>
                <div class="micro-badge"><i class="fa-solid fa-screwdriver-wrench"></i> <span data-i18n="badge-retrofit-complexity">Retrofit complexity</span></div>
              </div>
              <!-- Information box for badge descriptions; initially hidden. Populated on click. Includes a close button. -->
              <div id="badge-info" class="badge-info" style="display:none;">
                <span id="badge-info-text"></span>
                <span id="badge-info-close" class="badge-info-close"><i class="fa-solid fa-xmark"></i></span>
              </div>
            </div>
          </div>
          <!-- Story stepper removed based on user feedback -->
          <!-- Resume ribbon (hidden until scenario run) -->
          <div id="resume-ribbon" class="resume-ribbon" style="display:none;">
            <span id="resume-text">Last scenario summary</span>
            <button id="resume-btn">Resume scenario</button>
          </div>
          <!-- Baseline metrics strip wrapped in a Current Condition card -->
          <div class="current-conditions">
            <h3>Current Twekkelerveld Condition</h3>
            <div class="metrics-strip">
            <div class="metric-tile" data-preset="cool" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-uhi">UHI peak (°C)</div>
              <div class="metric-value" data-target="9">0</div>
            </div>
            <div class="metric-tile" data-preset="singapore" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-ndvi">NDVI</div>
              <div class="metric-value" data-target="0.22">0</div>
            </div>
            <div class="metric-tile" data-preset="bills" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-demand">Annual demand (MWh)</div>
              <div class="metric-value" data-target="5000">0</div>
            </div>
            <div class="metric-tile" data-preset="freiburg" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-pv">PV potential (MWh)</div>
              <div class="metric-value" data-target="650">0</div>
            </div>
            <div class="metric-tile" data-preset="vienna" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-co2">CO₂ (kt/yr)</div>
              <div class="metric-value" data-target="1.8">0</div>
            </div>
            <div class="metric-tile" data-preset="vienna" data-tab="panel-interrelation">
            <div class="metric-label" data-i18n="metric-vulnerable">Vulnerable HH (%)</div>
              <div class="metric-value" data-target="30">0</div>
            </div>
            </div>
          </div>
          <!-- Why Twekkelerveld? section -->
          <div class="why-section">
            <div class="why-map">
              <img src="Study Area.png" alt="Twekkelerveld Map">
              <!-- Hotspot dots removed based on user feedback; clickable list items below trigger the same events. -->
              <!-- <div class="hotspot" style="top: 32%; left: 42%;" data-spot="housing" title="Housing"></div> -->
              <!-- <div class="hotspot" style="top: 60%; left: 25%;" data-spot="industry" title="Industry edge"></div> -->
              <!-- <div class="hotspot" style="top: 45%; left: 75%;" data-spot="green" title="Green corridors"></div> -->
            </div>
            <div class="why-info">
              <h3 data-i18n="why-heading">Why Twekkelerveld?</h3>
              <ul>
                <li data-i18n="why-bullet-1">Mixed building stock → retrofit tradeoffs are real.</li>
                <li data-i18n="why-bullet-2">Heat + energy affordability collide here.</li>
                <li data-i18n="why-bullet-3">Perfect scale: neighbourhood interventions actually measurable.</li>
              </ul>
              <!-- Explicit list of neighbourhood hotspots replaces the ambiguous dots on the map -->
              <div class="neighbourhood-hotspots">
                <h4>Neighbourhood Hotspots</h4>
                <ul>
                  <li><button class="hotspot-link" data-spot="green">Green Corridor</button></li>
                  <li><button class="hotspot-link" data-spot="housing">Housing Hotspot</button></li>
                  <li><button class="hotspot-link" data-spot="industry">Industrial edge</button></li>
                </ul>
              </div>
            </div>
            <!-- Inline hotspot panel: appears beside the map when a hotspot is clicked -->
            <div id="hotspot-panel" class="hotspot-panel">
              <div class="panel-close"><i class="fa-solid fa-xmark"></i></div>
              <h4 id="hotspot-panel-title" data-i18n="location-details">Location details</h4>
              <img id="hotspot-panel-image" src="" alt="">
              <p id="hotspot-panel-desc"></p>
              <div id="hotspot-panel-preview" class="impact-preview"></div>
              <button class="simulate-btn" id="hotspot-panel-simulate-btn" data-i18n="simulate-btn">Simulate this hotspot</button>
              <button class="open-tab-btn" id="hotspot-panel-open-btn" data-i18n="open-tab-btn">Open tab</button>
            </div>
          </div>
          <!-- Case studies call-to-action. Clicking the button opens a modal with all global case studies. -->
          <div class="cases-call">
            <button id="open-cases-btn" class="open-cases-btn" onclick="document.getElementById('modal-overlay').classList.add('active')">
              <i class="fa-solid fa-book-open"></i>
              <span data-i18n="cases-call-btn">Explore global case studies</span>
            </button>
            <p class="cases-note" data-i18n="cases-call-note">Learn from international examples on cooling, energy, retrofits and community solar.</p>
          </div>
          <!-- Timeline -->
          <div class="timeline-section">
            <div class="timeline-item" data-link="#policy-now">
              <h5 data-i18n="timeline-now">Now</h5>
              <span data-i18n="timeline-now-desc">Hotter summers, rising bills.</span>
            </div>
            <div class="timeline-item" data-link="#policy-2027">
              <h5>2027</h5>
              <span data-i18n="timeline-2027-desc">Grid pressure + retrofit targets.</span>
            </div>
            <div class="timeline-item" data-link="#policy-2030">
              <h5>2030</h5>
              <span data-i18n="timeline-2030-desc">Policy deadlines (EU targets).</span>
            </div>
            <div class="timeline-item" data-link="#policy-2050">
              <h5>2050</h5>
              <span data-i18n="timeline-2050-desc">Climate baseline shift.</span>
            </div>
          </div>
          <!-- Hidden policy flashcards that populate the timeline modal.
               Each card contains a brief description and links to an external policy document.
               They remain hidden on the page but are loaded into the modal when the corresponding
               timeline item is clicked. -->
          <div class="policy-flashcards" style="display:none;">
            <div id="policy-now">
              <a href="https://climate.ec.europa.eu/eu-action/climate-strategies-targets_en" target="_blank" class="flashcard">
                <h3>Now</h3>
                <p>Hotter summers and rising bills are already impacting daily life. Current policies focus on adaptation and affordability.</p>
                <p><em>Click this card to open the relevant policy document.</em></p>
              </a>
            </div>
            <div id="policy-2027">
              <a href="https://energy.ec.europa.eu/topics/renewable-energy/renewable-energy-directive_en" target="_blank" class="flashcard">
                <h3>2027</h3>
                <p>Grid pressure and building retrofit targets become critical by 2027. Policies outline steps for infrastructure upgrades and efficiency.</p>
                <p><em>Click this card to open the relevant policy document.</em></p>
              </a>
            </div>
            <div id="policy-2030">
              <a href="https://climate.ec.europa.eu/eu-action/climate-strategies-targets/2030-climate-targets_en" target="_blank" class="flashcard">
                <h3>2030</h3>
                <p>EU policy deadlines and climate targets for 2030 set ambitious milestones for emissions reduction and renewable energy.</p>
                <p><em>Click this card to open the relevant policy document.</em></p>
              </a>
            </div>
            <div id="policy-2050">
              <a href="https://climate.ec.europa.eu/eu-action/climate-strategies-targets/2050-long-term-strategy_en" target="_blank" class="flashcard">
                <h3>2050</h3>
                <p>Long‑term climate baselines shift dramatically by 2050. Strategies focus on achieving net‑zero emissions and resilience.</p>
                <p><em>Click this card to open the relevant policy document.</em></p>
              </a>
            </div>
          </div>
          <!-- Predefined scenarios -->
          <div class="predefined-scenarios">
            <h3>Predefined Scenarios</h3>
            <div class="presets-section">
              <div class="preset-btn" data-preset="cool" data-i18n="preset-cool">Urban heat reduction</div>
              <div class="preset-btn" data-preset="bills" data-i18n="preset-bills">Reduce energy bills</div>
              <div class="preset-btn" data-preset="stress" data-i18n="preset-stress">2050 heat stress test</div>
            </div>
          </div>
          <!-- How to use section removed based on user feedback -->
          <!-- Current digital twin situation card with expandable info -->
          <div id="digital-twin-replicate" class="digital-twin-replicate">
            <h4>
              <span data-i18n="replicate-title">Current Digital Twin Situation</span>
              <i id="digital-twin-info-btn" class="fa-solid fa-circle-info"></i>
            </h4>
            <div id="digital-twin-info" class="digital-twin-info" style="display:none;">
              <p id="digital-twin-replicate-message"></p>
              <div class="digital-twin-actions">
                <button class="pill-btn" data-tab="panel-ecology"><i class="fa-solid fa-tree"></i> Explore Ecology map</button>
                <button class="pill-btn" data-tab="panel-energy"><i class="fa-solid fa-bolt"></i> Explore Energy map</button>
                <button class="pill-btn" data-tab="panel-interrelation"><i class="fa-solid fa-flask"></i> Combine in Simulation</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Side drawer for hotspots -->
        <div id="drawer" class="drawer">
          <div class="drawer-close"><i class="fa-solid fa-xmark"></i></div>
          <h4 id="drawer-title">Location details</h4>
          <img id="drawer-image" src="" alt="">
          <p id="drawer-description"></p>
          <div id="drawer-preview" class="impact-preview"></div>
          <button class="simulate-btn" id="drawer-simulate-btn">Simulate this hotspot</button>
          <button class="open-tab-btn" id="drawer-open-btn">Open tab</button>
        </div>
          <!-- Removed timeline policy descriptions to streamline the interface. -->

          <!-- Modal for global case studies. Hidden by default; becomes visible when user clicks the call‑to‑action button. -->
        <div id="modal-overlay" class="modal-overlay">
          <div class="modal-content cases-modal">
            <!-- Close button for the modal -->
            <div class="close-btn" id="cases-close-btn" onclick="document.getElementById('modal-overlay').classList.remove('active')"><i class="fa-solid fa-xmark"></i></div>
            <h4>Global case studies</h4>
            <p>Learn from diverse cities implementing cooling measures, solar power, deep retrofits and community‑driven initiatives. Click any card below to open the full report.</p>
            <div class="case-studies-modal">
              <div class="case-card" data-case="rotterdam">
                <h4>Rotterdam — Adaptation &amp; green roofs</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Nature‑based</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:2"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:1"></div>
                  <div class="outcome-segment outcome-euro" style="flex:1"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="rotterdam" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
              <div class="case-card" data-case="freiburg">
                <h4>Freiburg — Solar Settlement</h4>
                <div class="tags">
                  <span class="tag">PV</span>
                  <span class="tag">Energy</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:3"></div>
                  <div class="outcome-segment outcome-co2" style="flex:1"></div>
                  <div class="outcome-segment outcome-euro" style="flex:1"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="freiburg" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
              <div class="case-card" data-case="vienna">
                <h4>Vienna — Smart City Baumgarten</h4>
                <div class="tags">
                  <span class="tag">Retrofit</span>
                  <span class="tag">Finance</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:2"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:3"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="vienna" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
              <div class="case-card" data-case="singapore">
                <h4>Singapore — vertical greening</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Nature‑based</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:3"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="singapore" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
              <div class="case-card" data-case="barcelona">
                <h4>Barcelona — climate shelter schools</h4>
                <div class="tags">
                  <span class="tag">Cooling</span>
                  <span class="tag">Retrofit</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:2"></div>
                  <div class="outcome-segment outcome-energy" style="flex:1"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="barcelona" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
              <div class="case-card" data-case="paris">
                <h4>Paris — community solar cooperative</h4>
                <div class="tags">
                  <span class="tag">PV</span>
                  <span class="tag">Community</span>
                </div>
                <div class="outcome-bar">
                  <div class="outcome-segment outcome-cool" style="flex:1"></div>
                  <div class="outcome-segment outcome-energy" style="flex:3"></div>
                  <div class="outcome-segment outcome-co2" style="flex:2"></div>
                  <div class="outcome-segment outcome-euro" style="flex:2"></div>
                </div>
                <div class="delta-chips"></div>
                <button class="replicate-btn" data-case="paris" data-i18n="replicate-btn">Replicate this strategy</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Additional modal for timeline policy popups -->
        <div id="timeline-modal" class="modal-overlay">
          <div class="modal-content policy-modal">
            <!-- Close button for the timeline modal -->
            <div class="close-btn" id="timeline-close-btn"><i class="fa-solid fa-xmark"></i></div>
            <div id="timeline-modal-content"></div>
          </div>
        </div>
      </section>

      <section class="view-panel" id="panel-ecology">
        <div class="panel-toolbar">
          <span><span class="dot"></span>Ecology Digital Twin • Twekkelerveld</span>
          <span>Sources: Landsat 9 · BGT · AHN · KNMI</span>
        </div>
        <div class="panel-iframe-wrapper">
          <!-- Assign an explicit ID so scripts can address the ecology frame for messaging -->
          <iframe id="ecoFrame" src="ecology.html"></iframe>
        </div>
      </section>

      <section class="view-panel" id="panel-energy">
        <div class="panel-toolbar">
          <span><span class="dot"></span>Energy Digital Twin • Twekkelerveld</span>
          <span>Sources: Enexis · Zonnedakje · BAG · CO₂ factors</span>
        </div>
        <div class="panel-iframe-wrapper">
          <!-- Assign an explicit ID so scripts can address the energy frame for messaging -->
          <iframe id="energyFrame" src="energy.html"></iframe>
        </div>
      </section>

      <section class="view-panel" id="panel-interrelation">
        <div id="interrelation-panel">
          <div class="top-row">
            <div>
              <div class="top-title">
                <i class="fa-solid fa-diagram-project"></i> Combined Scenario Analysis
              </div>
              <div class="top-sub">
                Simulate trees, PV, retrofits and green roofs to see how ecological and energy interventions work together, impacting greenness, heat, energy use, CO₂ and cost.
              </div>
            </div>
            <div class="top-actions">
              <button class="btn-reset" id="IR_btnReset"><i class="fa-solid fa-rotate-left"></i> Reset</button>
              <button class="btn-reset" id="IR_btnPdf"><i class="fa-solid fa-file-arrow-down"></i> Download scenario PDF</button>
              <button class="btn-reset" id="IR_btnFullscreen"><i class="fa-solid fa-up-right-and-down-left-from-center"></i> Full screen</button>
              <!-- Pin buttons removed: comparison scenarios are no longer supported -->
              <button class="btn-reset" id="IR_btnCopy"><i class="fa-solid fa-link"></i> Copy link</button>
              <button class="btn-reset" id="IR_btnSave"><i class="fa-solid fa-download"></i> Save JSON</button>
              <button class="btn-reset" id="IR_btnLoad"><i class="fa-solid fa-upload"></i> Load JSON</button>
              <input type="file" id="IR_fileInput" style="display:none;" accept="application/json" />
            </div>
          </div>

          <div class="layout">
            <div class="left-panel">
              <div class="panel-caption">Scenario settings</div>
              
              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-leaf"></i> <span>Additional trees</span></div>
                  <div class="slider-value"><span id="IR_treesValue">0</span> trees</div>
                </div>
                <input id="IR_sliderTrees" type="range" min="0" max="1500" step="50" value="0">
                <div class="slider-hint">Trees sequester ~20kg CO₂ per year and cost ~€350 each.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-solar-panel"></i> <span>Extra rooftop PV</span></div>
                  <div class="slider-value">+<span id="IR_pvValue">0</span>% PV capacity</div>
                </div>
                <input id="IR_sliderPV" type="range" min="0" max="100" step="5" value="0">
                <div class="slider-hint">Relative to current PV potential. Cost ~€5,400 per +1%.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-house"></i> <span>Insulated buildings</span></div>
                  <div class="slider-value"><span id="IR_retroValue">0</span>% of stock</div>
                </div>
                <input id="IR_sliderRetro" type="range" min="0" max="80" step="5" value="0">
                <div class="slider-hint">Approx. 25–30% energy savings at 80% stock insulated.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-temperature-high"></i> <span>Heatwave severity</span></div>
                  <div class="slider-value">Level <span id="IR_heatValue">0</span></div>
                </div>
                <input id="IR_sliderHeat" type="range" min="0" max="3" step="1" value="0">
                <div class="slider-hint">0 = normal summer, 3 = extreme heatwave.</div>
              </div>

              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-seedling"></i> <span>Green roof coverage</span></div>
                  <div class="slider-value"><span id="IR_greenRoofValue">0</span>% of roofs</div>
                </div>
                <input id="IR_sliderGreenRoof" type="range" min="0" max="100" step="10" value="0">
                <div class="slider-hint">Vegetated roofs insulate buildings and provide shade.</div>
              </div>

              <!-- Budget slider and optimizer -->
              <div class="slider-row">
                <div class="slider-top">
                  <div class="slider-label"><i class="fa-solid fa-euro-sign"></i> <span>Budget</span></div>
                  <div class="slider-value">€<span id="IR_budgetValue">0</span></div>
                </div>
                <input id="IR_sliderBudget" type="range" min="0" max="2000000" step="50000" value="0">
                <div class="slider-hint">Maximum investment budget to optimize scenario.</div>
              </div>
              <div class="slider-row" style="text-align:center;">
                <button class="open-tab-btn" id="IR_btnOptimize">Maximize Score</button>
              </div>

              <div class="scenario-insights" id="IR_scenarioInsights">
                Baseline metrics: NDVI ~0.22, UHI ~9°C, energy ~5GWh. Adjust sliders to see impacts.
              </div>
            </div>

            <div class="right-panel">
              <div class="baseline-grid">
                <div class="baseline-card"><div class="label">NDVI (base)</div><div class="value">0.22</div></div>
                <div class="baseline-card"><div class="label">UHI (base)</div><div class="value">9 °C</div></div>
                <div class="baseline-card"><div class="label">Energy</div><div class="value">5,000 MWh</div></div>
                <div class="baseline-card"><div class="label">PV Pot.</div><div class="value">650 MWh</div></div>
                <div class="baseline-card"><div class="label">CO₂</div><div class="value">1.8 kt</div></div>
                <div class="baseline-card"><div class="label">Trees</div><div class="value">2,400</div></div>
              </div>

              <div class="chart-grid">
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Greenness (NDVI)</div><div class="chart-tag" id="IR_ndviTag">Base ~0.22</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartNdvi"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Urban heat (°C)</div><div class="chart-tag" id="IR_uhiTag">Base ~9 °C</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartUhi"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Energy & PV</div><div class="chart-tag" id="IR_energyTag">MWh/yr</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartEnergy"></canvas></div>
                </div>
                <div class="chart-card">
                  <div class="chart-header"><div class="chart-title">Overall balance</div><div class="chart-tag">Score</div></div>
                  <div class="chart-wrap"><canvas id="IR_chartRadar"></canvas></div>
                </div>
                <!-- New stakeholder benefits chart shows how citizens and planners each gain from the current scenario.  -->
                <div class="chart-card">
                  <div class="chart-header">
                    <div class="chart-title">Stakeholder benefits</div>
                    <div class="chart-tag">Score</div>
                  </div>
                  <div class="chart-wrap"><canvas id="IR_chartStakeholders"></canvas></div>
                  <!-- Add explanatory bullet lists to make stakeholder benefits easier to understand -->
                  <div class="stakeholder-details">
                    <strong><i class="fa-solid fa-house-user"></i> Residents</strong>
                    <ul>
                      <li>Cooler summers and improved health through more trees and green roofs</li>
                      <li>Lower utility bills thanks to rooftop solar and deep retrofits</li>
                    </ul>
                    <strong><i class="fa-solid fa-city"></i> City planners</strong>
                    <ul>
                      <li>Progress towards climate targets with lower CO₂ emissions</li>
                      <li>Greater resilience and social equity for the neighbourhood</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="summary">
            <div class="summary-item">
              <div class="summary-label">Greener</div><div class="summary-value positive" id="IR_summaryGreen">+0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Cooler (UHI)</div><div class="summary-value positive" id="IR_summaryCool">-0.0 °C</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Energy demand</div><div class="summary-value positive" id="IR_summaryEnergy">-0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">CO₂ balance</div><div class="summary-value positive" id="IR_summaryCO2">-0%</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Total cost</div><div class="summary-value neutral" id="IR_summaryCost">€0</div>
            </div>
            <div class="summary-item">
              <div class="summary-label">Protected HH</div><div class="summary-value positive" id="IR_summaryEquity">0%</div>
            </div>
          </div>

          <!--
            Added equations/assumptions info section to make the combined scenario more transparent.
            This collapsible panel lists the formulas used for key metrics, explains parameter meanings,
            outlines default cost assumptions and highlights how energy and ecology measures interact.
          -->
          <details class="equations-info" style="margin-top: 20px; background: rgba(15,23,42,0.85); border: 1px solid var(--border); border-radius: 8px; padding: 16px;">
            <summary style="cursor:pointer; font-size: 14px; font-weight: 600; color: var(--accent);">
              <i class="fa-solid fa-circle-info"></i> Equations &amp; assumptions
            </summary>
            <div style="margin-top: 10px; font-size: 13px; line-height: 1.5; color: var(--text-muted);">
              <p><strong>Energy cost:</strong> (gas consumption × price<sub>gas</sub>) + (imported electricity × price<sub>elec</sub>) − (exported electricity × feed‑in tariff).</p>
              <p><strong>CO₂ savings:</strong> (baseline energy − new energy) × emission factor.</p>
              <p><strong>Benefit–cost analysis:</strong> Net present value (NPV) = Σ (cash flow ÷ (1&nbsp;+&nbsp;discount&nbsp;rate)<sup>year</sup>) − capital cost; Benefit–cost ratio (BCR) = NPV of benefits ÷ NPV of costs.</p>
              <p><strong>Tree carbon sequestration:</strong> Each additional tree is assumed to absorb ~10 kg of CO₂ per year and provides shade and cooling benefits.</p>
              <p><strong>Green roofs &amp; vegetation:</strong> Vegetation and green roofs help cool buildings and neighborhoods by shading surfaces, deflecting solar radiation and releasing moisture.</p>
              <p><strong>PV costs:</strong> High‑efficiency PV modules are about €0.115 per Wp; the slider's default of €5,400 per +1 % PV capacity is based on typical installed costs.</p>
              <p><strong>Default parameter values:</strong> Tree cost €350 per tree; PV cost €5,400 per +1 % capacity; retrofit cost €12,000 per dwelling; green roof cost €8,000 per +10 % roof coverage.</p>
              <p>These formulas and assumptions show how ecological (trees, green roofs) and energy (PV, retrofits) interventions interact. More trees and green roofs increase greenness and reduce urban heat, while PV and insulation reduce energy use and emissions. The combined scenario score weighs these co‑benefits against investment and space budgets over your selected time horizon.</p>
              <p><em>Sources:</em> 
                <a href="https://www.investopedia.com/terms/n/npv.asp" target="_blank">Investopedia – NPV formula</a>; 
                <a href="https://www.investopedia.com/terms/b/bcr.asp" target="_blank">Investopedia – BCR</a>; 
                <a href="https://onetreeplanted.org/blogs/stories/how-much-co2-does-tree-absorb" target="_blank">One Tree Planted – tree CO₂ absorption</a>; 
                <a href="https://www.epa.gov/green-infrastructure/reduce-heat-islands" target="_blank">US EPA – heat‑island benefits of vegetation</a>; 
                <a href="https://www.rinnovabili.net/business/energy/photovoltaic-module-prices-2025-updated-data/" target="_blank">Rinnovabili – PV module prices</a>.
              </p>
            </div>
          </details>

        </div>
      </section>

    </div>
  </main>

  <!-- Removed scenario detail overlays as comparison pins are no longer supported -->

  <script>
    // --- Tab Switching Logic ---
    window.switchTab = function(targetId, btn) {
      if(btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        document.querySelectorAll('.nav-btn').forEach(b => {
          if(b.onclick.toString().includes(targetId)) {
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            b.classList.add('active');
          }
        });
      }

      document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(targetId).classList.add('active');

      // Initialize interrelation on tab switch if not already done
      if (targetId === "panel-interrelation" && window.IR_init && !window.__IR_initialized) {
        window.IR_init();
      }
    };

    /*
      Define a global baseline object and helper functions so that metrics can be computed
      outside of the simulation tab. These functions replicate the core logic from
      IR_computeScenario but operate on arbitrary configuration objects. They are used
      to provide previews on the overview page, compute deltas for case studies,
      store last scenarios, and enable budget optimisations without requiring
      the interrelation panel to be initialised.
    */
    // Global baseline values accessible outside IR_init
    window.IR_BASE_GLOBAL = {
      trees_existing: 2400,
      co2_tree_kg_year: 20,
      ndvi_mean: 0.22,
      uhi_mean: 9.0,
      energy_kwh: 5_000_000,
      pv_kwh: 650_000,
      co2_kg: 1_800_000,
      cost_tree_eur: 350,
      cost_pv_per_pct_eur: 5400,
      dwellings: 2500,
      retrofit_cost_per_dwelling_eur: 12000,
      cost_greenRoof_per_pct_eur: 8000,
      vulnerable_pct: 30
    };

    // Compute a scenario object from a configuration
    window.computeScenario = function(config) {
      const IR = window.IR_BASE_GLOBAL;
      config = config || {};
      const treesAdded = parseInt(config.trees || 0, 10);
      const pvExtraPct = parseInt(config.pv || 0, 10);
      const retroPct = parseInt(config.retro || 0, 10);
      const heatLevel = parseInt(config.heat || 0, 10);
      const greenRoofPct = parseInt(config.green || 0, 10);

      const ndviIncreaseTrees = Math.min(0.06, (treesAdded / 1500) * 0.06);
      const ndviIncreaseGreen = (greenRoofPct / 100) * 0.04;
      const ndviScenario = IR.ndvi_mean + ndviIncreaseTrees + ndviIncreaseGreen;

      const uhiHeatUp = heatLevel * 1.5;
      const uhiTreeCool = (treesAdded / 300) * 0.1;
      const uhiRetroCool = (retroPct / 100) * 0.8;
      const uhiGreenCool = (greenRoofPct / 100) * 1.0;
      const uhiPVcool = (pvExtraPct / 100) * 0.7;
      const treeShadePVLoss = Math.min(0.5, (treesAdded / 1500) * 0.5);

      let uhiScenario = IR.uhi_mean + uhiHeatUp - uhiTreeCool - uhiRetroCool - uhiGreenCool - uhiPVcool;
      if (uhiScenario < 0) uhiScenario = 0;

      const maxSavingsFraction = 0.25;
      const savingsFrac = (retroPct / 80) * maxSavingsFraction;
      let energyScenario_kwh = IR.energy_kwh * (1 - Math.min(savingsFrac, maxSavingsFraction));
      energyScenario_kwh *= (1 + (uhiScenario - IR.uhi_mean) * 0.02);
      energyScenario_kwh *= (1 - (greenRoofPct / 100) * 0.10);
      if (energyScenario_kwh < 0) energyScenario_kwh = 0;

      const pvScenario_kwh = IR.pv_kwh * (1 + pvExtraPct / 100) * (1 - treeShadePVLoss);
      const netGridScenario_kwh = energyScenario_kwh - pvScenario_kwh;

      const co2FromEnergy = IR.co2_kg * (energyScenario_kwh / IR.energy_kwh);
      const co2FromTrees = treesAdded * IR.co2_tree_kg_year;
      let co2Scenario_kg = co2FromEnergy - co2FromTrees;
      if (co2Scenario_kg < 0) co2Scenario_kg = 0;

      const greenScore = Math.min(100, 40 + ((ndviScenario - IR.ndvi_mean) / 0.06) * 40);
      const coolScore = Math.min(100, 40 + (uhiHeatUp > 0 ? 0 : 10) + (uhiTreeCool + uhiRetroCool + uhiGreenCool) * 8);
      const energyScore = Math.min(100, 40 + ((IR.energy_kwh - energyScenario_kwh) / IR.energy_kwh) * 60);
      const co2Score = Math.min(100, 40 + ((IR.co2_kg - co2Scenario_kg) / IR.co2_kg) * 60);

      const treeCost = treesAdded * IR.cost_tree_eur;
      const pvCost = pvExtraPct * IR.cost_pv_per_pct_eur;
      const dwellingsInsulated = IR.dwellings * (retroPct / 100);
      const retrofitCost = dwellingsInsulated * IR.retrofit_cost_per_dwelling_eur;
      const greenRoofCost = greenRoofPct * IR.cost_greenRoof_per_pct_eur;
      const totalCost = treeCost + pvCost + retrofitCost + greenRoofCost;

      const totalVulnerable = IR.dwellings * (IR.vulnerable_pct / 100);
      const protectedHH = totalVulnerable * (retroPct / 100);
      const equityPct = totalVulnerable ? (protectedHH / totalVulnerable) * 100 : 0;

      return {
        treesAdded, pvExtraPct, retroPct, heatLevel, greenRoofPct,
        ndviScenario, uhiScenario, energyScenario_kwh, pvScenario_kwh, netGridScenario_kwh,
        co2Scenario_kg, greenScore, coolScore, energyScore, co2Score,
        treeCost, pvCost, retrofitCost, greenRoofCost, totalCost,
        protectedHH, equityPct, treeShadePVLoss
      };
    };

    // Compute percentage deltas relative to baseline
    window.computeDeltas = function(s) {
      const IR = window.IR_BASE_GLOBAL;
      const greenPct = (s.ndviScenario / IR.ndvi_mean - 1) * 100;
      const energyPct = (1 - s.energyScenario_kwh / IR.energy_kwh) * 100;
      const co2Pct = (1 - s.co2Scenario_kg / IR.co2_kg) * 100;
      const uhiDelta = IR.uhi_mean - s.uhiScenario;
      const equityPct = s.equityPct || 0;
      return { greenPct, energyPct, co2Pct, uhiDelta, equityPct };
    };

    // Helper to get configuration object from preset name
    window.getConfigForPreset = function(name) {
      if (typeof name === 'object' && name !== null) return name;
      let config = {};
      if (name === 'cool') {
        config = { trees: 700, pv: 0, retro: 0, heat: 1, green: 40 };
      } else if (name === 'bills') {
        config = { trees: 0, pv: 20, retro: 50, heat: 0, green: 0 };
      } else if (name === 'stress') {
        config = { trees: 0, pv: 0, retro: 0, heat: 3, green: 0 };
      } else if (window.caseData && window.caseData[name] && window.caseData[name].preset) {
        config = Object.assign({}, window.caseData[name].preset);
      } else {
        config = {};
      }
      return config;
    };

    // ============================================
    // INTERRELATION LOGIC (Original Untouched)
    // ============================================
    window.IR_init = function() {
      if (window.__IR_initialized) return;
      window.__IR_initialized = true;

      // Use baseline values from the global object defined in the mission control enhancements.  
      // Use a reference to the global baseline so updates to settings propagate into scenario computations.
      // Reference the global baseline object instead of cloning it.  
      // This ensures that updates made via the settings modal propagate to scenario computations.
      const IR_BASE = window.IR_BASE = window.IR_BASE_GLOBAL;

      // Full screen toggle logic
      (function() {
        var fullBtn = document.getElementById('IR_btnFullscreen');
        if (fullBtn) {
          fullBtn.addEventListener('click', function() {
            var panel = document.getElementById('interrelation-panel');
            if (panel) {
              panel.classList.toggle('fullscreen');
            }
          });
        }
      })();

      const IR_BASE_netGrid_kwh = IR_BASE.energy_kwh - IR_BASE.pv_kwh;
      const elTrees = document.getElementById("IR_sliderTrees");
      const elPV = document.getElementById("IR_sliderPV");
      const elRetro = document.getElementById("IR_sliderRetro");
      const elHeat = document.getElementById("IR_sliderHeat");
      const elGreenRoof = document.getElementById("IR_sliderGreenRoof");
      const elBudget = document.getElementById("IR_sliderBudget");
      const labelBudget = document.getElementById("IR_budgetValue");
      const elReset = document.getElementById("IR_btnReset");
      const elPdf = document.getElementById("IR_btnPdf");
      const btnPinA = document.getElementById("IR_btnPinA");
      const btnPinB = document.getElementById("IR_btnPinB");
      const btnCopy = document.getElementById("IR_btnCopy");
      const btnSave = document.getElementById("IR_btnSave");
      const btnLoad = document.getElementById("IR_btnLoad");
      const fileInput = document.getElementById("IR_fileInput");
      const btnOptimize = document.getElementById("IR_btnOptimize");

      const labelTrees = document.getElementById("IR_treesValue");
      const labelPV = document.getElementById("IR_pvValue");
      const labelRetro = document.getElementById("IR_retroValue");
      const labelHeat = document.getElementById("IR_heatValue");
      const labelGreenRoof = document.getElementById("IR_greenRoofValue");

      const summaryGreen = document.getElementById("IR_summaryGreen");
      const summaryCool = document.getElementById("IR_summaryCool");
      const summaryEnergy = document.getElementById("IR_summaryEnergy");
      const summaryCO2 = document.getElementById("IR_summaryCO2");
      const summaryCost = document.getElementById("IR_summaryCost");
      const summaryEquity = document.getElementById("IR_summaryEquity");
      const insightsBox = document.getElementById("IR_scenarioInsights");

      const ctxNdvi = document.getElementById("IR_chartNdvi").getContext("2d");
      const ctxUhi = document.getElementById("IR_chartUhi").getContext("2d");
      const ctxEnergy = document.getElementById("IR_chartEnergy").getContext("2d");
      const ctxRadar = document.getElementById("IR_chartRadar").getContext("2d");

      Chart.defaults.font.family = "Inter, system-ui, sans-serif";
      Chart.defaults.color = "#9ca3af";
      // Improve chart appearance: set default font size, legend position and style
      Chart.defaults.font.size = 10;
      Chart.defaults.plugins.legend.position = 'bottom';
      Chart.defaults.plugins.legend.labels.usePointStyle = true;
      Chart.defaults.plugins.legend.labels.boxWidth = 10;
      // Smooth radar lines
      Chart.defaults.elements.line.tension = 0.3;

      const IR_chartNdvi = new Chart(ctxNdvi, {
        type: "bar",
        data: {
          labels: ["Baseline", "Scenario"],
          datasets: [
            // Show a single baseline bar and a single scenario bar by using zero for the other position
            { label: "Baseline", data: [IR_BASE.ndvi_mean, 0], backgroundColor: "rgba(148,163,184,0.6)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario", data: [0, IR_BASE.ndvi_mean], backgroundColor: "rgba(34,197,94,0.8)", borderRadius: 6, maxBarThickness: 30 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { font: { size: 8 } } } }, scales: { y: { suggestedMin: 0, suggestedMax: 0.45, ticks: { stepSize: 0.1 } } } }
      });

      const IR_chartUhi = new Chart(ctxUhi, {
        type: "bar",
        data: {
          labels: ["Baseline", "Scenario"],
          datasets: [
            // Show baseline value only for the Baseline label and zero for Scenario; scenario dataset vice versa
            { label: "Baseline", data: [IR_BASE.uhi_mean, 0], backgroundColor: "rgba(148,163,184,0.6)", borderRadius: 6, maxBarThickness: 30 },
            { label: "Scenario", data: [0, IR_BASE.uhi_mean], backgroundColor: "rgba(239,68,68,0.85)", borderRadius: 6, maxBarThickness: 30 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, labels: { font: { size: 8 } } } }, scales: { y: { suggestedMin: 0, suggestedMax: 18, ticks: { stepSize: 3 } } } }
      });

      const IR_chartEnergy = new Chart(ctxEnergy, {
        type: "bar",
        data: {
          labels: ["Demand", "PV / Generation", "Net grid"],
          datasets: [
            { label: "Baseline", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(148,163,184,0.6)", borderRadius: 6, maxBarThickness: 26 },
            { label: "Scenario", data: [IR_BASE.energy_kwh / 1000, IR_BASE.pv_kwh / 1000, IR_BASE_netGrid_kwh / 1000], backgroundColor: "rgba(59,130,246,0.85)", borderRadius: 6, maxBarThickness: 26 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { boxWidth: 12, boxHeight: 12, font: { size: 8 } } } }, scales: { x: { stacked: false }, y: { stacked: false, ticks: { callback: v => v.toLocaleString() } } } }
      });

      const IR_chartRadar = new Chart(ctxRadar, {
        type: "radar",
        data: {
          labels: ["Greenness", "Cooling", "Energy", "CO₂"],
          datasets: [
            { label: "Baseline", data: [40, 40, 40, 40], borderColor: "rgba(148,163,184,1)", backgroundColor: "rgba(148,163,184,0.15)", borderWidth: 1, pointRadius: 3 },
            { label: "Scenario", data: [40, 40, 40, 40], borderColor: "rgba(34,197,94,1)", backgroundColor: "rgba(34,197,94,0.3)", borderWidth: 1.5, pointRadius: 3 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { font: { size: 8 } } } }, scales: { r: { suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, grid: { color: "rgba(148,163,184,0.3)" }, angleLines: { color: "rgba(148,163,184,0.3)" } } } }
      });

      // -------------------------------------------
      // Stakeholder benefits chart initialisation
      // This horizontal bar chart illustrates how citizens and planners derive benefits
      // from the current scenario. Scores are computed dynamically in IR_updateUI.
      const ctxStakeholders = document.getElementById("IR_chartStakeholders").getContext("2d");
      const IR_chartStakeholders = new Chart(ctxStakeholders, {
        type: "bar",
        data: {
          labels: ["Citizens", "Planners"],
          datasets: [
            {
              label: "Benefit Score",
              data: [40, 40],
              backgroundColor: ["rgba(253,186,116,0.8)", "rgba(167,139,250,0.8)"],
              borderRadius: 6,
              maxBarThickness: 30
            }
          ]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { suggestedMin: 0, suggestedMax: 100 } }
        }
      });

      // Attach click handlers to the charts to display details when clicked
      function attachChartClick(chart, type) {
        chart.options.onClick = function() {
          const s = (typeof IR_computeScenario === 'function') ? IR_computeScenario() : null;
          let message = '';
          if (type === 'ndvi') {
            const base = IR_BASE.ndvi_mean;
            const scen = s ? s.ndviScenario : base;
            const diff = scen - base;
            message = `NDVI baseline ${base.toFixed(2)}, scenario ${scen.toFixed(2)} (∆ ${(diff>=0?'+':'')}${diff.toFixed(2)})`;
          } else if (type === 'uhi') {
            const base = IR_BASE.uhi_mean;
            const scen = s ? s.uhiScenario : base;
            const diff = base - scen;
            message = `UHI baseline ${base.toFixed(1)}°C, scenario ${scen.toFixed(1)}°C (cooling ${(diff>=0?'+':'')}${diff.toFixed(1)}°C)`;
          } else if (type === 'energy') {
            if (s) {
              const baseDemand = IR_BASE.energy_kwh/1000;
              const scenDemand = s.energyScenario_kwh/1000;
              const basePV = IR_BASE.pv_kwh/1000;
              const scenPV = s.pvScenario_kwh/1000;
              const baseNet = (IR_BASE.energy_kwh - IR_BASE.pv_kwh)/1000;
              const scenNet = s.netGridScenario_kwh/1000;
              message = `Energy demand baseline ${baseDemand.toFixed(0)} MWh vs scenario ${scenDemand.toFixed(0)} MWh. PV baseline ${basePV.toFixed(0)} MWh vs scenario ${scenPV.toFixed(0)} MWh. Net grid baseline ${baseNet.toFixed(0)} MWh vs scenario ${scenNet.toFixed(0)} MWh.`;
            }
          } else if (type === 'radar') {
            if (s) {
              const green = s.greenScore;
              const cool = s.coolScore;
              const energy = s.energyScore;
              const co2 = s.co2Score;
              message = `Scenario scores – Greenness: ${green.toFixed(0)}, Cooling: ${cool.toFixed(0)}, Energy: ${energy.toFixed(0)}, CO₂: ${co2.toFixed(0)}.`;
            }
          }
          if (message) {
            showToast(message);
          }
        };
      }
      attachChartClick(IR_chartNdvi, 'ndvi');
      attachChartClick(IR_chartUhi, 'uhi');
      attachChartClick(IR_chartEnergy, 'energy');
      attachChartClick(IR_chartRadar, 'radar');

      /* Scenario detail overlays removed along with scenario comparison pins */

      // Update charts for current scenario versus baseline; scenario comparison A/B removed
      function updateComparison() {
        // Compute the current scenario using slider values.
        const s = IR_computeScenario();
        // Update NDVI bar chart: baseline stays in first position and zero at second; scenario is zero at first and current at second.
        IR_chartNdvi.data.datasets[0].data = [IR_BASE.ndvi_mean, 0];
        IR_chartNdvi.data.datasets[1].data = [0, s.ndviScenario];
        // Update UHI bar chart similarly.
        IR_chartUhi.data.datasets[0].data = [IR_BASE.uhi_mean, 0];
        IR_chartUhi.data.datasets[1].data = [0, s.uhiScenario];
        // Update Energy bar chart: demand, PV and net grid for current scenario.
        IR_chartEnergy.data.datasets[1].data = [
          s.energyScenario_kwh / 1000,
          s.pvScenario_kwh / 1000,
          s.netGridScenario_kwh / 1000
        ];
        // Update radar chart: green, cool, energy and CO₂ scores for the scenario.
        IR_chartRadar.data.datasets[1].data = [
          s.greenScore,
          s.coolScore,
          s.energyScore,
          s.co2Score
        ];
        // Refresh charts without animation.
        IR_chartNdvi.update("none");
        IR_chartUhi.update("none");
        IR_chartEnergy.update("none");
        IR_chartRadar.update("none");
      }

      function IR_computeScenario() {
        const treesAdded = parseInt(elTrees.value, 10) || 0;
        const pvExtraPct = parseInt(elPV.value, 10) || 0;
        const retroPct = parseInt(elRetro.value, 10) || 0;
        const heatLevel = parseInt(elHeat.value, 10) || 0;
        const greenRoofPct = parseInt(elGreenRoof.value, 10) || 0;

        const ndviIncreaseTrees = Math.min(0.06, (treesAdded / 1500) * 0.06);
        const ndviIncreaseGreen = (greenRoofPct / 100) * 0.04;
        const ndviIncrease = ndviIncreaseTrees + ndviIncreaseGreen;
        const ndviScenario = IR_BASE.ndvi_mean + ndviIncrease;

        const uhiHeatUp = heatLevel * 1.5;
        const uhiTreeCool = (treesAdded / 300) * 0.1;
        const uhiRetroCool = (retroPct / 100) * 0.8;
        const uhiGreenCool = (greenRoofPct / 100) * 1.0;
        const uhiPVcool = (pvExtraPct / 100) * 0.7;
        const treeShadePVLoss = Math.min(0.5, (treesAdded / 1500) * 0.5);

        let uhiScenario = IR_BASE.uhi_mean + uhiHeatUp - uhiTreeCool - uhiRetroCool - uhiPVcool - uhiGreenCool;
        if (uhiScenario < 0) uhiScenario = 0;

        const maxSavingsFraction = 0.25;
        const savingsFrac = (retroPct / 80) * maxSavingsFraction;
        let energyScenario_kwh = IR_BASE.energy_kwh * (1 - Math.min(savingsFrac, maxSavingsFraction));
        energyScenario_kwh *= (1 + (uhiScenario - IR_BASE.uhi_mean) * 0.02);
        energyScenario_kwh *= (1 - (greenRoofPct / 100) * 0.10);
        if (energyScenario_kwh < 0) energyScenario_kwh = 0;

        const pvScenario_kwh = IR_BASE.pv_kwh * (1 + pvExtraPct / 100) * (1 - treeShadePVLoss);
        const netGridScenario_kwh = energyScenario_kwh - pvScenario_kwh;

        const co2FromEnergy = IR_BASE.co2_kg * (energyScenario_kwh / IR_BASE.energy_kwh);
        const co2FromTrees = treesAdded * IR_BASE.co2_tree_kg_year;
        let co2Scenario_kg = co2FromEnergy - co2FromTrees;
        if (co2Scenario_kg < 0) co2Scenario_kg = 0;

        const greenScore = Math.min(100, 40 + (ndviIncrease / 0.06) * 40);
        const coolScore = Math.min(100, 40 + (uhiHeatUp > 0 ? 0 : 10) + (uhiTreeCool + uhiRetroCool + uhiGreenCool) * 8);
        const energyScore = Math.min(100, 40 + ((IR_BASE.energy_kwh - energyScenario_kwh) / IR_BASE.energy_kwh) * 60);
        const co2Score = Math.min(100, 40 + ((IR_BASE.co2_kg - co2Scenario_kg) / IR_BASE.co2_kg) * 60);

        const treeCost = treesAdded * IR_BASE.cost_tree_eur;
        const pvCost = pvExtraPct * IR_BASE.cost_pv_per_pct_eur;
        const dwellingsInsulated = IR_BASE.dwellings * (retroPct / 100);
        const retrofitCost = dwellingsInsulated * IR_BASE.retrofit_cost_per_dwelling_eur;
        const greenRoofCost = greenRoofPct * IR_BASE.cost_greenRoof_per_pct_eur;
        const totalCost = treeCost + pvCost + retrofitCost + greenRoofCost;

        // compute equity: number of vulnerable households protected via retrofits
        const totalVulnerable = IR_BASE.dwellings * (window.IR_BASE_GLOBAL ? window.IR_BASE_GLOBAL.vulnerable_pct / 100 : 0);
        const protectedHH = totalVulnerable * (retroPct / 100);
        const equityPct = totalVulnerable ? (protectedHH / totalVulnerable) * 100 : 0;

        return { treesAdded, pvExtraPct, retroPct, heatLevel, greenRoofPct, ndviScenario, uhiScenario, energyScenario_kwh, pvScenario_kwh, netGridScenario_kwh, co2Scenario_kg, greenScore, coolScore, energyScore, co2Score, treeCost, pvCost, retrofitCost, greenRoofCost, totalCost, protectedHH, equityPct, treeShadePVLoss };
      }

      function IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct) {
        const lines = [];
        if (s.treesAdded === 0 && s.pvExtraPct === 0 && s.retroPct === 0 && s.heatLevel === 0) {
          lines.push("Baseline metrics: NDVI ~0.22, UHI ~9 \u00b0C, energy demand ~5,000 MWh/yr, PV potential ~650 MWh/yr, CO₂ emissions ~1.8 kt/yr and ~2,400 existing trees. No additional measures: indicators stay at observed levels and no extra investment is required.");
          return lines;
        }
        if (s.treesAdded > 0) lines.push(`Greening: +${s.treesAdded.toLocaleString()} trees increase effective greenness by ~${Math.round(greenPct)}%. Their canopies provide shade and evapotranspiration that cools streets and lowers energy use for cooling. However, shade on solar panels can substantially cut output — even 10% shading on one module may halve the power of the whole PV string so careful placement is important`);
        if (s.greenRoofPct > 0) lines.push(`Green roofs: Converting ${s.greenRoofPct}% of rooftops to vegetated roofs not only improves greenness but also insulates buildings and shades roof surfaces. Studies report that green roofs can lower roof surface temperatures by up to 13 °C and cut cooling loads by 70%, reducing energy use.`);
        if (s.pvExtraPct > 0) lines.push(`Solar: Rooftop PV capacity rises by ${s.pvExtraPct}%, lowering dependence on grid electricity.`);
        if (s.retroPct > 0) lines.push(`Retrofit: Insulating ${s.retroPct}% of the building stock reduces total energy demand by about ${Math.abs(Math.round(energyPct))}%.`);
        if (s.heatLevel > 0) lines.push(`Heat stress: Heatwave level ${s.heatLevel} pushes UHI up, but measures change net UHI by ${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C.`);
        if (co2Pct > 0) lines.push(`CO₂: Scenario reduces annual operational CO₂ emissions by ~${Math.abs(Math.round(co2Pct))}% relative to the current situation.`);
        if (s.totalCost > 0) {
          const totalCostK = Math.round(s.totalCost).toLocaleString();
          lines.push(`Financial: Approximate total investment of €${totalCostK}.`);
        }
        return lines;
      }

      function IR_updateUI() {
        const s = IR_computeScenario();
        labelTrees.textContent = s.treesAdded.toLocaleString();
        labelPV.textContent = s.pvExtraPct;
        labelRetro.textContent = s.retroPct;
        labelHeat.textContent = s.heatLevel;
        labelGreenRoof.textContent = s.greenRoofPct;
        
        // Keep baseline datasets constant; update scenario datasets with current values.
        IR_chartNdvi.data.datasets[0].data = [IR_BASE.ndvi_mean, IR_BASE.ndvi_mean];
        IR_chartNdvi.data.datasets[1].data = [IR_BASE.ndvi_mean, s.ndviScenario];
        IR_chartNdvi.update("none");
        IR_chartUhi.data.datasets[0].data = [IR_BASE.uhi_mean, IR_BASE.uhi_mean];
        IR_chartUhi.data.datasets[1].data = [IR_BASE.uhi_mean, s.uhiScenario];
        IR_chartUhi.update("none");
        IR_chartEnergy.data.datasets[0].data = [IR_BASE.energy_kwh/1000, IR_BASE.pv_kwh/1000, IR_BASE_netGrid_kwh/1000];
        IR_chartEnergy.data.datasets[1].data = [s.energyScenario_kwh/1000, s.pvScenario_kwh/1000, s.netGridScenario_kwh/1000];
        IR_chartEnergy.update("none");
        IR_chartRadar.data.datasets[1].data = [s.greenScore, s.coolScore, s.energyScore, s.co2Score]; IR_chartRadar.update("none");

        const greenPct = (s.ndviScenario / IR_BASE.ndvi_mean - 1) * 100;
        const energyPct = (1 - s.energyScenario_kwh / IR_BASE.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / IR_BASE.co2_kg) * 100;
        const uhiDelta = IR_BASE.uhi_mean - s.uhiScenario;
        const clampPct = v => Math.round(v);

        summaryGreen.textContent = `${greenPct >= 0 ? "+" : ""}${clampPct(greenPct)}%`;
        summaryCool.textContent = `${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C`;
        summaryEnergy.textContent = `${energyPct >= 0 ? "-" : "+"}${Math.abs(clampPct(energyPct))}%`;
        summaryCO2.textContent = `${co2Pct >= 0 ? "-" : "+"}${Math.abs(clampPct(co2Pct))}%`;

        summaryGreen.className = "summary-value " + (greenPct >= 0 ? "positive" : "negative");
        summaryCool.className = "summary-value " + (uhiDelta >= 0 ? "positive" : "negative");
        summaryEnergy.className = "summary-value " + (energyPct >= 0 ? "positive" : "negative");
        summaryCO2.className = "summary-value " + (co2Pct >= 0 ? "positive" : "negative");
        summaryCost.textContent = `€${Math.round(s.totalCost).toLocaleString()}`;
        summaryCost.className = "summary-value neutral";

        // Compute stakeholder benefit scores
        // Citizen score emphasises energy and comfort, while planner score focuses on CO₂ and greenness
        const citizenScoreRaw = (s.energyScore * 0.5 + s.coolScore * 0.3 + s.greenScore * 0.1 + s.co2Score * 0.1) - ((s.pvCost + s.retrofitCost) / 20000);
        const plannerScoreRaw = (s.co2Score * 0.4 + s.greenScore * 0.3 + s.coolScore * 0.2 + s.energyScore * 0.1) - ((s.treeCost + s.greenRoofCost) / 20000);
        const clampScore = v => Math.max(0, Math.min(100, v));
        const citizenScore = clampScore(citizenScoreRaw);
        const plannerScore = clampScore(plannerScoreRaw);
        if (IR_chartStakeholders && IR_chartStakeholders.data) {
          IR_chartStakeholders.data.datasets[0].data = [citizenScore, plannerScore];
          IR_chartStakeholders.update("none");
        }

        // Update equity summary
        if (summaryEquity) {
          const eqVal = s.equityPct || 0;
          summaryEquity.textContent = `${Math.round(eqVal)}%`;
          summaryEquity.className = "summary-value " + (eqVal >= 0 ? "positive" : "negative");
        }

        // Build insights and include shading warnings
        const insightLines = IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct);
        // Show conflict warnings if PV shading is significant
        const shadingPct = Math.round((s.treeShadePVLoss || 0) * 100);
        if (shadingPct > 20 && s.pvExtraPct > 20) {
          showToast(`Tree shading reduces PV by ~${shadingPct}%`);
        }
        if (shadingPct > 10 && s.pvExtraPct > 10) {
          insightLines.push(`PV shading warning: Trees reduce PV output by ~${shadingPct}%. Consider adjusting tree placement or PV capacity.`);
        }
        insightsBox.textContent = insightLines.join(" ");

        // Update comparison overlays on charts
        updateComparison();
      }
      // Expose update function globally so other scripts can trigger refresh
      window.IR_updateUI = IR_updateUI;

      ["input", "change"].forEach(evt => {
        elTrees.addEventListener(evt, IR_updateUI);
        elPV.addEventListener(evt, IR_updateUI);
        elRetro.addEventListener(evt, IR_updateUI);
        elHeat.addEventListener(evt, IR_updateUI);
        elGreenRoof.addEventListener(evt, IR_updateUI);
      });
      elReset.addEventListener("click", () => {
        elTrees.value = 0; elPV.value = 0; elRetro.value = 0; elHeat.value = 0; elGreenRoof.value = 0;
        IR_updateUI();
      });

      // Update budget value display
      if (elBudget && labelBudget) {
        const updateBudgetLabel = () => {
          const val = parseInt(elBudget.value || 0, 10);
          labelBudget.textContent = val.toLocaleString();
        };
        elBudget.addEventListener('input', updateBudgetLabel);
        updateBudgetLabel();
      }

      // Optimiser: run a simple grid search to maximise overall score under budget
      if (btnOptimize) {
        btnOptimize.addEventListener('click', () => {
          const budget = parseInt(elBudget.value || 0, 10);
          let bestScore = -1;
          let bestConfig = null;
          const treesOpts = [0, 300, 600, 900, 1200, 1500];
          const pvOpts = [0, 20, 40, 60, 80, 100];
          const retroOpts = [0, 20, 40, 60, 80];
          const heatOpts = [0];
          const greenOpts = [0, 25, 50, 75, 100];
          for (const t of treesOpts) {
            for (const p of pvOpts) {
              for (const r of retroOpts) {
                for (const h of heatOpts) {
                  for (const g of greenOpts) {
                    const config = { trees: t, pv: p, retro: r, heat: h, green: g };
                    const sTmp = computeScenario(config);
                    if (sTmp.totalCost > budget) continue;
                    const overall = (sTmp.greenScore + sTmp.coolScore + sTmp.energyScore + sTmp.co2Score) / 4;
                    if (overall > bestScore) {
                      bestScore = overall;
                      bestConfig = config;
                    }
                  }
                }
              }
            }
          }
          if (bestConfig) {
            // Apply best config to sliders
            elTrees.value = bestConfig.trees;
            elPV.value = bestConfig.pv;
            elRetro.value = bestConfig.retro;
            elHeat.value = bestConfig.heat;
            elGreenRoof.value = bestConfig.green;
            IR_updateUI();
            showToast('Optimised scenario loaded');
          } else {
            showToast('No scenario fits within the selected budget');
          }
        });
      }

      // Scenario comparison pinning removed

      // Copy scenario as link
      if (btnCopy) {
        btnCopy.addEventListener('click', () => {
          const sTmp = IR_computeScenario();
          const params = `trees=${sTmp.treesAdded}&pv=${sTmp.pvExtraPct}&retro=${sTmp.retroPct}&heat=${sTmp.heatLevel}&green=${sTmp.greenRoofPct}`;
          const url = window.location.origin + window.location.pathname + '#' + params;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(() => showToast('Scenario link copied')).catch(() => showToast('Unable to copy link'));
          } else {
            showToast(url);
          }
        });
      }

      // Save scenario as JSON
      if (btnSave) {
        btnSave.addEventListener('click', () => {
          const sTmp = IR_computeScenario();
          const data = { trees: sTmp.treesAdded, pv: sTmp.pvExtraPct, retro: sTmp.retroPct, heat: sTmp.heatLevel, green: sTmp.greenRoofPct };
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'scenario.json';
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
        });
      }

      // Load scenario from JSON
      if (btnLoad) {
        btnLoad.addEventListener('click', () => {
          if (fileInput) fileInput.click();
        });
      }
      if (fileInput) {
        fileInput.addEventListener('change', () => {
          const file = fileInput.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function() {
            try {
              const json = JSON.parse(reader.result);
              if (typeof json === 'object') {
                if (json.trees !== undefined) elTrees.value = json.trees;
                if (json.pv !== undefined) elPV.value = json.pv;
                if (json.retro !== undefined) elRetro.value = json.retro;
                if (json.heat !== undefined) elHeat.value = json.heat;
                if (json.green !== undefined) elGreenRoof.value = json.green;
                IR_updateUI();
                showToast('Scenario loaded from JSON');
              }
            } catch (err) {
              showToast('Invalid JSON');
            }
          };
          reader.readAsText(file);
        });
      }

      async function IR_downloadPdf() {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) { alert("PDF library not loaded."); return; }
        const interPanel = document.querySelector("#panel-interrelation");
        const oldOpacity = interPanel.style.opacity;
        const oldPointer = interPanel.style.pointerEvents;
        interPanel.style.opacity = 1; interPanel.style.pointerEvents = "auto";
        await new Promise(resolve => setTimeout(resolve, 300));
        const pdf = new jsPDF("p", "mm", "a4");
        if (pdf.setCharSpace) pdf.setCharSpace(0);
        const s = IR_computeScenario();
        const greenPct = (s.ndviScenario / IR_BASE.ndvi_mean - 1) * 100;
        const energyPct = (1 - s.energyScenario_kwh / IR_BASE.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / IR_BASE.co2_kg) * 100;
        const uhiDelta = IR_BASE.uhi_mean - s.uhiScenario;
        const insightLines = IR_buildInsightsLines(s, greenPct, uhiDelta, energyPct, co2Pct);
        const marginX = 18;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const contentWidth = pageWidth - marginX * 2;
        pdf.setFont("helvetica", "bold"); pdf.setFontSize(16);
        pdf.text("Twekkelerveld Digital Twin", pageWidth / 2, 20, { align: "center" });
        pdf.setFontSize(12); pdf.text("Scenario Simulation Report", pageWidth / 2, 27, { align: "center" });
        pdf.setFontSize(9); pdf.setFont("helvetica", "normal");
        const nowStr = new Date().toLocaleString();
        pdf.text(`Generated: ${nowStr}`, pageWidth / 2, 33, { align: "center" });
        let y = 40;
        function sectionHeader(label) {
          pdf.setDrawColor(200); pdf.setFillColor(245);
          pdf.roundedRect(marginX, y, contentWidth, 8, 2, 2, "F");
          pdf.setFont("helvetica", "bold"); pdf.setFontSize(10); pdf.setTextColor(60);
          if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(label, marginX + 3, y + 5);
          pdf.setTextColor(0); y += 12;
        }
        sectionHeader("SCENARIO INPUTS");
        pdf.setFont("helvetica", "normal"); pdf.setFontSize(9);
        const inputs = [
          ["Additional trees", `${s.treesAdded.toLocaleString()} (baseline: ${IR_BASE.trees_existing.toLocaleString()} trees)`],
          ["Extra rooftop PV", `${s.pvExtraPct}% (relative to current potential)`],
          ["Insulated buildings", `${s.retroPct}% of stock (${Math.round(IR_BASE.dwellings * (s.retroPct / 100)).toLocaleString()} dwellings)`],
          ["Green roof coverage", `${s.greenRoofPct}% of roofs`],
          ["Heatwave severity", `Level ${s.heatLevel} (0 = normal summer, 3 = extreme)`]
        ];
        inputs.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 48, y);
          y += 5;
        });
        y += 4;
        sectionHeader("INDICATOR CHANGES");
        const deltas = [
          ["Greenness (NDVI)", `${greenPct >= 0 ? "+" : ""}${Math.round(greenPct)}%`],
          ["Urban heat island", `${uhiDelta >= 0 ? "-" : "+"}${Math.abs(uhiDelta).toFixed(1)} °C`],
          ["Energy demand", `${energyPct >= 0 ? "-" : "+"}${Math.abs(Math.round(energyPct))}%`],
          ["Operational CO₂", `${co2Pct >= 0 ? "-" : "+"}${Math.abs(Math.round(co2Pct))}%`]
        ];
        deltas.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 48, y);
          y += 5;
        });
        y += 4;
        sectionHeader("FINANCIAL OVERVIEW");
        const costLines = [
          ["Tree planting cost", `€${Math.round(s.treeCost).toLocaleString()}`],
          ["PV investment cost", `€${Math.round(s.pvCost).toLocaleString()}`],
          ["Retrofit cost", `€${Math.round(s.retrofitCost).toLocaleString()}`],
          ["Green roof cost", `€${Math.round(s.greenRoofCost).toLocaleString()}`],
          ["Total scenario cost", `€${Math.round(s.totalCost).toLocaleString()}`]
        ];
        costLines.forEach(row => {
          pdf.setFont("helvetica", "bold"); if (pdf.setCharSpace) pdf.setCharSpace(0);
          pdf.text(row[0] + ":", marginX, y);
          pdf.setFont("helvetica", "normal"); pdf.text(row[1], marginX + 60, y);
          y += 5;
        });
        y += 4;
        sectionHeader("SCENARIO INSIGHTS");
        pdf.setFont("helvetica", "normal");
        const maxWidth = contentWidth - 6;
        insightLines.forEach(line => {
          if (pdf.setCharSpace) pdf.setCharSpace(0);
          const wrapped = pdf.splitTextToSize(line, maxWidth);
          wrapped.forEach((w, i) => {
            const prefix = i === 0 ? "• " : "  ";
            pdf.text(prefix + w, marginX + 2, y);
            y += 5;
            if (y > 270) { pdf.addPage(); y = 20; }
          });
        });
        pdf.addPage();
        pdf.setFont("helvetica", "bold"); pdf.setFontSize(12);
        if (pdf.setCharSpace) pdf.setCharSpace(0);
        pdf.text("Scenario Charts", marginX, 18);
        pdf.setFont("helvetica", "normal"); pdf.setFontSize(9);
        pdf.text("Charts exported from the interactive interrelation dashboard.", marginX, 24);
        const imgWidth = 80; const imgHeight = 55; const gapX = 10; const gapY = 10;
        const x1 = marginX; const x2 = x1 + imgWidth + gapX;
        const yTop = 30; const yBottom = yTop + imgHeight + gapY;
        const addChartImage = (canvasId, x, yPos) => {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;
          const imgData = canvas.toDataURL("image/png", 1.0);
          pdf.addImage(imgData, "PNG", x, yPos, imgWidth, imgHeight);
        };
        addChartImage("IR_chartNdvi", x1, yTop); addChartImage("IR_chartUhi", x2, yTop);
        addChartImage("IR_chartEnergy", x1, yBottom); addChartImage("IR_chartRadar", x2, yBottom);
        interPanel.style.opacity = oldOpacity; interPanel.style.pointerEvents = oldPointer;
        pdf.save("Twekkelerveld_scenario_simulation.pdf");
      }
      elPdf.addEventListener("click", IR_downloadPdf);
      IR_updateUI();
    };
    // ============================
    // Mission briefing interactions
    // ============================
    document.addEventListener('DOMContentLoaded', function() {
      // Animate baseline metric counters
      function animateCounters() {
        const counters = document.querySelectorAll('.metric-value');
        counters.forEach(el => {
          const target = parseFloat(el.getAttribute('data-target'));
          const decimals = (target % 1 !== 0) ? 2 : 0;
          const startTime = performance.now();
          const duration = 1500;
          function update(now) {
            const progress = Math.min((now - startTime) / duration, 1);
            const value = target * progress;
            el.textContent = decimals === 0 ? Math.round(value).toLocaleString() : value.toFixed(decimals);
            if (progress < 1) requestAnimationFrame(update);
          }
          requestAnimationFrame(update);
        });
      }
      animateCounters();

      // Global data for hotspots and case studies
      window.hotspotData = {
        housing: {
          title: "Housing hotspot",
          img: "Study Area.png",
          desc: "Dense residential blocks where retrofit trade‑offs are tangible. Upgrading insulation here improves comfort but must balance heritage and affordability.",
          tab: "panel-ecology",
          // approximate intervention: add trees and some green roofs around housing blocks
          preset: { trees: 600, pv: 0, retro: 0, heat: 0, green: 20 }
        },
        industry: {
          title: "Industrial edge",
          img: "Study Area.png",
          desc: "Industrial areas on the district edge contribute to heat and offer vast roof surfaces for PV. Understanding their energy profiles is key.",
          tab: "panel-energy",
          // encourage rooftop PV adoption on industrial roofs and modest street trees
          preset: { trees: 200, pv: 20, retro: 0, heat: 0, green: 0 }
        },
        green: {
          title: "Green corridors",
          img: "Study Area.png",
          desc: "Existing green corridors provide cooling but could be better connected. Spot opportunities for tree planting and pocket parks.",
          tab: "panel-ecology",
          // strengthen green corridors with extra trees and maximum green roofs
          preset: { trees: 300, pv: 0, retro: 0, heat: 0, green: 50 }
        }
      };
      window.caseData = {
        rotterdam: {
          title: "Rotterdam — Adaptation & green roofs",
          body: "Rotterdam’s climate change adaptation strategy combines flood defences, blue‑green corridors and over 185,000 m² of green roofs to enhance resilience and biodiversity【143559859189314†L117-L148】.",
          link: "https://www.c40.org/case-studies/c40-good-practice-guides-rotterdam-climate-change-adaptation-strategy/",
          preset: { trees: 600, pv: 0, retro: 0, heat: 0, green: 20 }
        },
        freiburg: {
          title: "Freiburg — Solar Settlement",
          body: "Freiburg’s Solar Settlement features 59 energy‑positive homes with roofs covered in PV modules. The 445 kW system generates about 420,000 kWh per year—nearly triple residents’ consumption【68796956034976†L42-L65】.",
          link: "https://hajster.com/en/case-en/freiburg-an-example-of-sustainable-energy-efficient-urban-development-en",
          preset: { trees: 0, pv: 40, retro: 0, heat: 0, green: 0 }
        },
        vienna: {
          title: "Vienna — Smart City Baumgarten",
          body: "The Smart City Baumgarten project retrofits mixed‑age buildings with 25 geothermal boreholes, PV panels and deep insulation. About 40–50% of costs were subsidised and the project meets Passive House standards【740516144639354†L192-L241】.",
          link: "https://www.alpine-space.eu/project-news/retrofitting-for-the-future-the-smart-city-baumgarten-case-study-in-vienna/",
          preset: { trees: 0, pv: 10, retro: 70, heat: 0, green: 0 }
        },
        singapore: {
          title: "Singapore — Vertical greening",
          body: "Green roofs and vertical gardens in Southeast Asia provide natural insulation, manage rainwater and improve air quality. Projects like Singapore’s Pinnacle@Duxton show lower energy bills and stronger community well‑being【850705513734537†L90-L103】.",
          link: "https://billionbricks.org/blog/green-roofs-and-vertical-gardens-reimagining-urban-housing-in-sea/",
          preset: { trees: 800, pv: 0, retro: 0, heat: 0, green: 50 }
        },
        barcelona: {
          title: "Barcelona — Climate shelter schools",
          body: "Barcelona converted 11 schools into climate shelters with water features, vegetation and insulated roofs. The project reclaimed 1,000 m² of natural land and created 2,213 m² of shaded areas【107164856569819†L63-L107】.",
          link: "https://uia.urban-initiative.eu/en/news/11-schools-barcelona-project-are-now-climate-shelters",
          preset: { trees: 0, pv: 0, retro: 30, heat: 0, green: 30 }
        },
        paris: {
          title: "Paris — Community solar cooperative",
          body: "EnerCit’IF, a Parisian energy cooperative, installed 15 PV power plants totalling 730 kWp. The Emile Anthoine gym alone produces 90,000 kWh annually and supplies nearby homes while engaging citizens in the city’s 2050 energy plan【186441328491013†L109-L121】.",
          link: "https://theurbanactivist.com/climate/citizens-could-seize-the-moment-energy-cooperatives-pluck-in-paris/",
          preset: { trees: 0, pv: 60, retro: 0, heat: 0, green: 0 }
        }
      };

      // Hotspot click behaviour
      const drawer = document.getElementById('drawer');
      const drawerTitle = document.getElementById('drawer-title');
      const drawerImg = document.getElementById('drawer-image');
      const drawerDesc = document.getElementById('drawer-description');
      const drawerOpenBtn = document.getElementById('drawer-open-btn');
      document.querySelectorAll('.hotspot').forEach(h => {
        h.addEventListener('click', function() {
          const key = this.getAttribute('data-spot');
          const data = window.hotspotData[key];
          if (!data) return;
          drawerTitle.textContent = data.title;
          drawerDesc.textContent = data.desc;
          drawerImg.src = data.img;
          drawerOpenBtn.textContent = data.tab === "panel-ecology" ? "Open Ecology tab" : "Open Energy tab";
          drawerOpenBtn.dataset.tab = data.tab;
          drawer.classList.add('open');
        });
      });
      const drawerClose = drawer ? drawer.querySelector('.drawer-close') : null;
      if (drawerClose) {
        drawerClose.addEventListener('click', function() {
          drawer.classList.remove('open');
        });
      }
      if (drawerOpenBtn) {
        drawerOpenBtn.addEventListener('click', function() {
          const t = this.dataset.tab;
          if (t) {
            switchTab(t);
            drawer.classList.remove('open');
          }
        });
      }

      // Case study click behaviour – open external links instead of showing a modal.
      document.querySelectorAll('.case-card').forEach(card => {
        card.addEventListener('click', function(e) {
          const key = this.getAttribute('data-case');
          const data = window.caseData && window.caseData[key];
          if (!data) return;
          // If a link exists, open it in a new tab
          if (data.link) {
            window.open(data.link, '_blank');
            return;
          }
          // Otherwise, fall back to applying the preset directly
          if (data.preset) {
            loadPreset(key);
          }
        });
      });

      // Replicate buttons: load the corresponding case preset and open simulation
      document.querySelectorAll('.replicate-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          // Prevent the parent case-card click from firing
          e.stopPropagation();
          const caseKey = this.getAttribute('data-case');
          if (caseKey && window.caseData && window.caseData[caseKey] && window.caseData[caseKey].preset) {
            loadPreset(caseKey);
            // Hide the case studies modal
            const modal = document.getElementById('modal-overlay');
            if (modal) modal.classList.remove('active');
          }
        });
      });

      // Timeline modal close handler: hide the modal when the close button is clicked
      const tlModal = document.getElementById('timeline-modal');
      const tlCloseBtn = document.getElementById('timeline-close-btn');
      if (tlModal && tlCloseBtn) {
        tlCloseBtn.addEventListener('click', function() {
          tlModal.classList.remove('active');
        });
      }

      // Preset buttons
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const preset = this.getAttribute('data-preset');
          loadPreset(preset);
        });
      });

      /**
       * Mission control enhancements
       * - Compute and display delta chips on case cards
       * - Show metric tile tooltips and enable click-to-load presets
       * - Implement guided story stepper interactions
       * - Display resume ribbon for last scenario
       * - Show impact preview inside hotspot drawer and simulate button
       */
      // Create delta chips for case cards
      document.querySelectorAll('.case-card').forEach(card => {
        const key = card.getAttribute('data-case');
        const data = window.caseData && window.caseData[key];
        const chipsContainer = card.querySelector('.delta-chips');
        if (!chipsContainer || !data || !data.preset) return;
        const s = computeScenario(data.preset);
        // Compute deltas relative to baseline
        const uhiDelta = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
        const energyPct = (1 - s.energyScenario_kwh / window.IR_BASE_GLOBAL.energy_kwh) * 100;
        const co2Pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
        // Cost formatting
        const cost = s.totalCost;
        let costLabel;
        if (cost >= 1_000_000) costLabel = '€' + (cost / 1_000_000).toFixed(1) + 'M';
        else costLabel = '€' + Math.round(cost / 1000).toLocaleString() + 'k';
        // Build chip HTML; sign convention: negative means reduction is good (cooler, less energy, less CO2)
        const chips = [];
        const uhiLabel = `${uhiDelta >= 0 ? '↓' : '↑'}${Math.abs(uhiDelta).toFixed(1)}°C`;
        chips.push(`<span class="delta-chip cool">${uhiLabel}</span>`);
        const energyLabel = `${energyPct >= 0 ? '↓' : '↑'}${Math.abs(Math.round(energyPct))}% MWh`;
        chips.push(`<span class="delta-chip energy">${energyLabel}</span>`);
        const co2Label = `${co2Pct >= 0 ? '↓' : '↑'}${Math.abs(Math.round(co2Pct))}% CO₂`;
        chips.push(`<span class="delta-chip co2">${co2Label}</span>`);
        chips.push(`<span class="delta-chip cost">${costLabel}</span>`);
        chipsContainer.innerHTML = chips.join('');
      });

      // Metric tiles: add tooltips and click behaviour
      document.querySelectorAll('.metric-tile').forEach(tile => {
        const presetName = tile.getAttribute('data-preset');
        const targetTab = tile.getAttribute('data-tab');
        // Create tooltip element
        const tooltip = document.createElement('div');
        tooltip.className = 'metric-tooltip';
        tile.appendChild(tooltip);
        // Compute preview values using preset
        let text = '';
        if (presetName) {
          const cfg = getConfigForPreset(presetName);
          const s = computeScenario(cfg);
          const label = tile.querySelector('.metric-label') ? tile.querySelector('.metric-label').textContent.toLowerCase() : '';
          if (label.includes('uhi')) {
            const diff = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
            text = `${diff >= 0 ? '-' : '+'}${Math.abs(diff).toFixed(1)}°C vs base`;
          } else if (label.includes('ndvi')) {
            const pct = ((s.ndviScenario / window.IR_BASE_GLOBAL.ndvi_mean) - 1) * 100;
            text = `${pct >= 0 ? '+' : ''}${Math.round(pct)}% vs base`;
          } else if (label.includes('demand')) {
            const pct = (1 - s.energyScenario_kwh / window.IR_BASE_GLOBAL.energy_kwh) * 100;
            text = `${pct >= 0 ? '-' : '+'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('pv')) {
            const pct = (s.pvScenario_kwh / window.IR_BASE_GLOBAL.pv_kwh - 1) * 100;
            text = `${pct >= 0 ? '+' : '-'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('co₂') || label.includes('co2')) {
            const pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
            text = `${pct >= 0 ? '-' : '+'}${Math.abs(Math.round(pct))}% vs base`;
          } else if (label.includes('vulnerable')) {
            const pct = s.equityPct || 0;
            text = `${pct >= 0 ? '+' : ''}${Math.round(pct)}% protected`;
          }
        }
        tooltip.textContent = text;
        // Click opens tab and loads preset
        tile.addEventListener('click', () => {
          if (presetName) loadPreset(presetName);
          if (targetTab) switchTab(targetTab);
        });
      });

      // Story stepper interactions
      const storySteps = document.querySelectorAll('.story-stepper .step');
      if (storySteps) {
        storySteps.forEach(step => {
          step.addEventListener('click', () => {
            storySteps.forEach(s => s.classList.remove('active'));
            step.classList.add('active');
            const stepNum = parseInt(step.getAttribute('data-step'), 10);
            if (stepNum === 1) {
              // highlight hotspots
              const hs = document.querySelectorAll('.hotspot');
              hs.forEach(h => h.classList.add('flash'));
              setTimeout(() => hs.forEach(h => h.classList.remove('flash')), 2500);
              const why = document.querySelector('.why-section');
              if (why && why.scrollIntoView) why.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else if (stepNum === 2) {
              // highlight a case card
              const card = document.querySelector('.case-card');
              if (card) {
                card.classList.add('highlight');
                if (card.scrollIntoView) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => card.classList.remove('highlight'), 2500);
              }
            } else if (stepNum === 3) {
              // load a default strategy and open simulation
              loadPreset('cool');
            }
          });
        });
      }

      // Resume ribbon: show summary of last scenario
      const resumeRibbon = document.getElementById('resume-ribbon');
      const resumeText = document.getElementById('resume-text');
      const resumeBtn = document.getElementById('resume-btn');
      try {
        const lastStr = localStorage.getItem('lastScenario');
        if (lastStr) {
          const lastObj = JSON.parse(lastStr);
          if (lastObj && lastObj.config) {
            const s = computeScenario(lastObj.config);
            const del = computeDeltas(s);
            const date = new Date(lastObj.timestamp || Date.now());
            const uhi = del.uhiDelta;
            const energy = del.energyPct;
            const co2 = del.co2Pct;
            const parts = [];
            parts.push(`UHI ${uhi >= 0 ? '-' : '+'}${Math.abs(uhi).toFixed(1)}°C`);
            parts.push(`Energy ${energy >= 0 ? '-' : '+'}${Math.abs(Math.round(energy))}%`);
            parts.push(`CO₂ ${co2 >= 0 ? '-' : '+'}${Math.abs(Math.round(co2))}%`);
            resumeText.innerHTML = `Last scenario: ${lastObj.name || 'custom'} (${date.toLocaleDateString()}) &mdash; ${parts.join(', ')}`;
            resumeRibbon.style.display = 'flex';
            if (resumeBtn) {
              resumeBtn.onclick = function() {
                loadPreset(lastObj.config);
              };
            }
          }
        }
      } catch(err) { /* ignore */ }

      // Hotspot preview and simulate button
      const drawerPreview = document.getElementById('drawer-preview');
      const drawerSimBtn = document.getElementById('drawer-simulate-btn');
      document.querySelectorAll('.hotspot').forEach(h => {
        h.addEventListener('click', function() {
          const key = this.getAttribute('data-spot');
          const data = window.hotspotData && window.hotspotData[key];
          if (!data) return;
          if (data.preset) {
            const s = computeScenario(data.preset);
            const uhi = window.IR_BASE_GLOBAL.uhi_mean - s.uhiScenario;
            const co2pct = (1 - s.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
            drawerPreview.innerHTML = `If we add ${data.preset.trees} trees & ${data.preset.green}% green roofs → UHI ${uhi >= 0 ? '–' : '+'}${Math.abs(uhi).toFixed(1)}°C, CO₂ ${co2pct >= 0 ? '–' : '+'}${Math.abs(Math.round(co2pct))}%`;
            drawerSimBtn.dataset.preset = JSON.stringify(data.preset);
          } else {
            drawerPreview.textContent = '';
            drawerSimBtn.dataset.preset = '';
          }
        });
      });
      if (drawerSimBtn) {
        drawerSimBtn.addEventListener('click', function() {
          const presetStr = this.dataset.preset;
          if (presetStr) {
            try {
              const cfg = JSON.parse(presetStr);
              if (cfg) loadPreset(cfg);
            } catch(e) {}
          }
          const dr = document.getElementById('drawer');
          if (dr) dr.classList.remove('open');
        });
      }
      // Global case studies modal open/close
      const casesBtn = document.getElementById('open-cases-btn');
      const modalOverlay = document.getElementById('modal-overlay');
      const casesClose = document.getElementById('cases-close-btn');
      if (casesBtn && modalOverlay) {
        casesBtn.addEventListener('click', function() {
          modalOverlay.classList.add('active');
        });
      }
      if (casesClose && modalOverlay) {
        casesClose.addEventListener('click', function() {
          modalOverlay.classList.remove('active');
        });
      }
    });

    // Toast helper
    function showToast(msg) {
      let toast = document.querySelector('.toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toast.__hideTimeout);
      toast.__hideTimeout = setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Load preset: sets simulation sliders and navigates to simulation tab
    window.loadPreset = function(nameOrConfig) {
      let config = {};
      let presetName = '';
      // Determine whether argument is a preset name or a config object
      if (typeof nameOrConfig === 'object' && nameOrConfig !== null) {
        config = Object.assign({}, nameOrConfig);
        presetName = 'custom';
      } else {
        presetName = nameOrConfig;
        config = getConfigForPreset(presetName);
      }
      const setVal = (id, val) => {
        const el = document.getElementById(id);
        if (el && val !== undefined) { el.value = val; }
      };
      if (config.trees !== undefined) setVal('IR_sliderTrees', config.trees);
      if (config.pv !== undefined) setVal('IR_sliderPV', config.pv);
      if (config.retro !== undefined) setVal('IR_sliderRetro', config.retro);
      if (config.heat !== undefined) setVal('IR_sliderHeat', config.heat);
      if (config.green !== undefined) setVal('IR_sliderGreenRoof', config.green);
      // update simulation UI if available
      if (window.IR_updateUI) window.IR_updateUI();
      // persist last scenario in local storage
      try {
        localStorage.setItem('lastScenario', JSON.stringify({ name: presetName, config: config, timestamp: Date.now() }));
      } catch (e) {}
      // Build toast message
      let msg = '';
      if (presetName === 'cool') msg = 'Preset loaded: Cool the streets';
      else if (presetName === 'bills') msg = 'Preset loaded: Slash bills fast';
      else if (presetName === 'stress') msg = 'Preset loaded: Stress test 2050 heat';
      else if (window.caseData && window.caseData[presetName]) msg = `Preset loaded: ${window.caseData[presetName].title}`;
      else if (presetName === 'custom') msg = 'Scenario loaded from config';
      else msg = 'Preset loaded';
      showToast(msg);
      // switch to simulation tab by default
      switchTab('panel-interrelation');
    };

  </script>
  <!-- Consolidated settings dropdown and ecology modal logic -->
  <script>
    // Settings dropdown logic
    document.addEventListener('DOMContentLoaded', () => {
      const menuBtn = document.getElementById('settings-menu-btn');
      const dropdown = document.getElementById('settings-dropdown');
      if (menuBtn && dropdown) {
        menuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        function hideMenu() { dropdown.style.display = 'none'; }
        const energyBtn = document.getElementById('settings-energy');
        const ecoBtn    = document.getElementById('settings-ecology');
        const combBtn   = document.getElementById('settings-combined');
        if (energyBtn) energyBtn.addEventListener('click', function(){ hideMenu(); if (typeof openEnergyModal === 'function') openEnergyModal(); });
        if (ecoBtn)    ecoBtn.addEventListener('click', function(){ hideMenu(); if (typeof openEcologyModal === 'function') openEcologyModal(); });
        if (combBtn)   combBtn.addEventListener('click', function(){ hideMenu(); if (typeof openCombinedSettings === 'function') openCombinedSettings(); });
        document.addEventListener('click', function(ev) {
          if (!dropdown.contains(ev.target) && ev.target !== menuBtn) {
            dropdown.style.display = 'none';
          }
        });
      }
    });
    // Ecology settings modal logic
    function openEcologyModal() {
      const el = document.getElementById('ecology-settings-overlay');
      if (el) el.classList.add('active');
    }
    function closeEcologyModal() {
      const el = document.getElementById('ecology-settings-overlay');
      if (el) el.classList.remove('active');
    }
    document.addEventListener('DOMContentLoaded', () => {
      const closeBtn = document.getElementById('ecology-settings-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', closeEcologyModal);
      }
    });

    // Combined scenario settings modal logic
    function openCombinedSettings() {
      const overlay = document.getElementById('settings-overlay');
      if (overlay) overlay.classList.add('active');
      // Populate the form using the same logic as the built‑in settings modal.  
      // If the exposed population helper is available use it, otherwise fall back to a simple localStorage parse.
      if (window.DT_onResetDefaults) {
        try { window.DT_onResetDefaults(); } catch(e) {}
      }
      if (window.DT_populateSettingsForm) {
        try {
          window.DT_populateSettingsForm();
        } catch(e) {
          console.error(e);
        }
      } else {
        try {
          const str = localStorage.getItem('DT_SETTINGS');
          const s = str ? JSON.parse(str) : {};
          const form = document.getElementById('settings-form');
          if (form) {
            Object.keys(s).forEach(key => {
              const field = form.querySelector('[name="'+key+'"]');
              if (field) field.value = s[key];
            });
          }
        } catch(e) {}
      }
    }
  </script>
  <!-- -------------------------------------------------------------------------
       Global Energy & Economic Settings Modal

       This modal centralises the advanced energy and cost parameters that were
       previously embedded in the stand‑alone Energy Digital Twin.  When
       running within this integrated Nexus, users can configure prices,
       investment costs, CO₂ factors and cost‑benefit parameters in one place.
       The selected values are persisted in localStorage and broadcast to
       embedded energy and ecology twins via postMessage.  See the script
       following the markup for implementation details.
  -->
  <div id="energy-settings-overlay" class="settings-modal-overlay">
    <div class="settings-modal">
      <h2>Energy &amp; Economic Settings</h2>
      <form id="energy-settings-form">
        <h3>Prices (€/unit)</h3>
        <div class="field"><label for="g_price_elecImport">Electricity import (€/kWh)</label><input type="number" step="0.01" id="g_price_elecImport"></div>
        <div class="field"><label for="g_price_gas">Gas (€/m³)</label><input type="number" step="0.01" id="g_price_gas"></div>
        <div class="field"><label for="g_price_feedIn">Feed‑in (€/kWh)</label><input type="number" step="0.01" id="g_price_feedIn"></div>
        <div class="field"><label for="g_price_p2p">P2P (€/kWh)</label><input type="number" step="0.01" id="g_price_p2p"></div>
        <h3>Costs</h3>
        <div class="field"><label for="g_cost_pvPerWp">PV cost (€/Wp)</label><input type="number" step="0.01" id="g_cost_pvPerWp"></div>
        <div class="field"><label for="g_cost_insulation">Insulation (€/m²)</label><input type="number" step="0.1" id="g_cost_insulation"></div>
        <div class="field"><label for="g_cost_hybridHp">Hybrid heat pump (€)</label><input type="number" step="100" id="g_cost_hybridHp"></div>
        <div class="field"><label for="g_cost_allHp">All‑electric heat pump (€)</label><input type="number" step="100" id="g_cost_allHp"></div>
        <h3>CO₂ factors (kg CO₂ per unit)</h3>
        <div class="field"><label for="g_co2_elec">Electricity (kgCO₂/kWh)</label><input type="number" step="0.001" id="g_co2_elec"></div>
        <div class="field"><label for="g_co2_gas">Gas (kgCO₂/m³)</label><input type="number" step="0.001" id="g_co2_gas"></div>
        <h3>CBA parameters</h3>
        <div class="field"><label for="g_cba_discount">Discount rate (%)</label><input type="number" step="0.1" id="g_cba_discount"></div>
        <div class="field"><label for="g_cba_horizon">Horizon (years)</label><input type="number" step="1" id="g_cba_horizon"></div>
        <h3>Budget cap</h3>
        <div class="field"><label for="g_budget_cap">Max investment (€)</label><input type="number" step="100" id="g_budget_cap"></div>
        <details class="field">
          <summary>Show equations &amp; assumptions</summary>
          <div style="margin-top:8px; font-size:12px; line-height:1.5; color:var(--text-muted)">
            <p><strong>Energy cost:</strong> (gas × price<sub>gas</sub>) + (imported electricity × price<sub>elec</sub>) − (exported electricity × feed‑in tariff)</p>
            <p><strong>CO₂ savings:</strong> (baseline energy − new energy) × emission factor</p>
            <p><strong>Cost assumptions:</strong> PV cost per Wp (costs.pvPerWp), insulation per m² (costs.insulationSqM), heat pump costs (costs.hybridPump/allElectric)</p>
            <p><strong>NPV:</strong> ∑<sub>t=1</sub><sup>T</sup> (Annual savings)/(1 + r)<sup>t</sup> − Capex</p>
            <p><strong>BCR:</strong> Present value of benefits ÷ Capex</p>
            <p><strong>Defaults:</strong> values drawn from the PARAMS object (units as indicated)</p>
          </div>
        </details>
      </form>
      <div class="button-row">
        <button type="button" id="energy-settings-apply" class="save-btn">Apply</button>
        <button type="button" id="energy-settings-cancel" class="cancel-btn">Cancel</button>
      </div>
    </div>
    </div>

    <!-- Ecology settings modal -->
    <div id="ecology-settings-overlay" class="settings-modal-overlay">
      <div class="settings-modal">
        <h2>Ecology &amp; MCDA Settings</h2>
        <form id="ecology-settings-form">
          <h3>Weights (0–1)</h3>
          <div class="field"><label for="eco_weight_ndvi">Vegetation weight</label><input type="number" step="0.01" min="0" max="1" id="eco_weight_ndvi"></div>
          <div class="field"><label for="eco_weight_uhi">UHI weight</label><input type="number" step="0.01" min="0" max="1" id="eco_weight_uhi"></div>
          <div class="field"><label for="eco_weight_water">Stormwater weight</label><input type="number" step="0.01" min="0" max="1" id="eco_weight_water"></div>
          <h3>Costs</h3>
          <div class="field"><label for="eco_cost_tree">Tree cost (€/tree)</label><input type="number" step="1" id="eco_cost_tree"></div>
          <div class="field"><label for="eco_cost_greenRoof">Green roof cost (€/m²)</label><input type="number" step="1" id="eco_cost_greenRoof"></div>
          <div class="field"><label for="eco_cost_infiltration">Infiltration strip cost (€/m²)</label><input type="number" step="1" id="eco_cost_infiltration"></div>
          <h3>CBA parameters</h3>
          <div class="field"><label for="eco_cba_discount">Discount rate (%)</label><input type="number" step="0.1" id="eco_cba_discount"></div>
          <div class="field"><label for="eco_cba_horizon">Horizon (years)</label><input type="number" step="1" id="eco_cba_horizon"></div>
          <h3>Feasible space limits</h3>
          <div class="field"><label for="eco_max_tree_area">Max tree area (m²)</label><input type="number" step="10" id="eco_max_tree_area"></div>
          <div class="field"><label for="eco_max_greenRoof_pct">Max green roof (%)</label><input type="number" step="1" id="eco_max_greenRoof_pct"></div>
          <details class="field">
            <summary>Show equations &amp; assumptions</summary>
            <div style="margin-top:8px; font-size:12px; line-height:1.5; color:var(--text-muted)">
              <p><strong>Tree carbon sequestering:</strong> ~20 kg CO₂/year/tree; benefits include shade and amenity.</p>
              <p><strong>Green roof:</strong> Provides insulation and reduces runoff; cost per m² specified above.</p>
              <p><strong>Infiltration strip:</strong> A vegetated zone along creeks to retain stormwater and cool the microclimate.</p>
              <p><strong>NPV:</strong> ∑<sub>t=1</sub><sup>T</sup> (Annual benefits)/(1 + r)<sup>t</sup> − Capex.</p>
              <p><strong>BCR:</strong> Present value of benefits ÷ Capex.</p>
            </div>
          </details>
          <details class="field">
            <summary>Stakeholders &amp; users</summary>
            <div style="margin-top:8px; font-size:12px; line-height:1.5; color:var(--text-muted)">
              <p><strong>Stakeholders:</strong> residents, local businesses, schools, NGOs, municipality, utilities.</p>
              <p><strong>Users:</strong> municipal planners, sustainability officers, housing association asset managers, consultants/researchers.</p>
              <p><strong>User stories:</strong></p>
              <ul style="margin-left:15px;">
                <li>Municipal planner compares scenarios under a €X budget.</li>
                <li>Housing corporation prioritizes buildings for retrofit &amp; PV.</li>
                <li>Community group explores greening options and trade‑offs.</li>
                <li>Researcher studies the trade‑off between carbon and heat mitigation.</li>
              </ul>
            </div>
          </details>
        </form>
        <div class="button-row">
          <button type="button" id="ecology-settings-apply" class="save-btn">Apply</button>
          <button type="button" id="ecology-settings-cancel" class="cancel-btn">Cancel</button>
        </div>
      </div>
    </div>

  <script>
  // -------------------------------------------------------------------------
  // Energy settings management for Nexus
  //
  // Stores, loads and applies the energy parameters defined above.  When the
  // modal is opened the current settings are loaded into the form.  When the
  // user clicks Apply the settings are validated, persisted to localStorage
  // and broadcast to the energy and ecology iframes via postMessage.  This
  // keeps the twins in sync with the centralised assumptions.
  (function(){
    let energySettings = {
      prices: { elecImport: 0.30, gas: 1.45, feedIn: 0.05, p2p: 0.15 },
      costs: { pvPerWp: 1.13, insulationSqM: 50, hybridPump: 6000, allElectric: 14000 },
      co2: { elec: 0.268, gas: 2.134 },
      discountRate: 0.04,
      horizonYears: 20,
      budgetCap: null
    };
    try {
      const stored = localStorage.getItem('GLOBAL_ENERGY_SETTINGS');
      if (stored) {
        const parsed = JSON.parse(stored);
        if (parsed && typeof parsed === 'object') {
          energySettings = Object.assign({}, energySettings, parsed);
        }
      }
    } catch(e) {}
    function openEnergyModal() {
      const s = energySettings;
      document.getElementById('g_price_elecImport').value = s.prices.elecImport ?? '';
      document.getElementById('g_price_gas').value       = s.prices.gas ?? '';
      document.getElementById('g_price_feedIn').value    = s.prices.feedIn ?? '';
      document.getElementById('g_price_p2p').value       = s.prices.p2p ?? '';
      document.getElementById('g_cost_pvPerWp').value    = s.costs.pvPerWp ?? '';
      document.getElementById('g_cost_insulation').value = s.costs.insulationSqM ?? '';
      document.getElementById('g_cost_hybridHp').value    = s.costs.hybridPump ?? '';
      document.getElementById('g_cost_allHp').value       = s.costs.allElectric ?? '';
      document.getElementById('g_co2_elec').value        = s.co2.elec ?? '';
      document.getElementById('g_co2_gas').value         = s.co2.gas ?? '';
      document.getElementById('g_cba_discount').value    = ((s.discountRate || 0) * 100).toFixed(2);
      document.getElementById('g_cba_horizon').value     = s.horizonYears ?? '';
      document.getElementById('g_budget_cap').value      = s.budgetCap ?? '';
      document.getElementById('energy-settings-overlay').classList.add('active');
    }
    function closeEnergyModal() {
      document.getElementById('energy-settings-overlay').classList.remove('active');
    }
    function applyEnergySettings() {
      const pEI = parseFloat(document.getElementById('g_price_elecImport').value);
      const pG  = parseFloat(document.getElementById('g_price_gas').value);
      const pF  = parseFloat(document.getElementById('g_price_feedIn').value);
      const pP  = parseFloat(document.getElementById('g_price_p2p').value);
      const cPV = parseFloat(document.getElementById('g_cost_pvPerWp').value);
      const cI  = parseFloat(document.getElementById('g_cost_insulation').value);
      const cH  = parseFloat(document.getElementById('g_cost_hybridHp').value);
      const cA  = parseFloat(document.getElementById('g_cost_allHp').value);
      const coE = parseFloat(document.getElementById('g_co2_elec').value);
      const coG = parseFloat(document.getElementById('g_co2_gas').value);
      const rIn = parseFloat(document.getElementById('g_cba_discount').value);
      const tIn = parseFloat(document.getElementById('g_cba_horizon').value);
      const bIn = parseFloat(document.getElementById('g_budget_cap').value);
      if (Number.isFinite(pEI)) energySettings.prices.elecImport = pEI;
      if (Number.isFinite(pG))  energySettings.prices.gas = pG;
      if (Number.isFinite(pF))  energySettings.prices.feedIn = pF;
      if (Number.isFinite(pP))  energySettings.prices.p2p = pP;
      if (Number.isFinite(cPV)) energySettings.costs.pvPerWp = cPV;
      if (Number.isFinite(cI))  energySettings.costs.insulationSqM = cI;
      if (Number.isFinite(cH))  energySettings.costs.hybridPump = cH;
      if (Number.isFinite(cA))  energySettings.costs.allElectric = cA;
      if (Number.isFinite(coE)) energySettings.co2.elec = coE;
      if (Number.isFinite(coG)) energySettings.co2.gas = coG;
      if (Number.isFinite(rIn)) energySettings.discountRate = rIn / 100;
      if (Number.isFinite(tIn)) energySettings.horizonYears = tIn;
      energySettings.budgetCap = Number.isFinite(bIn) ? bIn : null;
      try { localStorage.setItem('GLOBAL_ENERGY_SETTINGS', JSON.stringify(energySettings)); } catch(e) {}
      const energyFrame = document.getElementById('energyFrame');
      const ecoFrame    = document.getElementById('ecoFrame');
      if (energyFrame && energyFrame.contentWindow) {
        energyFrame.contentWindow.postMessage({ type:'SETTINGS_UPDATE', payload: energySettings }, '*');
      }
      if (ecoFrame && ecoFrame.contentWindow) {
        ecoFrame.contentWindow.postMessage({ type:'SETTINGS_UPDATE', payload: energySettings }, '*');
      }
      closeEnergyModal();
    }
    document.addEventListener('DOMContentLoaded', () => {
      const openBtn  = document.getElementById('open-energy-settings-btn');
      const applyBtn = document.getElementById('energy-settings-apply');
      const cancelBtn= document.getElementById('energy-settings-cancel');
      if (openBtn)  openBtn.addEventListener('click', openEnergyModal);
      if (applyBtn) applyBtn.addEventListener('click', applyEnergySettings);
      if (cancelBtn) cancelBtn.addEventListener('click', closeEnergyModal);
    });
    // Expose energy settings helpers globally so they can be triggered from the settings dropdown.
    window.openEnergyModal = openEnergyModal;
    window.closeEnergyModal = closeEnergyModal;
    window.applyEnergySettings = applyEnergySettings;
  })();
  </script>
  <!-- Ecology settings management for Nexus -->
  <script>
    (function(){
      // Default parameters for ecology cost-benefit analysis and MCDA.  Values are modest to encourage exploring settings.
      let ecologySettings = {
        weights: { ndvi: 0.5, uhi: 0.3, water: 0.2 },
        costs: { tree: 350, greenRoof: 100, infiltration: 80 },
        discountRate: 0.04,
        horizonYears: 20,
        limits: { maxTreeArea: 2000, maxGreenRoofPct: 50 }
      };
      try {
        const stored = localStorage.getItem('GLOBAL_ECO_SETTINGS');
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed && typeof parsed === 'object') {
            ecologySettings = Object.assign({}, ecologySettings, parsed);
          }
        }
      } catch(e) {}
      function openEcologyModal() {
        const s = ecologySettings;
        document.getElementById('eco_weight_ndvi').value    = s.weights.ndvi ?? '';
        document.getElementById('eco_weight_uhi').value     = s.weights.uhi ?? '';
        document.getElementById('eco_weight_water').value   = s.weights.water ?? '';
        document.getElementById('eco_cost_tree').value      = s.costs.tree ?? '';
        document.getElementById('eco_cost_greenRoof').value = s.costs.greenRoof ?? '';
        document.getElementById('eco_cost_infiltration').value = s.costs.infiltration ?? '';
        document.getElementById('eco_cba_discount').value   = ((s.discountRate || 0) * 100).toFixed(2);
        document.getElementById('eco_cba_horizon').value    = s.horizonYears ?? '';
        document.getElementById('eco_max_tree_area').value  = s.limits.maxTreeArea ?? '';
        document.getElementById('eco_max_greenRoof_pct').value = s.limits.maxGreenRoofPct ?? '';
        document.getElementById('ecology-settings-overlay').classList.add('active');
      }
      function closeEcologyModal() {
        document.getElementById('ecology-settings-overlay').classList.remove('active');
      }
      function applyEcologySettings() {
        const wNd = parseFloat(document.getElementById('eco_weight_ndvi').value);
        const wUhi= parseFloat(document.getElementById('eco_weight_uhi').value);
        const wWat= parseFloat(document.getElementById('eco_weight_water').value);
        const cTree = parseFloat(document.getElementById('eco_cost_tree').value);
        const cRoof = parseFloat(document.getElementById('eco_cost_greenRoof').value);
        const cInf  = parseFloat(document.getElementById('eco_cost_infiltration').value);
        const rIn   = parseFloat(document.getElementById('eco_cba_discount').value);
        const tIn   = parseFloat(document.getElementById('eco_cba_horizon').value);
        const area  = parseFloat(document.getElementById('eco_max_tree_area').value);
        const pct   = parseFloat(document.getElementById('eco_max_greenRoof_pct').value);
        if (Number.isFinite(wNd)) ecologySettings.weights.ndvi = wNd;
        if (Number.isFinite(wUhi)) ecologySettings.weights.uhi = wUhi;
        if (Number.isFinite(wWat)) ecologySettings.weights.water = wWat;
        if (Number.isFinite(cTree)) ecologySettings.costs.tree = cTree;
        if (Number.isFinite(cRoof)) ecologySettings.costs.greenRoof = cRoof;
        if (Number.isFinite(cInf))  ecologySettings.costs.infiltration = cInf;
        if (Number.isFinite(rIn)) ecologySettings.discountRate = rIn / 100;
        if (Number.isFinite(tIn)) ecologySettings.horizonYears = tIn;
        if (Number.isFinite(area)) ecologySettings.limits.maxTreeArea = area;
        if (Number.isFinite(pct)) ecologySettings.limits.maxGreenRoofPct = pct;
        try { localStorage.setItem('GLOBAL_ECO_SETTINGS', JSON.stringify(ecologySettings)); } catch(e) {}
        const ecoFrame = document.getElementById('ecoFrame');
        if (ecoFrame && ecoFrame.contentWindow) {
          ecoFrame.contentWindow.postMessage({ type:'ECO_SETTINGS_UPDATE', payload: ecologySettings }, '*');
        }
        closeEcologyModal();
      }
      document.addEventListener('DOMContentLoaded', () => {
        const applyBtn  = document.getElementById('ecology-settings-apply');
        const cancelBtn = document.getElementById('ecology-settings-cancel');
        if (applyBtn)  applyBtn.addEventListener('click', applyEcologySettings);
        if (cancelBtn) cancelBtn.addEventListener('click', closeEcologyModal);
      });
      // Expose ecology helpers globally so the dropdown can open the modal
      window.openEcologyModal = openEcologyModal;
      window.closeEcologyModal = closeEcologyModal;
      window.applyEcologySettings = applyEcologySettings;
    })();
  </script>
  <!-- Translation helper script: dictionaries and runtime language switcher -->
  <script>
    // Define translation dictionaries. Keys correspond to UI elements marked with data-i18n attributes.
    const translations = {
      en: {
        'nav-overview': 'Overview',
        'nav-ecology': 'Ecology',
        'nav-energy': 'Energy',
        'nav-simulation': 'Combined Scenario Analysis',
        'hero-title': 'Design a Cooler, Greener and Energy Efficient Neighbourhood',
        'hero-subtitle': 'A neighbourhood-scale digital twin to test interventions before spending millions',
        'badge-heat-risk': 'Heat risk',
        'badge-energy-poverty': 'Energy poverty',
        'badge-retrofit-complexity': 'Retrofit complexity',
        'step-find-hotspots': 'Find hotspots',
        'step-pick-strategy': 'Pick a strategy',
        'step-simulate': 'Simulate',
        'resume-btn': 'Resume scenario',
        'metric-uhi': 'UHI peak (°C)',
        'metric-ndvi': 'NDVI',
        'metric-demand': 'Annual demand (MWh)',
        'metric-pv': 'PV potential (MWh)',
        'metric-co2': 'CO₂ (kt/yr)',
        'metric-vulnerable': 'Vulnerable HH (%)',
        'why-heading': 'Why Twekkelerveld?',
        'why-bullet-1': 'Mixed building stock → retrofit tradeoffs are real.',
        'why-bullet-2': 'Heat + energy affordability collide here.',
        'why-bullet-3': 'Perfect scale: neighbourhood interventions actually measurable.',
        'cases-call-btn': 'Explore other case studies',
        'cases-call-note': 'Learn from international examples on cooling, energy, retrofits and community solar.',
        'timeline-now-desc': 'Hotter summers, rising bills.',
        'timeline-now': 'Now',
        'timeline-2027-desc': 'Grid pressure + retrofit targets.',
        'timeline-2030-desc': 'Policy deadlines (EU targets).',
        'timeline-2050-desc': 'Climate baseline shift.',
        'preset-cool': 'Urban heat reduction',
        'preset-bills': 'Reduce energy bills',
        'preset-stress': '2050 heat stress test',
        'howto-step-ecology': 'Explore Ecology map',
        'howto-step-energy': 'Explore Energy map',
        'howto-step-sim': 'Combine in Simulation and export PDF',
        'location-details': 'Location details',
        'simulate-btn': 'Simulate this hotspot',
        'open-tab-btn': 'Open tab',
        'open-ecology-tab': 'Open Ecology tab',
        'open-energy-tab': 'Open Energy tab',
        'replicate-title': 'Current Digital Twin Situation',
        'replicate-baseline': 'Baseline UHI intensity: approx {baseline}°C.',
        'replicate-canopy': 'Adding {pct}% more tree canopy could lower air temperatures by roughly {red}°C.',
        'replicate-green': 'Installing green roofs on about {pct}% of rooftops may cool the area by another ~{red}°C.',
        'replicate-total': 'Together, these measures might reduce local temperatures by around {total}°C and lessen heat stress. Visit the Combined Scenario Analysis tab to test the scenario.',
        'replicate-btn': 'Replicate this strategy'
      },
      nl: {
        'nav-overview': 'Overzicht',
        'nav-ecology': 'Ecologie',
        'nav-energy': 'Energie',
        'nav-simulation': 'Gecombineerde scenarioanalyse',
        'hero-title': 'Ontwerp een koelere, groenere en energiezuinige buurt',
        'hero-subtitle': 'Een digitale tweeling op buurtniveau om interventies te testen voordat er miljoenen worden uitgegeven',
        'badge-heat-risk': 'Hitterisico',
        'badge-energy-poverty': 'Energiearmoede',
        'badge-retrofit-complexity': 'Renovatiecomplexiteit',
        'step-find-hotspots': 'Vind hotspots',
        'step-pick-strategy': 'Kies een strategie',
        'step-simulate': 'Simuleer',
        'resume-btn': 'Scenario hervatten',
        'metric-uhi': 'UHI piek (°C)',
        'metric-ndvi': 'NDVI',
        'metric-demand': 'Jaarlijkse vraag (MWh)',
        'metric-pv': 'PV-potentieel (MWh)',
        'metric-co2': 'CO₂ (kt/jaar)',
        'metric-vulnerable': 'Kwetsbare hh (%)',
        'why-heading': 'Waarom Twekkelerveld?',
        'why-bullet-1': 'Gemengde gebouwenvoorraad → renovatieafwegingen zijn reëel.',
        'why-bullet-2': 'Hitte en energie betaalbaarheid botsen hier.',
        'why-bullet-3': 'Perfecte schaal: wijkinterventies daadwerkelijk meetbaar.',
        'cases-call-btn': 'Verken andere casestudies',
        'cases-call-note': 'Leer van internationale voorbeelden op het gebied van koeling, energie, renovaties en zonne-energie van de gemeenschap.',
        'timeline-now-desc': 'Heettere zomers, stijgende rekeningen.',
        'timeline-now': 'Nu',
        'timeline-2027-desc': 'Netdruk & renovatiedoelen.',
        'timeline-2030-desc': 'Beleidsdeadlines (EU-doelen).',
        'timeline-2050-desc': 'Verandering van het klimaatbasisniveau.',
        'preset-cool': 'Warmtereductie',
        'preset-bills': 'Verminder energierekeningen',
        'preset-stress': 'Hittestresstest 2050',
        'howto-step-ecology': 'Verken de ecologiekaart',
        'howto-step-energy': 'Verken de energiekaart',
        'howto-step-sim': 'Combineer in simulatie en exporteer PDF',
        'location-details': 'Locatie details',
        'simulate-btn': 'Simuleer deze hotspot',
        'open-tab-btn': 'Tab openen',
        'open-ecology-tab': 'Open ecologietab',
        'open-energy-tab': 'Open energietab',
        'replicate-title': 'Huidige digitale twin-situatie',
        'replicate-baseline': 'Basis UHI-intensiteit: ongeveer {baseline}°C.',
        'replicate-canopy': 'Het toevoegen van {pct}% meer boomkruin kan de luchttemperatuur met circa {red}°C verlagen.',
        'replicate-green': 'Het installeren van groene daken op ongeveer {pct}% van de daken kan het gebied met nog eens ~{red}°C koelen.',
        'replicate-total': 'Samen kunnen deze maatregelen de lokale temperatuur met rond {total}°C verlagen en hittestress verminderen. Bezoek het tabblad Gecombineerde scenarioanalyse om het scenario te testen.',
        'replicate-btn': 'Repliceer deze strategie'
      },
      de: {
        'nav-overview': 'Überblick',
        'nav-ecology': 'Ökologie',
        'nav-energy': 'Energie',
        'nav-simulation': 'Kombinierte Szenarioanalyse',
        'hero-title': 'Gestalte ein kühleres, grüneres und energieeffizientes Viertel',
        'hero-subtitle': 'Ein digitaler Zwilling auf Nachbarschaftsebene, um Maßnahmen zu testen, bevor Millionen ausgegeben werden',
        'badge-heat-risk': 'Hitzegefahr',
        'badge-energy-poverty': 'Energiearmut',
        'badge-retrofit-complexity': 'Sanierungskomplexität',
        'step-find-hotspots': 'Hotspots finden',
        'step-pick-strategy': 'Strategie wählen',
        'step-simulate': 'Simulieren',
        'resume-btn': 'Szenario fortsetzen',
        'metric-uhi': 'UHI-Spitze (°C)',
        'metric-ndvi': 'NDVI',
        'metric-demand': 'Jährlicher Bedarf (MWh)',
        'metric-pv': 'PV-Potenzial (MWh)',
        'metric-co2': 'CO₂ (kt/Jahr)',
        'metric-vulnerable': 'Verletzliche HH (%)',
        'why-heading': 'Warum Twekkelerveld?',
        'why-bullet-1': 'Gemischter Gebäudebestand → Sanierungsabwicklungen sind real.',
        'why-bullet-2': 'Hitze und Energiebezahlbarkeit kollidieren hier.',
        'why-bullet-3': 'Perfekte Größe: Maßnahmen im Viertel sind tatsächlich messbar.',
        'cases-call-btn': 'Andere Fallstudien erkunden',
        'cases-call-note': 'Lernen Sie von internationalen Beispielen zu Kühlung, Energie, Sanierungen und gemeinschaftlicher Solarenergie.',
        'timeline-now-desc': 'Heißere Sommer, steigende Rechnungen.',
        'timeline-now': 'Jetzt',
        'timeline-2027-desc': 'Netzdruck & Sanierungsziele.',
        'timeline-2030-desc': 'Politische Fristen (EU-Ziele).',
        'timeline-2050-desc': 'Verschiebung der Klimabasislinie.',
        'preset-cool': 'Hitzereduktion',
        'preset-bills': 'Energiekosten senken',
        'preset-stress': 'Hitzestresstest 2050',
        'howto-step-ecology': 'Ökologiekarte erkunden',
        'howto-step-energy': 'Energiekarte erkunden',
        'howto-step-sim': 'In Simulation kombinieren und PDF exportieren',
        'location-details': 'Standortdetails',
        'simulate-btn': 'Diesen Hotspot simulieren',
        'open-tab-btn': 'Tab öffnen',
        'open-ecology-tab': 'Ökologie-Tab öffnen',
        'open-energy-tab': 'Energie-Tab öffnen',
        'replicate-title': 'Aktuelle Digitale-Zwilling-Situation',
        'replicate-baseline': 'UHI-Basisintensität: ungefähr {baseline}°C.',
        'replicate-canopy': 'Die Erhöhung der Baumkronenfläche um {pct}% könnte die Lufttemperatur um etwa {red}°C senken.',
        'replicate-green': 'Begrünte Dächer auf etwa {pct}% der Dächer könnten das Gebiet um weitere ~{red}°C abkühlen.',
        'replicate-total': 'Zusammen könnten diese Maßnahmen die lokale Temperatur um rund {total}°C senken und Hitzestress verringern. Besuchen Sie die Registerkarte Kombinierte Szenarioanalyse, um das Szenario zu testen.',
        'replicate-btn': 'Diese Strategie replizieren'
      }
    };
    // Current language is persisted in local storage; default to English.
    let currentLang = localStorage.getItem('lang') || 'en';
    // Translation helper. Returns the translation for a given key and current language.
    function t(key, vars = {}) {
      const dict = translations[currentLang] || translations['en'];
      let str = dict[key] || translations['en'][key] || '';
      // Replace placeholders with variables if provided
      Object.keys(vars).forEach(k => {
        str = str.replace(new RegExp('\\{' + k + '\\}', 'g'), vars[k]);
      });
      return str;
    }
    function updateReplicateMessage() {
      const repMsgEl = document.getElementById('digital-twin-replicate-message');
      if (!repMsgEl) return;
      let baseline = null;
      if (window.IR_BASE_GLOBAL && typeof window.IR_BASE_GLOBAL.uhi_mean === 'number') {
        baseline = window.IR_BASE_GLOBAL.uhi_mean;
      }
      const canopyPct = 5;
      const canopyReduction = canopyPct * 0.2;
      const greenPct = 10;
      const greenReduction = 1.34;
      const totalReduction = canopyReduction + greenReduction;
      let parts = [];
      if (baseline !== null) parts.push(t('replicate-baseline', { baseline: baseline.toFixed(1) }));
      parts.push(t('replicate-canopy', { pct: canopyPct, red: canopyReduction.toFixed(1) }));
      parts.push(t('replicate-green', { pct: greenPct, red: greenReduction.toFixed(2) }));
      parts.push(t('replicate-total', { total: totalReduction.toFixed(1) }));
      repMsgEl.textContent = parts.join(' ');
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lang', lang);
      document.documentElement.setAttribute('lang', lang);
      // Update static text elements with data-i18n
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = t(key);
        if (!text) return;
        // Determine whether to set HTML or textContent
        if (el.hasAttribute('data-i18n-html')) {
          el.innerHTML = text;
        } else {
          el.textContent = text;
        }
      });
      // Update dynamic buttons for hotspots (open tab labels)
      document.querySelectorAll('.open-tab-btn').forEach(btn => {
        const tab = btn.dataset.tab;
        if (!tab) return;
        if (tab === 'panel-ecology') btn.textContent = t('open-ecology-tab');
        else if (tab === 'panel-energy') btn.textContent = t('open-energy-tab');
        else btn.textContent = t('open-tab-btn');
      });
      // Update simulate buttons
      document.querySelectorAll('.simulate-btn').forEach(btn => {
        btn.textContent = t('simulate-btn');
      });
      // Update replicate buttons
      document.querySelectorAll('.replicate-btn').forEach(btn => {
        btn.textContent = t('replicate-btn');
      });
      // Update replicate message to reflect the current language
      updateReplicateMessage();
      // Update preset success messages if needed (they remain in English)
    }
    document.addEventListener('DOMContentLoaded', function() {
      // Initialise language selector value
      const select = document.getElementById('lang-select');
      if (select) {
        select.value = currentLang;
        select.addEventListener('change', function(e) {
          setLanguage(e.target.value);
        });
      }
      // After DOM is ready, apply current language
      setLanguage(currentLang);
      // Populate digital twin replicate message once DOM is ready
      updateReplicateMessage();

      // Set up hotspot panel interactions. Display a small panel beside the map when clicking a hotspot.
      const panel = document.getElementById('hotspot-panel');
      const panelTitle = document.getElementById('hotspot-panel-title');
      const panelImg = document.getElementById('hotspot-panel-image');
      const panelDesc = document.getElementById('hotspot-panel-desc');
      const panelPreview = document.getElementById('hotspot-panel-preview');
      const panelSimBtn = document.getElementById('hotspot-panel-simulate-btn');
      const panelOpenBtn = document.getElementById('hotspot-panel-open-btn');
      const panelClose = panel ? panel.querySelector('.panel-close') : null;
      if (panel && panelTitle && panelDesc && panelImg && panelSimBtn && panelOpenBtn) {
        // Attach click listeners to hotspots
        document.querySelectorAll('.hotspot').forEach(h => {
          h.addEventListener('click', function() {
            const key = this.getAttribute('data-spot');
            const data = window.hotspotData && window.hotspotData[key];
            if (!data) return;
            panelTitle.textContent = data.title;
            panelDesc.textContent = data.desc;
            panelImg.src = data.img;
            // Compute preview if preset defined. Protect against undefined computeScenario.
            if (data.preset) {
              let previewSet = false;
              try {
                if (typeof computeScenario === 'function' && window.IR_BASE_GLOBAL) {
                  const sVal = computeScenario(data.preset);
                  if (sVal) {
                    const uhi = window.IR_BASE_GLOBAL.uhi_mean - sVal.uhiScenario;
                    const co2pct = (1 - sVal.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
                    panelPreview.innerHTML = `If we add ${data.preset.trees} trees & ${data.preset.green}% green roofs → UHI ${uhi >= 0 ? '–' : '+'}${Math.abs(uhi).toFixed(1)}°C, CO₂ ${co2pct >= 0 ? '–' : '+'}${Math.abs(Math.round(co2pct))}%`;
                    previewSet = true;
                  }
                }
              } catch(err) {
                /* silently ignore preview errors */
              }
              if (!previewSet) {
                panelPreview.textContent = '';
              }
              panelSimBtn.dataset.preset = JSON.stringify(data.preset);
            } else {
              panelPreview.textContent = '';
              panelSimBtn.dataset.preset = '';
            }
            // Set dataset for open tab and update text
            panelOpenBtn.dataset.tab = data.tab;
            if (data.tab === 'panel-ecology') panelOpenBtn.textContent = t('open-ecology-tab');
            else if (data.tab === 'panel-energy') panelOpenBtn.textContent = t('open-energy-tab');
            else panelOpenBtn.textContent = t('open-tab-btn');
            // Update simulate button text with translation
            panelSimBtn.textContent = t('simulate-btn');
            // Show panel
            panel.style.display = 'flex';
          });
        });
        // Simulate button: load preset and hide panel
        panelSimBtn.addEventListener('click', function() {
          const presetStr = this.dataset.preset;
          if (presetStr) {
            try {
              const cfg = JSON.parse(presetStr);
              if (cfg) loadPreset(cfg);
            } catch(e) {}
          }
          panel.style.display = 'none';
        });
        // Open tab button: switch to appropriate tab and hide panel
        panelOpenBtn.addEventListener('click', function() {
          const tTab = this.dataset.tab;
          if (tTab) {
            switchTab(tTab);
          }
          panel.style.display = 'none';
        });
        // Close panel when clicking the cross
        if (panelClose) {
          panelClose.addEventListener('click', function() {
            panel.style.display = 'none';
          });
        }
      }
      // Provide explanatory pop‑ups for micro badges and make other elements interactive
      const badgeInfoMap = {
        'badge-heat-risk': 'Heat risk refers to the danger posed by high urban temperatures in the neighbourhood, affecting health and comfort.',
        'badge-energy-poverty': 'Energy poverty describes households struggling to afford sufficient energy to meet their basic needs.',
        'badge-retrofit-complexity': 'Retrofit complexity reflects the challenges of upgrading existing buildings due to age, design or heritage factors.'
      };
      const badgeInfoEl = document.getElementById('badge-info');
      const badgeInfoTextEl = document.getElementById('badge-info-text');
      const badgeInfoCloseEl = document.getElementById('badge-info-close');
      // Close button hides the info box
      if (badgeInfoCloseEl && badgeInfoEl) {
        badgeInfoCloseEl.addEventListener('click', function() {
          badgeInfoEl.style.display = 'none';
        });
      }
      // Attach click handlers to badges to populate description and show info box
      document.querySelectorAll('.micro-badge').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function() {
          const span = this.querySelector('span');
          if (!span || !badgeInfoEl) return;
          const key = span.getAttribute('data-i18n');
          const desc = badgeInfoMap[key] || '';
          if (badgeInfoTextEl) badgeInfoTextEl.textContent = desc;
          // Display flex to align text and close icon
          badgeInfoEl.style.display = 'flex';
        });
      });
      // Make timeline items clickable. Policy links open a modal; internal anchors scroll; external links open in new tab.
      document.querySelectorAll('.timeline-item[data-link]').forEach(item => {
        const link = item.getAttribute('data-link');
        if (link) {
          item.style.cursor = 'pointer';
          item.addEventListener('click', () => {
            // Policy anchors (#policy-*) open in modal
            if (link.startsWith('#policy-')) {
              const target = document.querySelector(link);
              const modal = document.getElementById('timeline-modal');
              const content = document.getElementById('timeline-modal-content');
              if (target && modal && content) {
                content.innerHTML = target.innerHTML;
                modal.classList.add('active');
              }
              return;
            }
            // Other internal anchors start with '#': smooth scroll
            if (link.startsWith('#')) {
              const targetEl = document.querySelector(link);
              if (targetEl && targetEl.scrollIntoView) {
                targetEl.scrollIntoView({ behavior: 'smooth' });
                return;
              }
            }
            // External links open in a new tab
            if (link.startsWith('http')) {
              window.open(link, '_blank');
            }
          });
        }
      });
      // Hotspot list buttons: if a hidden hotspot exists we simulate its click; otherwise we populate the panel directly
      document.querySelectorAll('.hotspot-link').forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-spot');
          const hidden = document.querySelector('.hotspot[data-spot="' + key + '"]');
          if (hidden) {
            hidden.click();
            return;
          }
          // Fallback: directly open the hotspot panel using global hotspot data
          const data = window.hotspotData && window.hotspotData[key];
          if (!data) return;
          const panel = document.getElementById('hotspot-panel');
          const panelTitle = document.getElementById('hotspot-panel-title');
          const panelImg = document.getElementById('hotspot-panel-image');
          const panelDesc = document.getElementById('hotspot-panel-desc');
          const panelPreview = document.getElementById('hotspot-panel-preview');
          const panelSimBtn = document.getElementById('hotspot-panel-simulate-btn');
          const panelOpenBtn = document.getElementById('hotspot-panel-open-btn');
          if (panel && panelTitle && panelDesc && panelImg && panelSimBtn && panelOpenBtn) {
            panelTitle.textContent = data.title;
            panelDesc.textContent = data.desc;
            panelImg.src = data.img;
            // Compute preview if preset defined
            if (data.preset) {
              let previewSet = false;
              try {
                if (typeof computeScenario === 'function' && window.IR_BASE_GLOBAL) {
                  const sVal = computeScenario(data.preset);
                  if (sVal) {
                    const uhi = window.IR_BASE_GLOBAL.uhi_mean - sVal.uhiScenario;
                    const co2pct = (1 - sVal.co2Scenario_kg / window.IR_BASE_GLOBAL.co2_kg) * 100;
                    panelPreview.innerHTML = `If we add ${data.preset.trees} trees & ${data.preset.green}% green roofs → UHI ${uhi >= 0 ? '–' : '+'}${Math.abs(uhi).toFixed(1)}°C, CO₂ ${co2pct >= 0 ? '–' : '+'}${Math.abs(Math.round(co2pct))}%`;
                    previewSet = true;
                  }
                }
              } catch(err) {
                /* ignore errors */
              }
              if (!previewSet) {
                panelPreview.textContent = '';
              }
              panelSimBtn.dataset.preset = JSON.stringify(data.preset);
            } else {
              panelPreview.textContent = '';
              panelSimBtn.dataset.preset = '';
            }
            // Set dataset for open tab and update text
            panelOpenBtn.dataset.tab = data.tab;
            if (data.tab === 'panel-ecology') panelOpenBtn.textContent = t('open-ecology-tab');
            else if (data.tab === 'panel-energy') panelOpenBtn.textContent = t('open-energy-tab');
            else panelOpenBtn.textContent = t('open-tab-btn');
            // Update simulate button text with translation
            panelSimBtn.textContent = t('simulate-btn');
            // Show panel
            panel.style.display = 'flex';
          }
        });
      });
      // Digital twin info button toggles the expanded content.
      const dtBtn = document.getElementById('digital-twin-info-btn');
      const dtInfo = document.getElementById('digital-twin-info');
      if (dtBtn && dtInfo) {
        dtBtn.addEventListener('click', function() {
          if (dtInfo.style.display === 'none' || dtInfo.style.display === '') {
            // Ensure replicate message is up to date before showing
            if (typeof updateReplicateMessage === 'function') updateReplicateMessage();
            dtInfo.style.display = 'block';
          } else {
            dtInfo.style.display = 'none';
          }
        });
      }
      // Buttons inside the digital twin actions navigate to the appropriate tab
      document.querySelectorAll('.digital-twin-actions .pill-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tab = this.getAttribute('data-tab');
          if (tab && typeof window.switchTab === 'function') {
            window.switchTab(tab);
          }
        });
      });
      // Make how‑to steps clickable: switch to the specified tab when clicked.
      document.querySelectorAll('.howto-step[data-tab]').forEach(step => {
        const tab = step.getAttribute('data-tab');
        if (tab) {
          step.style.cursor = 'pointer';
          step.addEventListener('click', function() {
            switchTab(tab, null);
          });
        }
      });
    });
    // Expose translator globally so other scripts can access if needed
    window.t = t;
    window.setLanguage = setLanguage;
  </script>

  <!-- Global Assumptions & Settings modal -->
  <div id="settings-overlay" class="settings-modal-overlay">
    <div class="settings-modal">
      <h2>Assumptions &amp; Settings</h2>
      <form id="settings-form">
        <div class="field">
          <label for="role-field">Role / Stakeholder</label>
          <select name="role" id="role-field">
            <option value="planner">Municipal planner</option>
            <option value="housing">Housing corporation</option>
            <option value="community">Community group</option>
            <option value="researcher">Researcher</option>
          </select>
        </div>
        <h3>Financial &amp; Scenario Parameters</h3>
        <div class="field"><label>Discount rate (%)</label><input type="number" step="0.01" name="discount_rate" min="0" /></div>
        <div class="field"><label>Time horizon (years)</label><input type="number" name="time_horizon" min="1" /></div>
        <div class="field"><label>Energy price (€/kWh)</label><input type="number" step="0.01" name="energy_price" min="0" /></div>
        <div class="field"><label>CO₂ price (€/tCO₂)</label><input type="number" step="1" name="co2_price" min="0" /></div>
        <h3>Unit Costs</h3>
        <div class="field"><label>Tree cost (€/tree)</label><input type="number" name="cost_tree_eur" min="0" /></div>
        <div class="field"><label>PV cost (€/percentage)</label><input type="number" name="cost_pv_per_pct_eur" min="0" /></div>
        <div class="field"><label>Green roof cost (€/percentage)</label><input type="number" name="cost_greenRoof_per_pct_eur" min="0" /></div>
        <div class="field"><label>Retrofit cost (€/dwelling)</label><input type="number" name="retrofit_cost_per_dwelling_eur" min="0" /></div>
        <h3>Limits</h3>
        <div class="field"><label>Max roofs covered (%)</label><input type="number" name="max_roof_pct" min="0" max="100" /></div>
        <div class="field"><label>Max tree area (m²)</label><input type="number" name="max_tree_area" min="0" /></div>
        <h3>MCDA Weights</h3>
        <div class="field"><label>Green weight</label><input type="number" name="w_green" min="0" max="1" step="0.01" /></div>
        <div class="field"><label>Cool weight</label><input type="number" name="w_cool" min="0" max="1" step="0.01" /></div>
        <div class="field"><label>Energy weight</label><input type="number" name="w_energy" min="0" max="1" step="0.01" /></div>
        <div class="field"><label>CO₂ weight</label><input type="number" name="w_co2" min="0" max="1" step="0.01" /></div>
        <div class="field"><label>Equity weight</label><input type="number" name="w_equity" min="0" max="1" step="0.01" /></div>
      </form>
      <div class="section">
        <h3 class="collapsible-header">Transparency: Equations</h3>
        <div class="collapsible-content">
          <p>Scenario metrics are computed using simplified relationships based on published literature. For example, UHI reduction per tree is approximated as 0.1&nbsp;°C per 300 trees and green roof cooling as 1&nbsp;°C per 100% roof coverage. These parameters can be updated in the code.</p>
        </div>
      </div>
      <div class="section">
        <h3 class="collapsible-header">Transparency: Data sources &amp; ranges</h3>
        <div class="collapsible-content">
          <p>Default cost values originate from studies of urban greening and energy retrofits. Allowed input ranges ensure realism (e.g., green roof coverage up to 100%, discount rate between 0–10%).</p>
        </div>
      </div>
      <div class="button-row">
        <button type="button" id="settings-reset-btn" class="cancel-btn">Reset to defaults</button>
        <button type="button" data-role-preset="planner" class="cancel-btn">Municipal planner preset</button>
        <button type="button" data-role-preset="housing" class="cancel-btn">Housing corp preset</button>
        <button type="button" data-role-preset="community" class="cancel-btn">Community group preset</button>
        <button type="button" data-role-preset="researcher" class="cancel-btn">Researcher preset</button>
        <button type="button" id="settings-export-btn" class="export-btn">Export JSON</button>
        <button type="button" id="settings-save-btn" class="save-btn">Save</button>
        <button type="button" id="settings-close-btn" class="cancel-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Settings management script -->
  <script>
  (function() {
    const defaultSettings = {
      role: 'planner',
      discount_rate: 0.04,
      time_horizon: 20,
      energy_price: 0.25,
      co2_price: 50,
      cost_tree_eur: (window.IR_BASE_GLOBAL && typeof window.IR_BASE_GLOBAL.cost_tree_eur === 'number') ? window.IR_BASE_GLOBAL.cost_tree_eur : 350,
      cost_pv_per_pct_eur: (window.IR_BASE_GLOBAL && typeof window.IR_BASE_GLOBAL.cost_pv_per_pct_eur === 'number') ? window.IR_BASE_GLOBAL.cost_pv_per_pct_eur : 5400,
      retrofit_cost_per_dwelling_eur: (window.IR_BASE_GLOBAL && typeof window.IR_BASE_GLOBAL.retrofit_cost_per_dwelling_eur === 'number') ? window.IR_BASE_GLOBAL.retrofit_cost_per_dwelling_eur : 12000,
      cost_greenRoof_per_pct_eur: (window.IR_BASE_GLOBAL && typeof window.IR_BASE_GLOBAL.cost_greenRoof_per_pct_eur === 'number') ? window.IR_BASE_GLOBAL.cost_greenRoof_per_pct_eur : 8000,
      max_roof_pct: 60,
      max_tree_area: 10000,
      w_green: 0.25,
      w_cool: 0.25,
      w_energy: 0.25,
      w_co2: 0.15,
      w_equity: 0.10
    };
    const rolePresets = {
      'planner': { w_green: 0.30, w_cool: 0.25, w_energy: 0.25, w_co2: 0.15, w_equity: 0.05 },
      'housing': { w_green: 0.15, w_cool: 0.20, w_energy: 0.35, w_co2: 0.20, w_equity: 0.10 },
      'community': { w_green: 0.35, w_cool: 0.20, w_energy: 0.15, w_co2: 0.15, w_equity: 0.15 },
      'researcher': { w_green: 0.20, w_cool: 0.20, w_energy: 0.20, w_co2: 0.20, w_equity: 0.20 }
    };
    function getSettings() {
      let s = {};
      try {
        const str = localStorage.getItem('DT_SETTINGS');
        s = str ? JSON.parse(str) : {};
      } catch(e) {}
      return Object.assign({}, defaultSettings, s);
    }
    function saveSettings(settings) {
      localStorage.setItem('DT_SETTINGS', JSON.stringify(settings));
    }
    function updateBaselineFromSettings() {
      const s = getSettings();
      if (window.IR_BASE_GLOBAL) {
        Object.keys(s).forEach(k => {
          if (window.IR_BASE_GLOBAL.hasOwnProperty(k) && typeof s[k] !== 'undefined') {
            window.IR_BASE_GLOBAL[k] = s[k];
          }
        });
      }
      if (window.IR_BASE) {
        Object.keys(s).forEach(k => {
          if (window.IR_BASE.hasOwnProperty(k) && typeof s[k] !== 'undefined') {
            window.IR_BASE[k] = s[k];
          }
        });
        if (window.IR_BASE.energy_kwh !== undefined && window.IR_BASE.pv_kwh !== undefined) {
          window.IR_BASE_netGrid_kwh = window.IR_BASE.energy_kwh - window.IR_BASE.pv_kwh;
        }
      }
    }

    // Update slider hint text based on current settings.
    // This function ensures descriptive hints for interventions reflect the
    // active cost assumptions. It should be called after settings are
    // loaded or saved.
    function updateSliderHints() {
      const s = getSettings();
      // Update tree cost hint
      try {
        const treeSlider = document.getElementById('IR_sliderTrees');
        if (treeSlider && treeSlider.parentElement) {
          const hint = treeSlider.parentElement.querySelector('.slider-hint');
          if (hint) {
            const costStr = s.cost_tree_eur.toLocaleString();
            hint.textContent = `Trees sequester ~20kg CO₂ per year and cost ~€${costStr} each.`;
          }
        }
        // Update PV cost hint
        const pvSlider = document.getElementById('IR_sliderPV');
        if (pvSlider && pvSlider.parentElement) {
          const hint = pvSlider.parentElement.querySelector('.slider-hint');
          if (hint) {
            const costStr = s.cost_pv_per_pct_eur.toLocaleString();
            hint.textContent = `Relative to current PV potential. Cost ~€${costStr} per +1%.`;
          }
        }
      } catch(e) {}
    }
    function openSettingsModal() {
      const overlay = document.getElementById('settings-overlay');
      overlay.classList.add('active');
      populateSettingsForm();
    }
    function closeSettingsModal() {
      const overlay = document.getElementById('settings-overlay');
      overlay.classList.remove('active');
    }
    function populateSettingsForm() {
      const s = getSettings();
      const form = document.getElementById('settings-form');
      if (!form) return;
      Object.keys(s).forEach(key => {
        const field = form.querySelector('[name="' + key + '"]');
        if (field) {
          field.value = s[key];
        }
      });
    }
    function collectSettingsForm() {
      const form = document.getElementById('settings-form');
      const inputs = form.querySelectorAll('[name]');
      const out = {};
      inputs.forEach(inp => {
        if (inp.type === 'number') {
          const val = parseFloat(inp.value);
          out[inp.name] = isNaN(val) ? 0 : val;
        } else {
          out[inp.name] = inp.value;
        }
      });
      return Object.assign({}, defaultSettings, out);
    }
    function onSaveSettings() {
      const newSettings = collectSettingsForm();
      saveSettings(newSettings);
      updateBaselineFromSettings();
      updateSliderHints();
      if (window.IR_updateUI) {
        try { window.IR_updateUI(); } catch(e) {}
      }
      closeSettingsModal();
      const roleSelect = document.getElementById('role-select');
      if (roleSelect) roleSelect.value = newSettings.role;
    }
    function onResetDefaults() {
      saveSettings(defaultSettings);
      updateBaselineFromSettings();
      updateSliderHints();
      populateSettingsForm();
      if (window.IR_updateUI) {
        try { window.IR_updateUI(); } catch(e) {}
      }
    }
    function onLoadPreset(role) {
      const s = getSettings();
      const preset = rolePresets[role];
      if (preset) {
        s.role = role;
        Object.assign(s, preset);
        saveSettings(s);
        updateBaselineFromSettings();
        updateSliderHints();
        populateSettingsForm();
        if (window.IR_updateUI) { try { window.IR_updateUI(); } catch(e) {} }
      }
    }
    function onExportSettings() {
      const s = getSettings();
      const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(s, null, 2));
      const dlAnchor = document.createElement('a');
      dlAnchor.setAttribute('href', dataStr);
      const dateStr = new Date().toISOString().split('T')[0];
      dlAnchor.setAttribute('download', 'dt_settings_' + dateStr + '.json');
      dlAnchor.click();
    }
    document.addEventListener('DOMContentLoaded', function() {
      updateBaselineFromSettings();
      // Ensure slider hints reflect stored settings on page load
      updateSliderHints();
      const roleSelect = document.getElementById('role-select');
      if (roleSelect) {
        roleSelect.addEventListener('change', function() {
          const s = getSettings();
          s.role = this.value;
          const preset = rolePresets[this.value] || {};
          Object.assign(s, preset);
          saveSettings(s);
          updateBaselineFromSettings();
          if (window.IR_updateUI) { try { window.IR_updateUI(); } catch(e) {} }
        });
        const s = getSettings();
        roleSelect.value = s.role;
      }
      const openBtn = document.getElementById('open-settings-btn');
      if (openBtn) openBtn.addEventListener('click', openSettingsModal);
      const closeBtn = document.getElementById('settings-close-btn');
      if (closeBtn) closeBtn.addEventListener('click', closeSettingsModal);
      const saveBtn = document.getElementById('settings-save-btn');
      if (saveBtn) saveBtn.addEventListener('click', onSaveSettings);
      const resetBtn = document.getElementById('settings-reset-btn');
      if (resetBtn) resetBtn.addEventListener('click', onResetDefaults);
      const exportBtn = document.getElementById('settings-export-btn');
      if (exportBtn) exportBtn.addEventListener('click', onExportSettings);
      document.querySelectorAll('[data-role-preset]').forEach(btn => {
        btn.addEventListener('click', function() {
          onLoadPreset(this.getAttribute('data-role-preset'));
        });
      });
      document.querySelectorAll('.collapsible-header').forEach(header => {
        header.addEventListener('click', function() {
          this.classList.toggle('active');
          const content = this.nextElementSibling;
          if (content) {
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
          }
        });
      });
    });
    window.DT_updateBaselineFromSettings = updateBaselineFromSettings;
    // Expose utility functions so they can be called from outside the module.  
    // This allows the combined settings menu to reuse the existing form population and settings logic.
    window.DT_populateSettingsForm = populateSettingsForm;
    window.DT_getSettings = getSettings;
    window.DT_collectSettingsForm = collectSettingsForm;
    window.DT_onSaveSettings = onSaveSettings;
    window.DT_onResetDefaults = onResetDefaults;
  })();
  </script>
</body>
</html>
